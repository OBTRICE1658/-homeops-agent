<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>HomeOps - Mobile</title>
  
  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  
  <!-- Mobile-First CSS -->
  <style>
    /* MOBILE-FIRST RESET */
    :root {
      --vh: 1vh;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      height: 100vh;
      /* iOS viewport units fix */
      height: 100dvh;
      overflow: hidden;
      touch-action: manipulation;
      /* Prevent zoom on input focus */
      -webkit-text-size-adjust: 100%;
    }
    
    /* MOBILE APP LAYOUT */
    .mobile-app {
      height: 100vh;
      height: calc(var(--vh, 1vh) * 100); /* Use custom property for iOS */
      display: flex;
      flex-direction: column;
      position: relative;
    }
    
    /* TOP HEADER */
    .mobile-header {
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      padding: 12px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      min-height: 60px;
    }
    
    .logo {
      font-size: 24px;
      font-weight: 700;
      color: white;
    }
    
    /* MAIN CONTENT AREA */
    .mobile-content {
      flex: 1;
      overflow: hidden;
      position: relative;
      /* Add padding for fixed navigation */
      padding-bottom: 90px;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      height: 100vh;
      /* iOS viewport units fix */
      height: 100dvh;
      overflow: hidden;
      touch-action: manipulation;
      /* Prevent zoom on input focus */
      -webkit-text-size-adjust: 100%;
      /* Default bottom padding for navigation */
      padding-bottom: 90px;
    }
    
    .mobile-view {
      display: none;
      height: 100%;
      padding: 20px;
      overflow-y: auto;
    }
    
    .mobile-view.active {
      display: block !important;
    }
    
    /* BOTTOM NAVIGATION */
    .mobile-nav {
      background: rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(20px);
      display: flex;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      padding: 8px 0;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      min-height: 70px;
      /* iOS safe area handling */
      padding-bottom: max(8px, env(safe-area-inset-bottom));
      /* Smooth transitions */
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      /* Ensure proper stacking */
      box-shadow: 0 -2px 20px rgba(0, 0, 0, 0.2);
    }
    
    .mobile-nav.keyboard-open {
      transform: translateY(100%);
      opacity: 0;
      pointer-events: none;
    }
    
    .nav-btn {
      flex: 1;
      background: none;
      border: none;
      color: #666;
      padding: 12px 8px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
      min-height: 60px;
    }
    
    .nav-btn.active {
      color: #fff;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      margin: 4px;
    }
    
    .nav-btn:active {
      transform: scale(0.95);
      background: rgba(255, 255, 255, 0.1);
    }
    
    .nav-icon {
      width: 24px;
      height: 24px;
      margin-bottom: 2px;
    }
    
    /* CHAT VIEW */
    #chat-mobile {
      display: flex;
      flex-direction: column;
      height: 100%;
      /* Ensure proper spacing with fixed nav */
      padding-bottom: 10px;
    }
    
    .chat-messages-mobile {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      margin-bottom: 16px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      /* Ensure scrollable area doesn't get cut off */
      min-height: 200px;
      max-height: calc(100vh - 280px);
    }
    
    .chat-input-mobile {
      display: flex;
      gap: 12px;
      align-items: center;
      /* Ensure input area is always visible */
      position: sticky;
      bottom: 0;
      background: inherit;
      padding-top: 8px;
    }
    
    .mobile-input {
      flex: 1;
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(10px);
      border: 2px solid rgba(255, 255, 255, 0.2);
      border-radius: 25px;
      padding: 12px 16px;
      color: white;
      font-size: 16px;
      outline: none;
      resize: none;
      min-height: 44px;
      max-height: 120px;
      overflow-y: auto;
      font-family: inherit;
      line-height: 1.4;
    }
    
    .mobile-input::placeholder {
      color: rgba(255, 255, 255, 0.6);
    }
    
    .mobile-input:focus {
      border-color: rgba(255, 255, 255, 0.4);
      background: rgba(255, 255, 255, 0.2);
    }
    
    .send-btn {
      background: rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      width: 48px;
      height: 48px;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    
    .send-btn:active {
      transform: scale(0.95);
      background: rgba(255, 255, 255, 0.4);
    }
    
    /* EMAIL DECODER VIEW */
    .email-section {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      padding: 20px;
      margin-bottom: 16px;
    }
    
    .section-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 12px;
      color: #fff;
    }
    
    .mobile-textarea {
      width: 100%;
      background: rgba(255, 255, 255, 0.1);
      border: 2px solid rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      padding: 16px;
      color: white;
      font-size: 16px;
      min-height: 120px;
      resize: vertical;
      outline: none;
      font-family: inherit;
    }
    
    .mobile-textarea::placeholder {
      color: rgba(255, 255, 255, 0.6);
    }
    
    .mobile-textarea:focus {
      border-color: rgba(255, 255, 255, 0.4);
      background: rgba(255, 255, 255, 0.15);
    }
    
    .decode-btn-mobile {
      width: 100%;
      background: rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 12px;
      padding: 16px;
      color: white;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 16px;
      transition: all 0.2s;
    }
    
    .decode-btn-mobile:active {
      transform: scale(0.98);
      background: rgba(255, 255, 255, 0.4);
    }
    
    /* CALENDAR VIEW */
    .calendar-section {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      padding: 20px;
      margin-bottom: 16px;
    }
    
    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    
    .month-nav {
      background: rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      padding: 8px 12px;
      color: white;
      cursor: pointer;
    }
    
    .events-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .event-item {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      padding: 16px;
      border-left: 4px solid rgba(255, 255, 255, 0.6);
    }
    
    .event-item:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateY(-1px);
    }
    
    .event-title {
      font-weight: 600;
      margin-bottom: 4px;
    }
    
    .event-time {
      color: #888;
      font-size: 14px;
    }
    
    /* LOADING STATE */
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 40px;
      color: #666;
    }
    
    /* SUCCESS/ERROR STATES */
    .success {
      background: rgba(34, 197, 94, 0.3);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(34, 197, 94, 0.5);
      border-radius: 8px;
      padding: 12px 16px;
      margin: 12px 0;
      font-size: 14px;
    }
    
    .error {
      background: rgba(220, 38, 38, 0.3);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(220, 38, 38, 0.5);
      border-radius: 8px;
      padding: 12px 16px;
      margin: 12px 0;
      font-size: 14px;
    }
    
    /* TASK CARD STYLES - Brand Purple Theme */
    .task-card {
      background: rgba(139, 92, 246, 0.3);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(139, 92, 246, 0.5);
      border-radius: 12px;
      padding: 16px;
      margin: 12px 0;
      color: white;
    }
    
    .task-priority {
      background: rgba(251, 191, 36, 0.4);
      color: #fbbf24;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      display: inline-block;
      margin-right: 8px;
    }
    
    .task-due {
      background: rgba(59, 130, 246, 0.4);
      color: #60a5fa;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      display: inline-block;
    }
    
    .task-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }
    
    .task-btn {
      background: rgba(139, 92, 246, 0.4);
      border: 1px solid rgba(139, 92, 246, 0.6);
      border-radius: 6px;
      padding: 6px 12px;
      color: white;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .task-btn:hover {
      background: rgba(139, 92, 246, 0.6);
      transform: translateY(-1px);
    }
    
    .task-btn.complete {
      background: rgba(34, 197, 94, 0.4);
      border-color: rgba(34, 197, 94, 0.6);
    }
    
    .task-btn.edit {
      background: rgba(251, 191, 36, 0.4);
      border-color: rgba(251, 191, 36, 0.6);
    }
    
    /* MOBILE EMAIL INTELLIGENCE STYLES */
    .intel-tab {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 25px;
      padding: 8px 12px;
      color: rgba(255, 255, 255, 0.7);
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .intel-tab.active {
      background: rgba(255, 255, 255, 0.3);
      color: white;
      border-color: rgba(255, 255, 255, 0.4);
      transform: scale(1.05);
    }
    
    .translated-emails-mobile {
      max-height: 400px;
      overflow-y: auto;
    }

    /* ANTI-INBOX CATEGORY STYLES */
    .category-tab {
      padding: 8px 16px;
      border: none;
      border-radius: 20px;
      background: rgba(255,255,255,0.1);
      color: rgba(255,255,255,0.7);
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 12px;
      font-weight: 500;
      white-space: nowrap;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .category-tab.active {
      background: rgba(139, 92, 246, 0.4);
      color: white;
      border: 1px solid rgba(139, 92, 246, 0.6);
    }

    .email-card {
      background: rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      border: 1px solid rgba(255,255,255,0.2);
    }

    .email-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .email-category {
      padding: 4px 8px;
      border-radius: 8px;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .category-family { background: rgba(34, 197, 94, 0.3); color: #22c55e; }
    .category-commerce { background: rgba(251, 146, 60, 0.3); color: #fb923c; }
    .category-priority { background: rgba(239, 68, 68, 0.3); color: #ef4444; }
    .category-work { background: rgba(59, 130, 246, 0.3); color: #3b82f6; }
    .category-noise { background: rgba(107, 114, 128, 0.3); color: #6b7280; }

    .manipulation-score {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
    }

    .score-low { color: #22c55e; }
    .score-medium { color: #fb923c; }
    .score-high { color: #ef4444; }

    .loyalty-badge {
      padding: 2px 6px;
      border-radius: 6px;
      font-size: 9px;
      font-weight: 600;
    }

    .loyalty-earned { background: rgba(34, 197, 94, 0.3); color: #22c55e; }
    .loyalty-manipulative { background: rgba(239, 68, 68, 0.3); color: #ef4444; }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="mobile-app">
    <!-- Header -->
    <div class="mobile-header">
      <div class="logo">HomeOps</div>
      <div style="font-size: 14px; color: rgba(255,255,255,0.8);">Works!</div>
    </div>
    
    <!-- Content Area -->
    <div class="mobile-content">
      <!-- Chat View -->
      <div id="chat-mobile" class="mobile-view active">
        <div class="chat-messages-mobile">
          <!-- Welcome Message -->
          <div style="padding: 20px; background: rgba(255,255,255,0.1); margin: 8px 0; border-radius: 18px 18px 18px 4px; max-width: 85%; border: 1px solid rgba(255,255,255,0.1);">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
              <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #8B5CF6, #06B6D4); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                <i data-lucide="home" style="width: 20px; height: 20px; color: white;"></i>
              </div>
              <div>
                <div style="font-weight: 600; margin-bottom: 2px;">HomeOps Agent</div>
                <div style="font-size: 12px; color: rgba(255,255,255,0.7);">Your Life Intelligence Assistant</div>
              </div>
            </div>
            
            <div style="line-height: 1.5; margin-bottom: 12px;">
              Hey! I'm your HomeOps Agent with multiple intelligence systems:
            </div>
            
            <div style="display: grid; gap: 8px; margin-bottom: 16px;">
              <div style="background: rgba(139, 92, 246, 0.2); padding: 8px 12px; border-radius: 8px; font-size: 13px;">
                <strong>🧠 Life Intelligence:</strong> "How can I be less anxious?" - Evidence-based frameworks
              </div>
              <div style="background: rgba(34, 197, 94, 0.2); padding: 8px 12px; border-radius: 8px; font-size: 13px;">
                <strong>✈️ Travel Intelligence:</strong> "Flight from NYC to London next week" - Real flight search
              </div>
              <div style="background: rgba(251, 191, 36, 0.2); padding: 8px 12px; border-radius: 8px; font-size: 13px;">
                <strong>🛍️ Commerce Intelligence:</strong> "Find a laptop under $1000" - Product research
              </div>
              <div style="background: rgba(59, 130, 246, 0.2); padding: 8px 12px; border-radius: 8px; font-size: 13px;">
                <strong>📧 Email Intelligence:</strong> Decode inbox manipulation & categorize signal vs noise
              </div>
            </div>
            
            <div style="font-size: 14px; color: rgba(255,255,255,0.9);">
              Try any question or explore the sections below!
            </div>
          </div>
        </div>
        
        <!-- Chat Input -->
        <div class="chat-input-mobile">
          <textarea class="mobile-input" placeholder="Type your message..." id="chatInput" rows="1"></textarea>
          <button class="send-btn" onclick="sendMessage()">
            <i data-lucide="send" style="width: 20px; height: 20px;"></i>
          </button>
        </div>
      </div>
      
      <!-- Email Decoder View -->
      <div id="email-mobile" class="mobile-view">
        <!-- Mental Load Assistant Header -->
        <div style="background: rgba(34, 197, 94, 0.2); border: 1px solid rgba(34, 197, 94, 0.4); border-radius: 16px; padding: 20px; margin-bottom: 20px;">
          <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
            <div style="width: 48px; height: 48px; background: rgba(34, 197, 94, 0.3); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px;">🧠</div>
            <div>
              <div style="font-weight: 700; font-size: 18px; color: white;">Mental Load Assistant</div>
              <div style="font-size: 14px; color: rgba(255,255,255,0.8);">Your intelligent co-parent & logistics whisperer</div>
            </div>
          </div>
          <div style="font-style: italic; color: rgba(255,255,255,0.9); line-height: 1.4; font-size: 14px;">
            "I extract the invisible labor hiding in your emails. No more buried birthday invites or missed permission slips."
          </div>
        </div>

        <!-- Quick Intelligence Status -->
        <div style="background: rgba(139, 92, 246, 0.2); border: 1px solid rgba(139, 92, 246, 0.4); border-radius: 12px; padding: 16px; margin-bottom: 20px;">
          <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
            <div style="font-weight: 600; display: flex; align-items: center; gap: 8px;">
              <i data-lucide="activity" style="width: 20px; height: 20px;"></i>
              <span>Intelligence Status</span>
            </div>
            <div id="gmail-connection-indicator" style="width: 12px; height: 12px; background: rgba(255, 193, 7, 0.8); border-radius: 50%;"></div>
          </div>
          <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;">
            <div style="background: rgba(255,255,255,0.1); padding: 8px; border-radius: 8px; text-align: center;">
              <div style="font-size: 11px; text-transform: uppercase; margin-bottom: 2px;">Tasks</div>
              <div style="font-weight: 600; font-size: 18px;" id="extracted-tasks-count">0</div>
            </div>
            <div style="background: rgba(255,255,255,0.1); padding: 8px; border-radius: 8px; text-align: center;">
              <div style="font-size: 11px, text-transform: uppercase; margin-bottom: 2px;">Events</div>
              <div style="font-weight: 600; font-size: 18px;" id="extracted-events-count">0</div>
            </div>
            <div style="background: rgba(255,255,255,0.1); padding: 8px; border-radius: 8px; text-align: center;">
              <div style="font-size: 11px; text-transform: uppercase; margin-bottom: 2px;">Urgent</div>
              <div style="font-weight: 600; font-size: 18px;" id="urgent-items-count">0</div>
            </div>
            <div style="background: rgba(255,255,255,0.1); padding: 8px; border-radius: 8px; text-align: center;">
              <div style="font-size: 11px; text-transform: uppercase; margin-bottom: 2px;">Hidden</div>
              <div style="font-weight: 600; font-size: 18px;" id="hidden-labor-count">0</div>
            </div>
          </div>
        </div>

        <!-- Connection & Actions -->
        <div style="margin-bottom: 20px;">
          <button id="connect-gmail-mobile" onclick="connectGmailMobile()" 
                  style="background: rgba(34, 197, 94, 0.3); border: 1px solid rgba(34, 197, 94, 0.6); border-radius: 12px; padding: 16px; color: white; font-size: 16px; cursor: pointer; width: 100%; margin-bottom: 12px; display: flex; align-items: center; justify-content: center; gap: 8px;">
            <i data-lucide="mail-plus" style="width: 24px; height: 24px;"></i>
            <span>Connect Gmail & Start Intelligence</span>
          </button>
          
          <div style="display: flex; gap: 8px;">
            <button id="process-emails-mobile" onclick="processEmailsMobile()" 
                    style="background: rgba(139, 92, 246, 0.3); border: 1px solid rgba(139, 92, 246, 0.6); border-radius: 8px; padding: 12px; color: white; font-size: 14px; cursor: pointer; flex: 1; display: none; align-items: center; justify-content: center; gap: 6px;">
              <i data-lucide="brain-circuit" style="width: 18px; height: 18px;"></i>
              <span>Decode Inbox</span>
            </button>
            
            <button onclick="testSampleParentEmail()" 
                    style="background: rgba(251, 191, 36, 0.3); border: 1px solid rgba(251, 191, 36, 0.6); border-radius: 8px; padding: 12px; color: white; font-size: 14px; cursor: pointer; flex: 1; display: flex; align-items: center; justify-content: center; gap: 6px;">
              <i data-lucide="test-tube" style="width: 18px; height: 18px;"></i>
              <span>Demo: School Email</span>
            </button>
          </div>
        </div>
          
        <!-- Intelligent Email Categories -->
        <div style="margin-bottom: 20px;">
          <div style="font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
            <i data-lucide="layers" style="width: 20px; height: 20px;"></i>
            <span>Mental Load Categories</span>
          </div>
            
            <!-- Category Tabs -->
            <div class="category-tabs" style="display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; overflow-x: auto;">
              <button class="category-tab active" data-category="all" onclick="showEmailCategory('all', this)">
                <span>📋</span> All
              </button>
              <button class="category-tab" data-category="family" onclick="showEmailCategory('family', this)">
                <span>👨‍👩‍👧‍👦</span> Family
              </button>
              <button class="category-tab" data-category="commerce" onclick="showEmailCategory('commerce', this)">
                <span>💳</span> Commerce
              </button>
              <button class="category-tab" data-category="priority" onclick="showEmailCategory('priority', this)">
                <span>�</span> Priority
              </button>
              <button class="category-tab" data-category="work" onclick="showEmailCategory('work', this)">
                <span>�</span> Work
              </button>
              <button class="category-tab" data-category="noise" onclick="showEmailCategory('noise', this)">
                <span>�</span> Noise
              </button>
            </div>
          </div>

          <!-- Intelligent Email Results -->
          <div id="intelligent-email-results">
            <!-- Placeholder for no emails yet -->
            <div id="no-emails-placeholder" style="text-align: center; padding: 40px 20px; background: rgba(255,255,255,0.05); border-radius: 12px; border: 1px dashed rgba(255,255,255,0.2);">
              <div style="font-size: 48px; margin-bottom: 16px;">📧</div>
              <div style="font-weight: 600; margin-bottom: 8px; color: white;">No Mental Load Extracted Yet</div>
              <div style="font-size: 14px; color: rgba(255,255,255,0.7); line-height: 1.4;">
                Connect Gmail or try the demo to see how I extract hidden tasks, events, and emotional labor from your emails.
              </div>
            </div>
          </div>
          
          <!-- Processing Status -->
          <div id="processing-status" style="display: none; text-align: center; padding: 20px;">
            <div class="typing-dots" style="margin-bottom: 10px;">
              <span>.</span><span>.</span><span>.</span>
            </div>
            <div id="processing-message">Your AI Chief of Staff is decoding...</div>
          </div>
        </div>
      </div>
      
      <!-- Calendar View -->
      <div id="calendar-mobile" class="mobile-view">
        <div class="calendar-section">
          <!-- Enhanced Calendar Header with AI Status -->
          <div class="calendar-header">
            <button class="month-nav" onclick="changeMonth(-1)">‹</button>
            <div class="section-title" id="current-month">📅 July 2025</div>
            <button class="month-nav" onclick="changeMonth(1)">›</button>
          </div>
          
          <!-- AI Intelligence Status -->
          <div style="background: rgba(139, 92, 246, 0.2); border: 1px solid rgba(139, 92, 246, 0.4); border-radius: 12px; padding: 12px; margin-bottom: 16px;">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
              <i data-lucide="brain" style="width: 16px; height: 16px;"></i>
              <span style="font-weight: 600; font-size: 14px;">Calendar AI Center</span>
            </div>
            <div style="display: flex; gap: 6px; flex-wrap: wrap;">
              <span style="background: rgba(34, 197, 94, 0.4); color: #22c55e; padding: 3px 8px; border-radius: 6px; font-size: 11px; font-weight: 600;">🧠 Life Intelligence</span>
              <span style="background: rgba(251, 191, 36, 0.4); color: #fbbf24; padding: 3px 8px; border-radius: 6px; font-size: 11px; font-weight: 600;">🛒 Commerce</span>
              <span style="background: rgba(59, 130, 246, 0.4); color: #3b82f6; padding: 3px 8px; border-radius: 6px; font-size: 11px; font-weight: 600;">✈️ Travel</span>
              <span style="background: rgba(168, 85, 247, 0.4); color: #a855f7; padding: 3px 8px; border-radius: 6px; font-size: 11px; font-weight: 600;">📋 Logistics</span>
            </div>
            <div style="font-size: 12px; color: rgba(255,255,255,0.7); margin-top: 6px;">
              💡 Smart events get contextual AI assistance
            </div>
          </div>
          
          <!-- Enhanced Calendar Grid -->
          <div class="calendar-grid" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: rgba(255,255,255,0.1); border-radius: 12px; overflow: hidden; margin-bottom: 20px;">
            <!-- Day headers -->
            <div class="day-header" style="background: rgba(255,255,255,0.1); padding: 8px 4px; text-align: center; font-size: 12px; font-weight: 600;">S</div>
            <div class="day-header" style="background: rgba(255,255,255,0.1); padding: 8px 4px; text-align: center; font-size: 12px; font-weight: 600;">M</div>
            <div class="day-header" style="background: rgba(255,255,255,0.1); padding: 8px 4px; text-align: center; font-size: 12px; font-weight: 600;">T</div>
            <div class="day-header" style="background: rgba(255,255,255,0.1); padding: 8px 4px; text-align: center; font-size: 12px; font-weight: 600;">W</div>
            <div class="day-header" style="background: rgba(255,255,255,0.1); padding: 8px 4px; text-align: center; font-size: 12px; font-weight: 600;">T</div>
            <div class="day-header" style="background: rgba(255,255,255,0.1); padding: 8px 4px; text-align: center; font-size: 12px; font-weight: 600;">F</div>
            <div class="day-header" style="background: rgba(255,255,255,0.1); padding: 8px 4px; text-align: center; font-size: 12px; font-weight: 600;">S</div>
            
            <!-- Calendar days (will be populated by JS) -->
            <div id="calendar-days" style="display: contents;">
              <!-- JS will populate calendar days here -->
            </div>
          </div>
          
          <!-- Smart Today's Events -->
          <div class="today-events">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
              <div style="font-weight: 600; color: #fff; display: flex; align-items: center; gap: 8px;">
                <i data-lucide="calendar-days" style="width: 16px; height: 16px;"></i>
                Today's Smart Events
              </div>
              <button onclick="syncWithGmailCalendar()" style="background: rgba(34, 197, 94, 0.3); border: 1px solid rgba(34, 197, 94, 0.6); border-radius: 6px; padding: 4px 8px; color: white; font-size: 11px; cursor: pointer;">
                <i data-lucide="refresh-cw" style="width: 12px; height: 12px; margin-right: 2px;"></i>
                Sync Gmail
              </button>
            </div>
            <div class="events-list" id="today-events-list">
              <!-- Smart events will be populated by renderSmartCalendar() -->
            </div>
            
            <!-- Quick Event Templates -->
            <div style="margin-top: 16px;">
              <div style="font-weight: 600; margin-bottom: 8px; color: #fff; font-size: 14px;">Quick Add Templates</div>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                <button onclick="addQuickEvent('meeting')" style="background: rgba(59, 130, 246, 0.3); border: 1px solid rgba(59, 130, 246, 0.6); border-radius: 8px; padding: 8px; color: white; font-size: 12px; cursor: pointer;">
                  <i data-lucide="users" style="width: 14px; height: 14px; margin-bottom: 4px;"></i><br>
                  Meeting
                </button>
                <button onclick="addQuickEvent('appointment')" style="background: rgba(168, 85, 247, 0.3); border: 1px solid rgba(168, 85, 247, 0.6); border-radius: 8px; padding: 8px; color: white; font-size: 12px; cursor: pointer;">
                  <i data-lucide="calendar-check" style="width: 14px; height: 14px; margin-bottom: 4px;"></i><br>
                  Appointment
                </button>
                <button onclick="addQuickEvent('travel')" style="background: rgba(34, 197, 94, 0.3); border: 1px solid rgba(34, 197, 94, 0.6); border-radius: 8px; padding: 8px; color: white; font-size: 12px; cursor: pointer;">
                  <i data-lucide="plane" style="width: 14px; height: 14px; margin-bottom: 4px;"></i><br>
                  Travel
                </button>
                <button onclick="addQuickEvent('personal')" style="background: rgba(251, 191, 36, 0.3); border: 1px solid rgba(251, 191, 36, 0.6); border-radius: 8px; padding: 8px; color: white; font-size: 12px; cursor: pointer;">
                  <i data-lucide="heart" style="width: 14px; height: 14px; margin-bottom: 4px;"></i><br>
                  Personal
                </button>
              </div>
            </div>
          </div>
          
          <!-- Enhanced Add Event Button -->
          <button class="decode-btn-mobile" onclick="addSmartEventMobile()" style="margin-top: 16px;">
            <i data-lucide="plus" style="width: 20px; height: 20px; margin-right: 8px;"></i>
            Add Smart Event with AI
          </button>
        </div>
      </div>
    </div>
    
    <!-- Bottom Navigation -->
    <div class="mobile-nav">
      <button class="nav-btn active" onclick="showView('chat-mobile', this)">
        <i data-lucide="message-circle" class="nav-icon"></i>
        Chat
      </button>
      <button class="nav-btn" onclick="showView('email-mobile', this)">
        <i data-lucide="mail" class="nav-icon"></i>
        Email
      </button>
      <button class="nav-btn" onclick="showView('calendar-mobile', this)">
        <i data-lucide="calendar" class="nav-icon"></i>
        Calendar
      </button>
    </div>
  </div>
  
  <script>
    // Mobile-First JavaScript - Define functions immediately
    window.showView = function(viewId, button) {
      console.log('Switching to view:', viewId);
      
      // Hide all views immediately
      document.querySelectorAll('.mobile-view').forEach(view => {
        view.classList.remove('active');
        view.style.display = 'none';
      });
      
      // Remove active from all nav buttons
      document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      
      // Show selected view immediately
      const targetView = document.getElementById(viewId);
      if (targetView) {
        targetView.style.display = 'block';
        targetView.classList.add('active');
        
        // Initialize view-specific content
        if (viewId === 'email-mobile') {
          initializeEmailView();
        } else if (viewId === 'calendar-mobile') {
          initializeCalendarView();
        }
      }
      
      if (button) {
        button.classList.add('active');
      }
      
      // Haptic feedback
      if (navigator.vibrate) {
        navigator.vibrate(10);
      }
    }
    
    // Create global alias for compatibility
    window.showView = window.showView || function() { console.error('showView not loaded yet'); };
    
    function initializeEmailView() {
      console.log('Initializing email view...');
      console.log('🔄 Calling checkGmailConnection from initializeEmailView');
      checkGmailConnection();
    }
    
    function initializeCalendarView() {
      console.log('Initializing calendar view...');
      if (!document.getElementById('calendar-days').innerHTML) {
        renderCalendar();
      }
    }
    
    async function sendMessage() {
      const input = document.getElementById('chatInput');
      const message = input.value.trim();
      
      if (!message) return;
      
      const messagesDiv = document.querySelector('.chat-messages-mobile');
      
      // Add user message with better styling
      messagesDiv.innerHTML += `
        <div style="padding: 12px 20px; background: rgba(255,255,255,0.3); backdrop-filter: blur(10px); margin: 8px 0; border-radius: 18px 18px 4px 18px; max-width: 85%; margin-left: auto; border: 1px solid rgba(255,255,255,0.2);">
          ${message}
        </div>
      `;
      
      input.value = '';
      
      // Reset textarea height
      input.style.height = 'auto';
      input.style.height = '44px';
      
      // Smart action detection BEFORE sending to AI
      const actionDetected = detectAndExecuteActions(message);
      
      if (actionDetected) {
        // Action was detected and executed, no need for AI response
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
        return;
      }
      
      // Only proceed with AI if no action was detected
      if (!actionDetected) {
        // Add typing indicator
        messagesDiv.innerHTML += `
          <div id="typing-indicator" style="padding: 12px 20px; background: rgba(255,255,255,0.1); margin: 8px 0; border-radius: 18px 18px 18px 4px; max-width: 85%; border: 1px solid rgba(255,255,255,0.1);">
            <div style="display: flex; align-items: center; gap: 8px; color: rgba(255,255,255,0.7);">
              <div class="typing-dots">
                <span>.</span><span>.</span><span>.</span>
              </div>
              HomeOps is thinking...
            </div>
          </div>
        `;
        
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
        
        // Call real AI backend
        try {
          console.log('📡 Sending to AI backend:', message);
          
          // Get or create user ID for this session
          let userId = localStorage.getItem('homeops_user_id');
          if (!userId) {
            userId = 'mobile_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('homeops_user_id', userId);
          }
          
          const response = await fetch('/chat', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              message: message,
              userId: userId
            })
          });
          
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          
          const data = await response.json();
          
          // Replace typing indicator with AI response
          const typingEl = document.getElementById('typing-indicator');
          if (typingEl && data.reply) {
            
            // Check if this is a Life Intelligence structured response
            if (data.reply.startsWith('LIFE_INTELLIGENCE_CARD:')) {
              try {
                const cardData = JSON.parse(data.reply.replace('LIFE_INTELLIGENCE_CARD:', ''));
                
                typingEl.innerHTML = `
                  <div style="background: rgba(139, 92, 246, 0.3); border: 1px solid rgba(139, 92, 246, 0.5); border-radius: 12px; padding: 16px; margin: 8px 0;">
                    <div style="font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                      <i data-lucide="brain" style="width: 20px; height: 20px;"></i>
                      <span>Life Intelligence</span>
                    </div>
                    
                    <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px; margin-bottom: 12px;">
                      <div style="font-weight: 600; margin-bottom: 6px;">📊 Analysis</div>
                      <div style="font-size: 14px; line-height: 1.4;">${cardData.analysis}</div>
                      <div style="font-size: 12px; color: rgba(255,255,255,0.7); margin-top: 4px; font-style: italic;">Framework: ${cardData.framework}</div>
                    </div>
                    
                    <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px; margin-bottom: 12px;">
                      <div style="font-weight: 600; margin-bottom: 8px;">🎯 Evidence-Based Insights</div>
                      ${cardData.insights.map(insight => `
                        <div style="margin: 6px 0; font-size: 13px; line-height: 1.4; padding-left: 12px; border-left: 2px solid rgba(139, 92, 246, 0.6);">
                          ${insight}
                        </div>
                      `).join('')}
                    </div>
                    
                    <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px; margin-bottom: 12px;">
                      <div style="font-weight: 600; margin-bottom: 8px;">✅ Action Protocol</div>
                      ${cardData.action_steps.map((step, index) => `
                        <div style="margin: 8px 0; font-size: 13px; line-height: 1.4; display: flex; gap: 8px;">
                          <span style="background: rgba(139, 92, 246, 0.6); color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 600; flex-shrink: 0;">${index + 1}</span>
                          <span>${step}</span>
                        </div>
                      `).join('')}
                    </div>
                    
                    <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px; margin-bottom: 12px;">
                      <div style="font-weight: 600; margin-bottom: 6px;">🔄 Reframe</div>
                      <div style="font-size: 14px; line-height: 1.4; font-style: italic;">${cardData.reframe}</div>
                    </div>
                    
                    <div style="background: rgba(34, 197, 94, 0.2); border: 1px solid rgba(34, 197, 94, 0.4); padding: 12px; border-radius: 8px; margin-top: 12px;">
                      <div style="font-weight: 600; margin-bottom: 6px;">🚀 Next Step (Today)</div>
                      <div style="font-size: 14px; line-height: 1.4;">${cardData.next_step}</div>
                    </div>
                    
                    <div style="font-size: 11px; color: rgba(255,255,255,0.6); text-align: center; margin-top: 12px;">
                      🧠 Evidence-based guidance from clinical psychology & relationship science
                    </div>
                  </div>
                `;
                
                // Initialize Lucide icons
                setTimeout(() => {
                  if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                  }
                }, 100);
                
              } catch (error) {
                console.error('Error parsing Life Intelligence card:', error);
                // Fallback to regular display
                typingEl.innerHTML = `
                  <div style="color: white; line-height: 1.4;">
                    ${data.reply.replace('LIFE_INTELLIGENCE_CARD:', '')}
                  </div>
                `;
              }
            } else if (data.reply.startsWith('EMAIL_INTELLIGENCE_SUMMARY:')) {
              // Handle Email Intelligence Summary
              try {
                const emailData = JSON.parse(data.reply.replace('EMAIL_INTELLIGENCE_SUMMARY:', ''));
                
                typingEl.innerHTML = `
                  <div style="background: rgba(34, 197, 94, 0.3); border: 1px solid rgba(34, 197, 94, 0.5); border-radius: 12px; padding: 16px; margin: 8px 0;">
                    <div style="font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                      <i data-lucide="mail-search" style="width: 20px; height: 20px;"></i>
                      <span>📧 Email Intelligence Summary</span>
                    </div>
                    
                    <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px; margin-bottom: 12px;">
                      <div style="font-weight: 600; margin-bottom: 8px;">📊 Weekly Overview</div>
                      <div style="font-size: 14px; line-height: 1.4; margin-bottom: 8px;">${emailData.summary}</div>
                      <div style="font-size: 12px; color: rgba(255,255,255,0.7);">
                        📧 ${emailData.emailCount} emails analyzed from the last week
                      </div>
                    </div>
                    
                    ${emailData.categories ? `
                      <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px; margin-bottom: 12px;">
                        <div style="font-weight: 600; margin-bottom: 8px;">📂 Category Breakdown</div>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
                          ${Object.entries(emailData.categories).filter(([category, emails]) => emails.length > 0).map(([category, emails]) => `
                            <div style="background: rgba(255,255,255,0.1); padding: 8px; border-radius: 6px; text-align: center;">
                              <div style="font-size: 11px; text-transform: uppercase; margin-bottom: 2px;">${category}</div>
                              <div style="font-weight: 600; font-size: 18px;">${emails.length}</div>
                            </div>
                          `).join('')}
                        </div>
                      </div>
                    ` : ''}
                    
                    <button onclick="showView('email-mobile', document.querySelector('.nav-btn[onclick*=\"email-mobile\"]'))" 
                            style="background: rgba(34, 197, 94, 0.4); border: 1px solid rgba(34, 197, 94, 0.6); border-radius: 8px; padding: 8px 16px; color: white; font-size: 14px; cursor: pointer; width: 100%;">
                      <i data-lucide="arrow-right" style="width: 16px; height: 16px; margin-right: 4px;"></i>
                      View Full Email Intelligence
                    </button>
                  </div>
                `;
                
                // Initialize Lucide icons
                setTimeout(() => {
                  if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                  }
                }, 100);
                
              } catch (error) {
                console.error('Error parsing Email Intelligence summary:', error);
                // Fallback to regular display
                typingEl.innerHTML = `
                  <div style="color: white; line-height: 1.4;">
                    📧 ${data.reply.replace('EMAIL_INTELLIGENCE_SUMMARY:', '')}
                  </div>
                `;
              }
            } else {
              // Regular response display
              typingEl.innerHTML = `
                <div style="color: white; line-height: 1.4;">
                  ${data.reply}
                </div>
              `;
            }
            
            typingEl.style.background = 'rgba(139, 92, 246, 0.2)';
            typingEl.style.borderColor = 'rgba(139, 92, 246, 0.4)';
            typingEl.removeAttribute('id');
          }
          
        } catch (error) {
          console.error('❌ AI Backend Error:', error);
          const typingEl = document.getElementById('typing-indicator');
          if (typingEl) {
            typingEl.innerHTML = `
              <div style="color: rgba(255,200,100,0.9);">
                I'm having trouble connecting to my AI brain right now. Can you try rephrasing your request? I can still help with calendar events, flights, and other specific tasks.
              </div>
            `;
            typingEl.style.background = 'rgba(255,200,100,0.2)';
            typingEl.style.borderColor = 'rgba(255,200,100,0.4)';
            typingEl.removeAttribute('id');
          }
        }
        
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
        
        // Initialize Lucide icons after adding new content
        if (typeof lucide !== 'undefined') {
          lucide.createIcons();
        }
      }
      
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    // Helper function to add messages
    function addMessage(type, content) {
      const messagesDiv = document.querySelector('.chat-messages-mobile');
      messagesDiv.innerHTML += content;
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function addSystemMessage(messagesDiv, message) {
      messagesDiv.innerHTML += `
        <div style="padding: 8px 16px; background: rgba(34, 197, 94, 0.2); margin: 8px 0; border-radius: 12px; border: 1px solid rgba(34, 197, 94, 0.4); font-size: 14px;">
          ${message}
        </div>
      `;
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
     // Smart action detection and execution
    function detectAndExecuteActions(message) {
      const msg = message.toLowerCase();
      const messagesDiv = document.querySelector('.chat-messages-mobile');
      
      // Enhanced detection patterns - FLIGHT SEARCH FIRST PRIORITY
      
      // Flight search detection - HIGHEST PRIORITY CHECK
      if (msg.includes('flight') || msg.includes('flights') || msg.includes('fly') || msg.includes('plane') || 
          msg.includes('cheapest flight') || msg.includes('book flight') ||
          (msg.includes('from') && msg.includes('to') && (msg.includes('nyc') || msg.includes('new york') || msg.includes('boston') || msg.includes('dc') || msg.includes('washington') || msg.includes('london') || msg.includes('lax') || msg.includes('seattle'))) ||
          (msg.includes('to ') && (msg.includes('london') || msg.includes('paris') || msg.includes('seattle') || msg.includes('boston') || msg.includes('lax')))) {
        executeFlightSearch(message, messagesDiv);
        return true;
      }
      
      // Commerce/Shopping search detection - SECOND PRIORITY
      if (msg.includes('gift') || msg.includes('present') || msg.includes('birthday') || 
          msg.includes('need to buy') || msg.includes('looking for') || msg.includes('shopping for') ||
          msg.includes('laptop') || msg.includes('computer') || msg.includes('phone') ||
          (msg.includes('need') && (msg.includes('for my') || msg.includes('daughter') || msg.includes('son') || msg.includes('kid')))) {
        executeShoppingSearch(message, messagesDiv);
        return true;
      }
      
      // Calendar injection commands - Enhanced detection (PRIORITY - includes dentist appointment)
      if ((msg.includes('add') || msg.includes('create') || msg.includes('schedule') || msg.includes('i have') || msg.includes('meeting') || msg.includes('appointment') || msg.includes('dentist')) && 
          (msg.includes('calendar') || msg.includes('event') || msg.includes('meeting') || msg.includes('at ') || msg.includes('pm') || msg.includes('am') || msg.includes('tomorrow') || msg.includes('appointment')) ||
          (msg.includes('golf') && (msg.includes('tomorrow') || msg.includes('1pm'))) ||
          (msg.includes('sunday') || msg.includes('monday') || msg.includes('tuesday') || msg.includes('wednesday') || msg.includes('thursday') || msg.includes('friday') || msg.includes('saturday')) && (msg.includes('at ') || msg.includes('pm') || msg.includes('am'))) {
        
        executeCalendarInjection(message, messagesDiv);
        return true;
      }
      
      // Calendar viewing/checking commands
      if ((msg.includes('do i have') || msg.includes('what do i have') || msg.includes('whats on my') || msg.includes('check my') || msg.includes('show my')) && 
          (msg.includes('calendar') || msg.includes('schedule') || msg.includes('going on'))) {
        executeCalendarView(messagesDiv);
        return true;
      }
      
      // Task management commands - Enhanced detection
      if (msg.includes('remind me') || msg.includes('set reminder') || msg.includes('dont forget') || msg.includes("don't forget") ||
          (msg.includes('add') && (msg.includes('task') || msg.includes('todo') || msg.includes('reminder')))) {
        executeTaskManagement(message, messagesDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
        return true;
      }
      
      // Travel planning commands
      if ((msg.includes('travel') || msg.includes('trip') || msg.includes('vacation') || msg.includes('flight')) && 
          (msg.includes('plan') || msg.includes('book') || msg.includes('need') || msg.includes('help'))) {
        executeTravelPlanning(message, messagesDiv);
        return true;
      }
      
      // Shopping/purchase commands
      if ((msg.includes('buy') || msg.includes('purchase') || msg.includes('order') || msg.includes('need to get')) ||
          (msg.includes('shopping') && (msg.includes('list') || msg.includes('help')))) {
        executeShoppingAssistant(message, messagesDiv);
        return true;
      }
      
      // Contact/communication commands
      if ((msg.includes('call') || msg.includes('text') || msg.includes('email') || msg.includes('contact')) && 
          (msg.includes('remind me') || msg.includes('need to') || msg.includes('should'))) {
        executeCommunicationReminder(message, messagesDiv);
        return true;
      }
      
      // Health/wellness tracking
      if (msg.includes('water') || msg.includes('exercise') || msg.includes('workout') || 
          (msg.includes('track') && (msg.includes('health') || msg.includes('wellness')))) {
        executeWellnessTracking(message, messagesDiv);
        return true;
      }
      
      // Financial tracking
      if ((msg.includes('budget') || msg.includes('expense') || msg.includes('spending')) ||
          (msg.includes('how much') && (msg.includes('spent') || msg.includes('cost')))) {
        executeFinancialTracking(message, messagesDiv);
        return true;
      }
      
      // Agentic browsing and web intelligence
      if (msg.includes('find') || msg.includes('search') || msg.includes('best') || msg.includes('compare') || 
          msg.includes('flights') || msg.includes('restaurants') || msg.includes('hotels') || msg.includes('venues') ||
          msg.includes('where to') || msg.includes('recommendations for') || msg.includes('book') ||
          (msg.includes('united') && msg.includes('flight')) || (msg.includes('dinner') && msg.includes('reservation'))) {
        executeAgenticSearch(message, messagesDiv);
        return true;
      }
      
      // Agentic browsing and search intelligence
      if ((msg.includes('find') || msg.includes('search') || msg.includes('best') || msg.includes('compare') || msg.includes('look up')) &&
          (msg.includes('flight') || msg.includes('restaurant') || msg.includes('hotel') || msg.includes('venue') || 
           msg.includes('shop') || msg.includes('price') || msg.includes('review') || msg.includes('near me') ||
           msg.includes('to ') || msg.includes('in ') || msg.includes('for '))) {
        executeAgenticSearch(message, messagesDiv);
        return true;
      }
      
      // Deal intelligence (RCS-style)
      if (msg.includes('deals') || msg.includes('offers') || msg.includes('sales') || msg.includes('discounts') || 
          msg.includes('good deal') || msg.includes('bargain') || msg.includes('cheap') || 
          (msg.includes('find') && (msg.includes('deal') || msg.includes('offer')))) {
        executeDealIntelligence(message, messagesDiv);
        return true;
      }
      
      // Email summary functionality
      if (msg.includes('email summary') || msg.includes('recent emails') || msg.includes('inbox summary') || 
          msg.includes('summarize emails') || msg.includes('latest emails') || msg.includes('what emails') ||
          (msg.includes('summary') && msg.includes('email'))) {
        executeEmailSummary(message, messagesDiv);
        return true;
      }
      
      // Email surfacing commands
      if (msg.includes('show') && (msg.includes('email') || msg.includes('urgent') || msg.includes('important'))) {
        executeEmailSurfacing(messagesDiv);
        return true;
      }
      
      // Deal detection commands
      if (msg.includes('deal') || msg.includes('sale') || (msg.includes('find') && msg.includes('buy'))) {
        executeDealIntelligence(message, messagesDiv);
        return true;
      }
      
      // Week planning commands
      if (msg.includes('plan') && (msg.includes('week') || msg.includes('today') || msg.includes('tomorrow'))) {
        executeWeekPlanning(messagesDiv);
        return true;
      }
      
      // Navigation shortcuts
      if (msg.includes('switch to') || msg.includes('go to')) {
        if (msg.includes('email')) {
          const emailBtn = document.querySelector('.nav-btn[onclick*="email-mobile"]');
          showView('email-mobile', emailBtn);
          addSystemMessage(messagesDiv, "📧 Switched to Email view");
          return true;
        }
        if (msg.includes('calendar')) {
          const calendarBtn = document.querySelector('.nav-btn[onclick*="calendar-mobile"]');
          showView('calendar-mobile', calendarBtn);
          addSystemMessage(messagesDiv, "📅 Switched to Calendar view");
          return true;
        }
      }
      
      return false; // No action detected, proceed with AI
    }
    
    function executeTaskManagement(message, messagesDiv) {
      const msg = message.toLowerCase();
      
      // Task creation patterns
      if (msg.includes('remind me') || msg.includes('add task') || msg.includes('todo') || 
          msg.includes('need to') || msg.includes('don\'t forget') || msg.includes('schedule')) {
        
        let taskTitle = 'New Task';
        let priority = 'Medium';
        let dueDate = 'Today';
        
        // Extract task details
        if (msg.includes('urgent') || msg.includes('asap') || msg.includes('immediately')) {
          priority = 'High';
        } else if (msg.includes('later') || msg.includes('sometime') || msg.includes('eventually')) {
          priority = 'Low';
        }
        
        // Extract due date
        if (msg.includes('tomorrow')) dueDate = 'Tomorrow';
        else if (msg.includes('next week')) dueDate = 'Next Week';
        else if (msg.includes('monday')) dueDate = 'Monday';
        else if (msg.includes('friday')) dueDate = 'Friday';
        
        // Extract task title (basic extraction)
        const reminderMatch = msg.match(/remind me (?:to )?(.+?)(?:\s+(?:tomorrow|today|next week|monday|tuesday|wednesday|thursday|friday|saturday|sunday))?$/);
        const taskMatch = msg.match(/(?:add task|todo|need to|don't forget)\s+(.+?)(?:\s+(?:tomorrow|today|next week|monday|tuesday|wednesday|thursday|friday|saturday|sunday))?$/);
        
        if (reminderMatch) taskTitle = reminderMatch[1].trim();
        else if (taskMatch) taskTitle = taskMatch[1].trim();
        
        const taskCard = `
          <div style="padding: 12px 20px; background: rgba(139, 92, 246, 0.3); backdrop-filter: blur(10px); margin: 8px 0; border-radius: 4px 18px 18px 18px; max-width: 95%; border: 1px solid rgba(139, 92, 246, 0.5);">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
              <i data-lucide="check-circle" style="width: 20px; height: 20px; color: #a78bfa;"></i>
              <span style="font-weight: 600; color: white;">Task Created</span>
            </div>
            
            <div style="margin-bottom: 12px;">
              <div style="font-weight: 600; font-size: 16px; margin-bottom: 8px; color: white;">${taskTitle}</div>
              <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                <span style="background: rgba(251, 191, 36, 0.4); color: #fbbf24; padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 600; display: inline-flex; align-items: center; gap: 4px;">
                  <i data-lucide="flag" style="width: 12px; height: 12px;"></i>
                  ${priority} Priority
                </span>
                <span style="background: rgba(59, 130, 246, 0.4); color: #60a5fa; padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 600; display: inline-flex; align-items: center; gap: 4px;">
                  <i data-lucide="calendar" style="width: 12px; height: 12px;"></i>
                  Due: ${dueDate}
                </span>
              </div>
            </div>
            
            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
              <button onclick="markTaskComplete(this)" style="background: rgba(34, 197, 94, 0.4); border: 1px solid rgba(34, 197, 94, 0.6); border-radius: 6px; padding: 6px 12px; color: white; font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 4px;">
                <i data-lucide="check" style="width: 12px; height: 12px;"></i>
                Complete
              </button>
              <button onclick="editTask(this)" style="background: rgba(251, 191, 36, 0.4); border: 1px solid rgba(251, 191, 36, 0.6); border-radius: 6px; padding: 6px 12px; color: white; font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 4px;">
                <i data-lucide="edit" style="width: 12px; height: 12px;"></i>
                Edit
              </button>
              <button onclick="snoozeTask(this)" style="background: rgba(139, 92, 246, 0.4); border: 1px solid rgba(139, 92, 246, 0.6); border-radius: 6px; padding: 6px 12px; color: white; font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 4px;">
                <i data-lucide="clock" style="width: 12px; height: 12px;"></i>
                Snooze
              </button>
            </div>
          </div>
        `;
        
        // Initialize Lucide icons for the new card
        setTimeout(() => {
          if (typeof lucide !== 'undefined') {
            lucide.createIcons();
          }
        }, 100);
        
        return true;
      }
      
      // Task listing
      if (msg.includes('show tasks') || msg.includes('list tasks') || msg.includes('my tasks') || 
          msg.includes('what do i need to do') || msg.includes('todo list')) {
        
        const tasksCard = `
          <div class="action-card tasks-list-card">
            <div class="card-header">
              <i data-lucide="list-checks"></i>
              <span>Your Tasks</span>
            </div>
            <div class="card-content">
              <div class="task-item">
                <div class="task-checkbox">
                  <i data-lucide="circle"></i>
                </div>
                <div class="task-info">
                  <span class="task-title">Review Q4 budget proposal</span>
                  <span class="task-meta">Due: Today • High Priority</span>
                </div>
              </div>
              <div class="task-item">
                <div class="task-checkbox">
                  <i data-lucide="circle"></i>
                </div>
                <div class="task-info">
                  <span class="task-title">Schedule dentist appointment</span>
                  <span class="task-meta">Due: This Week • Medium Priority</span>
                </div>
              </div>
              <div class="task-item">
                <div class="task-checkbox">
                  <i data-lucide="circle"></i>
                </div>
                <div class="task-info">
                  <span class="task-title">Plan weekend family activities</span>
                  <span class="task-meta">Due: Friday • Low Priority</span>
                </div>
              </div>
            </div>
            <div class="card-actions">
              <button onclick="addNewTask()" class="action-btn primary">
                <i data-lucide="plus"></i>
                Add Task
              </button>
              <button onclick="filterTasks()" class="action-btn secondary">
                <i data-lucide="filter"></i>
                Filter
              </button>
            </div>
          </div>
        `;
        
        addMessage('assistant', tasksCard);
        
        // Initialize Lucide icons
        setTimeout(() => {
          if (typeof lucide !== 'undefined') {
            lucide.createIcons();
          }
        }, 100);
        
        return true;
      }
      
      return false;
    }
    
    function executeCalendarInjection(message, messagesDiv) {
      const msg = message.toLowerCase();
      let eventDetails = {
        title: 'New Event',
        date: 'Today',
        time: '12:00 PM',
        duration: '1 hour'
      };
      
      // Extract event type with enhanced detection
      if (msg.includes('golf')) eventDetails.title = 'Golf';
      else if (msg.includes('meeting')) eventDetails.title = 'Meeting';
      else if (msg.includes('appointment')) eventDetails.title = 'Appointment';
      else if (msg.includes('call')) eventDetails.title = 'Call';
      else if (msg.includes('lunch')) eventDetails.title = 'Lunch';
      else if (msg.includes('dinner')) eventDetails.title = 'Dinner';
      else if (msg.includes('flight')) eventDetails.title = 'Flight';
      else if (msg.includes('conference')) eventDetails.title = 'Conference';
      else if (msg.includes('pickup')) eventDetails.title = 'Pickup';
      else if (msg.includes('dropoff')) eventDetails.title = 'Drop-off';
      else if (msg.includes('doctor')) eventDetails.title = 'Doctor Appointment';
      else if (msg.includes('dentist')) eventDetails.title = 'Dentist Appointment';
      else if (msg.includes('birthday')) eventDetails.title = 'Birthday Party';
      else if (msg.includes('party')) eventDetails.title = 'Party';
      else if (msg.includes('thanksgiving') || msg.includes('parents coming')) eventDetails.title = 'Family Visit';
      else if (msg.includes('travel') || msg.includes('trip')) eventDetails.title = 'Travel';
      
      // Extract day
      if (msg.includes('sunday')) eventDetails.date = 'Sunday';
      else if (msg.includes('monday')) eventDetails.date = 'Monday';
      else if (msg.includes('tuesday')) eventDetails.date = 'Tuesday';
      else if (msg.includes('wednesday')) eventDetails.date = 'Wednesday';
      else if (msg.includes('thursday')) eventDetails.date = 'Thursday';
      else if (msg.includes('friday')) eventDetails.date = 'Friday';
      else if (msg.includes('saturday')) eventDetails.date = 'Saturday';
      else if (msg.includes('tomorrow')) eventDetails.date = 'Tomorrow';
      else if (msg.includes('today')) eventDetails.date = 'Today';
      
      // Extract time with better patterns
      const timePatterns = [
        /(\d{1,2})\s*pm/i,
        /(\d{1,2})\s*am/i,
        /(\d{1,2}):(\d{2})\s*pm/i,
        /(\d{1,2}):(\d{2})\s*am/i,
        /at\s+(\d{1,2})\s*pm/i,
        /at\s+(\d{1,2})\s*am/i,
        /at\s+(\d{1,2}):(\d{2})\s*pm/i,
        /at\s+(\d{1,2}):(\d{2})\s*am/i
      ];
      
      for (const pattern of timePatterns) {
        const match = message.match(pattern);
        if (match) {
          if (match[2]) {
            // Has minutes
            const hour = parseInt(match[1]);
            const minute = match[2];
            const period = message.toLowerCase().includes('pm') ? 'PM' : 'AM';
            eventDetails.time = `${hour}:${minute} ${period}`;
          } else {
            // Just hour
            const hour = parseInt(match[1]);
            const period = message.toLowerCase().includes('pm') ? 'PM' : 'AM';
            eventDetails.time = `${hour}:00 ${period}`;
          }
          break;
        }
      }
      
      // Smart duration estimation with AI intelligence integration
      if (msg.includes('meeting')) eventDetails.duration = '1 hour';
      else if (msg.includes('golf')) eventDetails.duration = '4 hours';
      else if (msg.includes('lunch') || msg.includes('dinner')) eventDetails.duration = '1.5 hours';
      else if (msg.includes('call')) eventDetails.duration = '30 minutes';
      else if (msg.includes('dentist') || msg.includes('doctor')) eventDetails.duration = '1 hour';
      else if (msg.includes('party') || msg.includes('birthday')) eventDetails.duration = '3 hours';
      else if (msg.includes('family') || msg.includes('thanksgiving')) eventDetails.duration = '4 hours';
      
      // AI Intelligence Integration - determine which engines to surface
      const aiEngines = determineEventIntelligence(eventDetails.title, msg);
      
      messagesDiv.innerHTML += `
        <div style="background: rgba(34, 197, 94, 0.2); border: 1px solid rgba(34, 197, 94, 0.4); border-radius: 12px; padding: 16px; margin: 12px 0;">
          <div style="font-weight: 600; margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
            <i data-lucide="calendar-plus" style="width: 20px; height: 20px;"></i>
            <span>📅 Smart Calendar Event</span>
          </div>
          <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px; margin-bottom: 16px;">
            <div style="font-weight: 600; font-size: 16px; margin-bottom: 4px;">${eventDetails.title}</div>
            <div style="font-size: 14px; color: rgba(255,255,255,0.9); margin-bottom: 8px;">
              📅 ${eventDetails.date}<br>
              ⏰ ${eventDetails.time}<br>
              ⌛ Duration: ${eventDetails.duration}
            </div>
          </div>
          
          ${aiEngines.length > 0 ? `
            <div style="background: rgba(139, 92, 246, 0.2); padding: 12px; border-radius: 8px; margin-bottom: 16px;">
              <div style="font-weight: 600; margin-bottom: 8px; display: flex; align-items: center; gap: 6px;">
                <i data-lucide="brain" style="width: 16px; height: 16px;"></i>
                AI Intelligence Available
              </div>
              <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                ${aiEngines.map(engine => `
                  <span style="background: ${engine.color}; padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 600; display: flex; align-items: center; gap: 4px;">
                    ${engine.icon} ${engine.name}
                  </span>
                `).join('')}
              </div>
              <div style="font-size: 12px; color: rgba(255,255,255,0.7); margin-top: 6px;">
                💡 Click event after adding to access contextual AI assistance
              </div>
            </div>
          ` : ''}
          
          <div style="display: flex; gap: 8px; margin-top: 12px;">
            <button onclick="executeSmartCalendarAdd('${eventDetails.title}', '${eventDetails.date}', '${eventDetails.time}', '${eventDetails.duration}', '${JSON.stringify(aiEngines).replace(/'/g, "\\'")}'" 
                    style="background: rgba(34, 197, 94, 0.3); border: 1px solid rgba(34, 197, 94, 0.6); border-radius: 8px; padding: 8px 16px; color: white; font-size: 14px; cursor: pointer; flex: 1;">
              <i data-lucide="plus" style="width: 16px; height: 16px; margin-right: 4px;"></i>
              Add with AI Intelligence
            </button>
            <button onclick="editEventDetails('${eventDetails.title}', '${eventDetails.date}', '${eventDetails.time}')" 
                    style="background: rgba(59, 130, 246, 0.3); border: 1px solid rgba(59, 130, 246, 0.6); border-radius: 8px; padding: 8px 16px; color: white; font-size: 14px; cursor: pointer;">
              <i data-lucide="edit" style="width: 16px; height: 16px;"></i>
            </button>
          </div>
        </div>
      `;
      
      // Re-initialize Lucide icons for new content
      setTimeout(() => lucide.createIcons(), 100);
    }
    
    function executeSmartCalendarAdd(title, date, time, duration, aiEnginesJson) {
      const messagesDiv = document.querySelector('.chat-messages-mobile');
      let aiEngines = [];
      
      try {
        aiEngines = JSON.parse(aiEnginesJson);
      } catch (e) {
        aiEngines = [];
      }
      
      // Add event with integrated intelligence
      addSmartEventToCalendar(title, date, time, duration, aiEngines);
      
      addSystemMessage(messagesDiv, `✅ Added "${title}" to calendar with AI intelligence`);
      
      // Show contextual intelligence preview
      setTimeout(() => {
        showEventIntelligencePreview(title, aiEngines, messagesDiv);
      }, 500);
    }
    
    function addSmartEventToCalendar(title, date, time, duration, aiEngines) {
      // Store event with AI engines in localStorage or send to backend
      const events = JSON.parse(localStorage.getItem('homeops_smart_events') || '[]');
      const eventId = 'event_' + Date.now();
      
      events.push({
        id: eventId,
        title,
        date,
        time,
        duration,
        aiEngines,
        created: new Date().toISOString()
      });
      
      localStorage.setItem('homeops_smart_events', JSON.stringify(events));
      
      // Refresh calendar view if visible
      const calendarView = document.getElementById('calendar-mobile');
      if (calendarView && calendarView.classList.contains('active')) {
        renderSmartCalendar();
      }
    }
    
    function showEventIntelligencePreview(title, aiEngines, messagesDiv) {
      if (aiEngines.length === 0) return;
      
      const previewCard = `
        <div style="background: rgba(139, 92, 246, 0.2); border: 1px solid rgba(139, 92, 246, 0.4); border-radius: 12px; padding: 16px; margin: 12px 0;">
          <div style="font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
            <i data-lucide="sparkles" style="width: 20px; height: 20px;"></i>
            <span>✨ AI Intelligence Preview</span>
          </div>
          
          ${aiEngines.map(engine => generateEnginePreview(engine, title)).join('')}
          
          <div style="display: flex; gap: 8px; margin-top: 16px;">
            <button onclick="showView('calendar-mobile', document.querySelector('.nav-btn[onclick*=\"calendar-mobile\"]'))" 
                    style="background: rgba(139, 92, 246, 0.3); border: 1px solid rgba(139, 92, 246, 0.6); border-radius: 8px; padding: 8px 16px; color: white; font-size: 14px; cursor: pointer; flex: 1;">
              <i data-lucide="calendar" style="width: 16px; height: 16px; margin-right: 4px;"></i>
              View in Calendar
            </button>
            <button onclick="activateEventIntelligence('${title}')" 
                    style="background: rgba(251, 191, 36, 0.3); border: 1px solid rgba(251, 191, 36, 0.6); border-radius: 8px; padding: 8px 16px; color: white; font-size: 14px; cursor: pointer;">
              <i data-lucide="brain" style="width: 16px; height: 16px;"></i>
              Full AI
            </button>
          </div>
        </div>
      `;
      
      messagesDiv.innerHTML += previewCard;
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
      
      setTimeout(() => {
        if (typeof lucide !== 'undefined') {
          lucide.createIcons();
        }
      }, 100);
    }
    
    function generateEnginePreview(engine, title) {
      switch (engine.type) {
        case 'commerce':
          return `
            <div style="background: rgba(251, 191, 36, 0.2); padding: 12px; border-radius: 8px; margin: 8px 0;">
              <div style="font-weight: 600; margin-bottom: 6px; display: flex; align-items: center; gap: 6px;">
                <span>${engine.icon}</span>
                <span>Commerce Intelligence</span>
              </div>
              <div style="font-size: 13px; line-height: 1.4;">
                🎁 Smart gift recommendations ready<br>
                💳 One-click purchasing available<br>
                📊 Based on purchase patterns & event context
              </div>
            </div>
          `;
        case 'life':
          return `
            <div style="background: rgba(139, 92, 246, 0.2); padding: 12px; border-radius: 8px; margin: 8px 0;">
              <div style="font-weight: 600; margin-bottom: 6px; display: flex; align-items: center; gap: 6px;">
                <span>${engine.icon}</span>
                <span>Life Intelligence</span>
              </div>
              <div style="font-size: 13px; line-height: 1.4;">
                🎯 Evidence-based frameworks ready<br>
                💡 Relationship & family guidance<br>
                ✅ Action protocols for complex situations
              </div>
            </div>
          `;
        case 'travel':
          return `
            <div style="background: rgba(59, 130, 246, 0.2); padding: 12px; border-radius: 8px; margin: 8px 0;">
              <div style="font-weight: 600; margin-bottom: 6px; display: flex; align-items: center; gap: 6px;">
                <span>${engine.icon}</span>
                <span>Travel Intelligence</span>
              </div>
              <div style="font-size: 13px; line-height: 1.4;">
                ✈️ Flight optimization & deals<br>
                🏨 Accommodation recommendations<br>
                📱 Real-time travel assistance
              </div>
            </div>
          `;
        case 'email':
          return `
            <div style="background: rgba(34, 197, 94, 0.2); padding: 12px; border-radius: 8px; margin: 8px 0;">
              <div style="font-weight: 600; margin-bottom: 6px; display: flex; align-items: center; gap: 6px;">
                <span>${engine.icon}</span>
                <span>Email Intelligence</span>
              </div>
              <div style="font-size: 13px; line-height: 1.4;">
                📧 Meeting prep from email context<br>
                🔍 Related communications surfaced<br>
                📊 Relationship & priority insights
              </div>
            </div>
          `;
        default:
          return '';
      }
    }
    
    function renderSmartCalendar() {
      const calendarDays = document.getElementById('calendar-days');
      if (!calendarDays) return;
      
      const events = JSON.parse(localStorage.getItem('homeops_smart_events') || '[]');
      const todayEventsList = document.getElementById('today-events-list');
      
      if (todayEventsList) {
        // Clear existing events
        todayEventsList.innerHTML = '';
        
        // Add smart events
        events.forEach(event => {
          const eventItem = document.createElement('div');
          eventItem.className = 'event-item';
          eventItem.style.cursor = 'pointer';
          eventItem.style.transition = 'background 0.2s';
          eventItem.onclick = () => viewSmartEventDetails(event);
          
          eventItem.innerHTML = `
            <div class="event-title">${event.title}</div>
            <div class="event-time">${event.date} ${event.time}</div>
            <div style="font-size: 11px; color: rgba(255,255,255,0.6); margin-top: 4px; display: flex; align-items: center; gap: 8px;">
              <div style="display: flex; align-items: center; gap: 2px;">
                <i data-lucide="brain" style="width: 10px; height: 10px;"></i>
                <span>AI Ready</span>
              </div>
              ${event.aiEngines ? event.aiEngines.map(engine => `<span>${engine.icon}</span>`).join('') : ''}
            </div>
          `;
          
          todayEventsList.appendChild(eventItem);
        });
        
        // Initialize Lucide icons
        setTimeout(() => {
          if (typeof lucide !== 'undefined') {
            lucide.createIcons();
          }
        }, 100);
      }
    }
    
    function viewSmartEventDetails(event) {
      const messagesDiv = document.querySelector('.chat-messages-mobile');
      
      messagesDiv.innerHTML += `
        <div style="background: rgba(139, 92, 246, 0.3); border: 1px solid rgba(139, 92, 246, 0.5); border-radius: 12px; padding: 16px; margin: 12px 0;">
          <div style="font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
            <i data-lucide="calendar-check" style="width: 20px; height: 20px;"></i>
            <span>📅 ${event.title}</span>
          </div>
          
          <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px; margin-bottom: 16px;">
            <div style="font-size: 14px; color: rgba(255,255,255,0.9); margin-bottom: 8px;">
              📅 ${event.date} at ${event.time}<br>
              ⌛ ${event.duration}
            </div>
          </div>
          
          <div style="margin-bottom: 16px;">
            <div style="font-weight: 600; margin-bottom: 8px;">🤖 Available AI Intelligence</div>
            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
              ${event.aiEngines ? event.aiEngines.map(engine => `
                <button onclick="activateEngineForEvent('${event.id}', '${engine.type}', '${event.title}')" 
                        style="background: ${engine.color}; border: 1px solid ${engine.color.replace('0.4', '0.6')}; border-radius: 8px; padding: 8px 12px; color: white; font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 4px;">
                  <span>${engine.icon}</span>
                  <span>${engine.name}</span>
                </button>
              `).join('') : ''}
            </div>
          </div>
          
          <div style="display: flex; gap: 8px;">
            <button onclick="editSmartEvent('${event.id}')" 
                    style="background: rgba(59, 130, 246, 0.3); border: 1px solid rgba(59, 130, 246, 0.6); border-radius: 8px; padding: 8px 16px; color: white; font-size: 14px; cursor: pointer;">
              <i data-lucide="edit" style="width: 16px; height: 16px; margin-right: 4px;"></i>
              Edit Event
            </button>
            <button onclick="deleteSmartEvent('${event.id}')" 
                    style="background: rgba(239, 68, 68, 0.3); border: 1px solid rgba(239, 68, 68, 0.6); border-radius: 8px; padding: 8px 16px; color: white; font-size: 14px; cursor: pointer;">
              <i data-lucide="trash" style="width: 16px; height: 16px; margin-right: 4px;"></i>
              Delete
            </button>
          </div>
        </div>
      `;
      
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
      
      setTimeout(() => {
        if (typeof lucide !== 'undefined') {
          lucide.createIcons();
        }
      }, 100);
    }
    
    function activateEngineForEvent(eventId, engineType, eventTitle) {
      const messagesDiv = document.querySelector('.chat-messages-mobile');
      
      switch (engineType) {
        case 'commerce':
          executeEventCommerceIntelligence(eventTitle, messagesDiv);
          break;
        case 'life':
          executeEventLifeIntelligence(eventTitle, messagesDiv);
          break;
        case 'travel':
          executeEventTravelIntelligence(eventTitle, messagesDiv);
          break;
        case 'email':
          executeEventEmailIntelligence(eventTitle, messagesDiv);
          break;
      }
    }
    
    function executeEventCommerceIntelligence(eventTitle, messagesDiv) {
      // Trigger commerce intelligence based on event context
      if (eventTitle.toLowerCase().includes('birthday')) {
        executeShoppingSearch(`gift for birthday party`, messagesDiv);
      } else if (eventTitle.toLowerCase().includes('anniversary')) {
        executeShoppingSearch(`$10k anniversary gift`, messagesDiv);
      } else {
        executeShoppingSearch(`gift for ${eventTitle}`, messagesDiv);
      }
    }
    
    function executeEventLifeIntelligence(eventTitle, messagesDiv) {
      // Generate contextual life intelligence
      const lifeIntelligenceCard = {
        analysis: `This ${eventTitle.toLowerCase()} represents an opportunity for deeper connection and meaningful presence.`,
        framework: "Attachment Theory + Family Systems",
        insights: [
          "Family dynamics often intensify during planned gatherings",
          "Your presence and attention matter more than perfect logistics",
          "Setting boundaries early prevents overwhelm later"
        ],
        action_steps: [
          "Clarify your role and expectations beforehand",
          "Plan transition time before and after the event",
          "Communicate your needs without over-explaining"
        ],
        reframe: "This isn't about managing everyone else's experience. It's about showing up authentically.",
        next_step: "Text or call to confirm one specific detail today"
      };
      
      messagesDiv.innerHTML += `
        <div style="background: rgba(139, 92, 246, 0.3); border: 1px solid rgba(139, 92, 246, 0.5); border-radius: 12px; padding: 16px; margin: 8px 0;">
          <div style="font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
            <i data-lucide="brain" style="width: 20px; height: 20px;"></i>
            <span>🧠 Life Intelligence for ${eventTitle}</span>
          </div>
          
          <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px; margin-bottom: 12px;">
            <div style="font-weight: 600; margin-bottom: 6px;">📊 Analysis</div>
            <div style="font-size: 14px; line-height: 1.4;">${lifeIntelligenceCard.analysis}</div>
            <div style="font-size: 12px; color: rgba(255,255,255,0.7); margin-top: 4px; font-style: italic;">Framework: ${lifeIntelligenceCard.framework}</div>
          </div>
          
          <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px; margin-bottom: 12px;">
            <div style="font-weight: 600; margin-bottom: 8px;">🎯 Evidence-Based Insights</div>
            ${lifeIntelligenceCard.insights.map(insight => `
              <div style="margin: 6px 0; font-size: 13px; line-height: 1.4; padding-left: 12px; border-left: 2px solid rgba(139, 92, 246, 0.6);">
                ${insight}
              </div>
            `).join('')}
          </div>
          
          <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px; margin-bottom: 12px;">
            <div style="font-weight: 600; margin-bottom: 8px;">✅ Action Protocol</div>
            ${lifeIntelligenceCard.action_steps.map((step, index) => `
              <div style="margin: 8px 0; font-size: 13px; line-height: 1.4; display: flex; gap: 8px;">
                <span style="background: rgba(139, 92, 246, 0.6); color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 600; flex-shrink: 0;">${index + 1}</span>
                <span>${step}</span>
              </div>
            `).join('')}
          </div>
          
          <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px; margin-bottom: 12px;">
            <div style="font-weight: 600; margin-bottom: 6px;">🔄 Reframe</div>
            <div style="font-size: 14px; line-height: 1.4; font-style: italic;">${lifeIntelligenceCard.reframe}</div>
          </div>
          
          <div style="background: rgba(34, 197, 94, 0.2); border: 1px solid rgba(34, 197, 94, 0.4); padding: 12px; border-radius: 8px; margin-top: 12px;">
            <div style="font-weight: 600; margin-bottom: 6px;">🚀 Next Step (Today)</div>
            <div style="font-size: 14px; line-height: 1.4;">${lifeIntelligenceCard.next_step}</div>
          </div>
        </div>
      `;
      
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
      setTimeout(() => {
        if (typeof lucide !== 'undefined') {
          lucide.createIcons();
        }
      }, 100);
    }
    
    function executeEventTravelIntelligence(eventTitle, messagesDiv) {
      executeFlightSearch(`flight for ${eventTitle}`, messagesDiv);
    }
    
    function executeEventEmailIntelligence(eventTitle, messagesDiv) {
      executeEmailSummary(`emails about ${eventTitle}`, messagesDiv);
    }
    
    // Missing functions that are being called
    function renderCalendar() {
      renderSmartCalendar();
      populateCalendarDays();
    }
    
    function populateCalendarDays() {
      const calendarDays = document.getElementById('calendar-days');
      if (!calendarDays) return;
      
      // Simple calendar population for July 2025
      const daysInMonth = 31;
      const startDay = 2; // July 1, 2025 starts on Tuesday
      
      calendarDays.innerHTML = '';
      
      // Add empty cells for days before month starts
      for (let i = 0; i < startDay; i++) {
        const emptyDay = document.createElement('div');
        emptyDay.style.padding = '12px 4px';
        emptyDay.style.background = 'rgba(255,255,255,0.05)';
        calendarDays.appendChild(emptyDay);
      }
      
      // Add actual days
      for (let day = 1; day <= daysInMonth; day++) {
        const dayElement = document.createElement('div');
        dayElement.style.padding = '12px 4px';
        dayElement.style.background = 'rgba(255,255,255,0.05)';
        dayElement.style.textAlign = 'center';
        dayElement.style.cursor = 'pointer';
        dayElement.style.transition = 'background 0.2s';
        dayElement.style.fontSize = '14px';
        dayElement.textContent = day;
        
        // Highlight today (July 15)
        if (day === 15) {
          dayElement.style.background = 'rgba(59, 130, 246, 0.4)';
          dayElement.style.fontWeight = '600';
        }
        
        dayElement.onclick = () => selectCalendarDay(day);
        
        calendarDays.appendChild(dayElement);
      }
    }
    
    function selectCalendarDay(day) {
      const messagesDiv = document.querySelector('.chat-messages-mobile');
      showView('chat-mobile', document.querySelector('.nav-btn[onclick*="chat-mobile"]'));
      
      setTimeout(() => {
        messagesDiv.innerHTML += `
          <div style="background: rgba(59, 130, 246, 0.3); border: 1px solid rgba(59, 130, 246, 0.5); border-radius: 12px; padding: 16px; margin: 12px 0;">
            <div style="font-weight: 600; margin-bottom: 12px;">📅 Quick Add Event - July ${day}</div>
            <input type="text" placeholder="What's happening on July ${day}?" 
                   style="width: 100%; padding: 8px 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white;"
                   onkeypress="if(event.key==='Enter') addEventFromInput(this.value, 'July ${day}')">
            <button onclick="addEventFromInput(document.querySelector('input[placeholder*=\"July ${day}\"]').value, 'July ${day}')" 
                    style="background: rgba(34, 197, 94, 0.4); border: 1px solid rgba(34, 197, 94, 0.6); border-radius: 8px; padding: 8px 16px; color: white; margin-top: 8px; cursor: pointer;">
              Add Event
            </button>
          </div>
        `;
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }, 100);
    }
    
    function addEventFromInput(eventText, date) {
      if (!eventText.trim()) return;
      executeCalendarInjection(`I have ${eventText} on ${date}`, document.querySelector('.chat-messages-mobile'));
    }
    
    function executeCalendarView(messagesDiv) {
      const events = JSON.parse(localStorage.getItem('homeops_smart_events') || '[]');
      
      messagesDiv.innerHTML += `
        <div style="background: rgba(59, 130, 246, 0.2); border: 1px solid rgba(59, 130, 246, 0.4); border-radius: 12px; padding: 16px; margin: 12px 0;">
          <div style="font-weight: 600; margin-bottom: 12px;">📅 Your Schedule</div>
          ${events.length > 0 ? events.map(event => `
            <div style="background: rgba(255,255,255,0.1); padding: 8px; border-radius: 6px; margin: 6px 0;">
              <div style="font-weight: 600;">${event.title}</div>
              <div style="font-size: 12px; color: rgba(255,255,255,0.7);">${event.date} at ${event.time}</div>
            </div>
          `).join('') : '<div style="color: rgba(255,255,255,0.7);">No events scheduled</div>'}
          <button onclick="showView('calendar-mobile', document.querySelector('.nav-btn[onclick*=\"calendar-mobile\"]'))" 
                  style="background: rgba(59, 130, 246, 0.3); border: 1px solid rgba(59, 130, 246, 0.6); border-radius: 8px; padding: 8px 16px; color: white; margin-top: 8px; cursor: pointer;">
            View Full Calendar
          </button>
        </div>
      `;
      
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
    
    function executeEmailSummary(message, messagesDiv) {
      addSystemMessage(messagesDiv, "📧 Analyzing your emails...");
      
      setTimeout(() => {
        messagesDiv.innerHTML += `
          <div style="background: rgba(34, 197, 94, 0.2); border: 1px solid rgba(34, 197, 94, 0.4); border-radius: 12px; padding: 16px; margin: 12px 0;">
            <div style="font-weight: 600; margin-bottom: 12px;">📧 Email Intelligence Summary</div>
            <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px; margin-bottom: 12px;">
              <div style="font-weight: 600; margin-bottom: 8px;">This Week's Mental Load</div>
              <div style="font-size: 14px; line-height: 1.4;">
                Found 3 school emails requiring action, 1 urgent birthday party RSVP, and 2 subscription renewals to review.
                The Jefferson Elementary spirit week email needs pajama prep for tomorrow.
              </div>
            </div>
            <button onclick="showView('email-mobile', document.querySelector('.nav-btn[onclick*=\"email-mobile\"]'))" 
                    style="background: rgba(34, 197, 94, 0.3); border: 1px solid rgba(34, 197, 94, 0.6); border-radius: 8px; padding: 8px 16px; color: white; cursor: pointer;">
              View Full Email Intelligence
            </button>
          </div>
        `;
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }, 1500);
    }
    
    function executeEmailSurfacing(messagesDiv) {
      executeEmailSummary("show emails", messagesDiv);
    }
    
    function executeDealIntelligence(message, messagesDiv) {
      addSystemMessage(messagesDiv, "💰 Scanning for real deals...");
      
      setTimeout(() => {
        messagesDiv.innerHTML += `
          <div style="background: rgba(251, 191, 36, 0.2); border: 1px solid rgba(251, 191, 36, 0.4); border-radius: 12px; padding: 16px; margin: 12px 0;">
            <div style="font-weight: 600; margin-bottom: 12px;">💰 Deal Intelligence</div>
            <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px; margin-bottom: 12px;">
              <div style="font-weight: 600; margin-bottom: 8px;">Real Deals Found</div>
              <div style="margin: 6px 0;">
                <div style="font-weight: 600;">Target: 25% off kids clothes</div>
                <div style="font-size: 12px; color: rgba(255,255,255,0.7);">Actually good deal - back to school season</div>
              </div>
            </div>
            <div style="font-size: 12px; color: rgba(255,255,255,0.6); font-style: italic;">
              🧠 HomeOps filters out 89% of "deals" as marketing manipulation
            </div>
          </div>
        `;
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }, 1000);
    }
    
    function executeWeekPlanning(messagesDiv) {
      addSystemMessage(messagesDiv, "📋 Planning your week...");
      
      setTimeout(() => {
        messagesDiv.innerHTML += `
          <div style="background: rgba(139, 92, 246, 0.2); border: 1px solid rgba(139, 92, 246, 0.4); border-radius: 12px; padding: 16px; margin: 12px 0;">
            <div style="font-weight: 600; margin-bottom: 12px;">📋 Week Planning</div>
            <div style="font-size: 14px; line-height: 1.4;">
              This week: RSVP for Emma's birthday party (due Thursday), prep for Pajama Day (tomorrow), 
              and schedule that dentist appointment you've been putting off.
            </div>
            <div style="display: flex; gap: 8px; margin-top: 12px;">
              <button onclick="showView('calendar-mobile', document.querySelector('.nav-btn[onclick*=\"calendar-mobile\"]'))" 
                      style="background: rgba(139, 92, 246, 0.3); border: 1px solid rgba(139, 92, 246, 0.6); border-radius: 8px; padding: 8px 16px; color: white; cursor: pointer; flex: 1;">
                View Calendar
              </button>
              <button onclick="showView('email-mobile', document.querySelector('.nav-btn[onclick*=\"email-mobile\"]'))" 
                      style="background: rgba(34, 197, 94, 0.3); border: 1px solid rgba(34, 197, 94, 0.6); border-radius: 8px; padding: 8px 16px; color: white; cursor: pointer; flex: 1;">
                Check Emails
              </button>
            </div>
          </div>
        `;
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }, 1000);
    }
    
    function executeShoppingAssistant(message, messagesDiv) {
      executeShoppingSearch(message, messagesDiv);
    }
    
    function executeCommunicationReminder(message, messagesDiv) {
      addSystemMessage(messagesDiv, "📞 Setting communication reminder...");
      
      setTimeout(() => {
        messagesDiv.innerHTML += `
          <div style="background: rgba(59, 130, 246, 0.2); border: 1px solid rgba(59, 130, 246, 0.4); border-radius: 12px; padding: 16px; margin: 12px 0;">
            <div style="font-weight: 600; margin-bottom: 8px;">📞 Communication Reminder Set</div>
            <div style="font-size: 14px;">I'll remind you to make that call. Check your tasks.</div>
          </div>
        `;
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }, 500);
    }
    
    function executeWellnessTracking(message, messagesDiv) {
      addSystemMessage(messagesDiv, "💪 Tracking wellness...");
      
      setTimeout(() => {
        messagesDiv.innerHTML += `
          <div style="background: rgba(34, 197, 94, 0.2); border: 1px solid rgba(34, 197, 94, 0.4); border-radius: 12px; padding: 16px; margin: 12px 0;">
            <div style="font-weight: 600; margin-bottom: 8px;">💪 Wellness Tracking</div>
            <div style="font-size: 14px;">Logged! Stay hydrated and keep moving.</div>
          </div>
        `;
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }, 500);
    }
    
    function executeFinancialTracking(message, messagesDiv) {
      addSystemMessage(messagesDiv, "💰 Analyzing spending...");
      
      setTimeout(() => {
        messagesDiv.innerHTML += `
          <div style="background: rgba(251, 191, 36, 0.2); border: 1px solid rgba(251, 191, 36, 0.4); border-radius: 12px; padding: 16px; margin: 12px 0;">
            <div style="font-weight: 600; margin-bottom: 8px;">💰 Financial Tracking</div>
            <div style="font-size: 14px;">This month: $342 on groceries, $89 on kids activities. On track with budget.</div>
          </div>
        `;
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }, 500);
    }
    
    // Placeholder task management functions
    function markTaskComplete(button) {
      button.closest('div').style.opacity = '0.5';
      button.innerHTML = '✅ Done';
      button.disabled = true;
    }
    
    function editTask(button) {
      alert('Task editing - coming soon!');
    }
    
    function snoozeTask(button) {
      alert('Task snoozed for 1 hour');
      button.style.opacity = '0.5';
    }
    
    // Initialize app on load
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize Lucide icons
      if (typeof lucide !== 'undefined') {
        lucide.createIcons();
      }
      
      // Initialize default view
      showView('chat-mobile', document.querySelector('.nav-btn.active'));
      
      // Initialize textarea auto-resize
      const chatInput = document.getElementById('chatInput');
      if (chatInput) {
        chatInput.addEventListener('input', function() {
          this.style.height = 'auto';
          this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });
        
        chatInput.addEventListener('keypress', function(e) {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
          }
        });
      }
    });

    // ...existing code...
  </script>
</body>
</html>
