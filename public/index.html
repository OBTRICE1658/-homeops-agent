<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>HomeOps - Mobile</title>
  
  <!-- Mobile-First CSS -->
  <style>
    /* MOBILE-FIRST RESET */
    :root {
      --vh: 1vh;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      height: 100vh;
      /* iOS viewport units fix */
      height: 100dvh;
      overflow: hidden;
      touch-action: manipulation;
      /* Prevent zoom on input focus */
      -webkit-text-size-adjust: 100%;
    }
    
    /* MOBILE APP LAYOUT */
    .mobile-app {
      height: 100vh;
      height: calc(var(--vh, 1vh) * 100); /* Use custom property for iOS */
      display: flex;
      flex-direction: column;
      position: relative;
    }
    
    /* TOP HEADER */
    .mobile-header {
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      padding: 12px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      min-height: 60px;
    }
    
    .logo {
      font-size: 24px;
      font-weight: 700;
      color: white;
    }
    
    /* MAIN CONTENT AREA */
    .mobile-content {
      flex: 1;
      overflow: hidden;
      position: relative;
      /* Add padding for fixed navigation */
      padding-bottom: 70px;
    }
    
    .mobile-view {
      display: none;
      height: 100%;
      padding: 20px;
      overflow-y: auto;
    }
    
    .mobile-view.active {
      display: block !important;
    }
    
    /* BOTTOM NAVIGATION */
    .mobile-nav {
      background: rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(20px);
      display: flex;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      padding: 8px 0;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      /* Ensure it stays visible with virtual keyboard */
      min-height: 70px;
    }
    
    .nav-btn {
      flex: 1;
      background: none;
      border: none;
      color: #666;
      padding: 12px 8px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
      min-height: 60px;
    }
    
    .nav-btn.active {
      color: #fff;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      margin: 4px;
    }
    
    .nav-btn:active {
      transform: scale(0.95);
      background: rgba(255, 255, 255, 0.1);
    }
    
    .nav-icon {
      width: 24px;
      height: 24px;
      margin-bottom: 2px;
    }
    
    /* CHAT VIEW */
    #chat-mobile {
      display: flex;
      flex-direction: column;
      height: 100%;
      /* Ensure proper spacing with fixed nav */
      padding-bottom: 10px;
    }
    
    .chat-messages-mobile {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      margin-bottom: 16px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      /* Ensure scrollable area doesn't get cut off */
      min-height: 200px;
      max-height: calc(100vh - 280px);
    }
    
    .chat-input-mobile {
      display: flex;
      gap: 12px;
      align-items: center;
      /* Ensure input area is always visible */
      position: sticky;
      bottom: 0;
      background: inherit;
      padding-top: 8px;
    }
    
    .mobile-input {
      flex: 1;
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(10px);
      border: 2px solid rgba(255, 255, 255, 0.2);
      border-radius: 25px;
      padding: 12px 16px;
      color: white;
      font-size: 16px;
      outline: none;
    }
    
    .mobile-input::placeholder {
      color: rgba(255, 255, 255, 0.6);
    }
    
    .mobile-input:focus {
      border-color: rgba(255, 255, 255, 0.4);
      background: rgba(255, 255, 255, 0.2);
    }
    
    .send-btn {
      background: rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      width: 48px;
      height: 48px;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    
    .send-btn:active {
      transform: scale(0.95);
      background: rgba(255, 255, 255, 0.4);
    }
    
    /* EMAIL DECODER VIEW */
    .email-section {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      padding: 20px;
      margin-bottom: 16px;
    }
    
    .section-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 12px;
      color: #fff;
    }
    
    .mobile-textarea {
      width: 100%;
      background: rgba(255, 255, 255, 0.1);
      border: 2px solid rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      padding: 16px;
      color: white;
      font-size: 16px;
      min-height: 120px;
      resize: vertical;
      outline: none;
      font-family: inherit;
    }
    
    .mobile-textarea::placeholder {
      color: rgba(255, 255, 255, 0.6);
    }
    
    .mobile-textarea:focus {
      border-color: rgba(255, 255, 255, 0.4);
      background: rgba(255, 255, 255, 0.15);
    }
    
    .decode-btn-mobile {
      width: 100%;
      background: rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 12px;
      padding: 16px;
      color: white;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 16px;
      transition: all 0.2s;
    }
    
    .decode-btn-mobile:active {
      transform: scale(0.98);
      background: rgba(255, 255, 255, 0.4);
    }
    
    /* CALENDAR VIEW */
    .calendar-section {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      padding: 20px;
      margin-bottom: 16px;
    }
    
    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    
    .month-nav {
      background: rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      padding: 8px 12px;
      color: white;
      cursor: pointer;
    }
    
    .events-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .event-item {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      padding: 16px;
      border-left: 4px solid rgba(255, 255, 255, 0.6);
    }
    
    .event-title {
      font-weight: 600;
      margin-bottom: 4px;
    }
    
    .event-time {
      color: #888;
      font-size: 14px;
    }
    
    /* LOADING STATE */
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 40px;
      color: #666;
    }
    
    /* SUCCESS/ERROR STATES */
    .success {
      background: rgba(5, 150, 105, 0.3);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(5, 150, 105, 0.5);
      border-radius: 8px;
      padding: 12px 16px;
      margin: 12px 0;
      font-size: 14px;
    }
    
    .error {
      background: rgba(220, 38, 38, 0.3);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(220, 38, 38, 0.5);
      border-radius: 8px;
      padding: 12px 16px;
      margin: 12px 0;
      font-size: 14px;
    }
    
    /* MOBILE EMAIL INTELLIGENCE STYLES */
    .intel-tab {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 25px;
      padding: 8px 12px;
      color: rgba(255, 255, 255, 0.7);
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .intel-tab.active {
      background: rgba(255, 255, 255, 0.3);
      color: white;
      border-color: rgba(255, 255, 255, 0.4);
      transform: scale(1.05);
    }
    
    .translated-emails-mobile {
      max-height: 400px;
      overflow-y: auto;
    }
    
    .email-insight-card {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 16px;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }
    
    .email-insight-card:active {
      transform: scale(0.98);
      background: rgba(255, 255, 255, 0.15);
    }
    
    .insight-priority {
      position: absolute;
      top: 12px;
      right: 12px;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }
    
    .priority-high {
      background: rgba(239, 68, 68, 0.3);
      color: #fca5a5;
    }
    
    .priority-medium {
      background: rgba(251, 191, 36, 0.3);
      color: #fcd34d;
    }
    
    .priority-low {
      background: rgba(34, 197, 94, 0.3);
      color: #86efac;
    }
    
    .ai-translation {
      background: rgba(139, 92, 246, 0.2);
      border-left: 3px solid rgba(139, 92, 246, 0.8);
      border-radius: 8px;
      padding: 12px;
      margin: 12px 0;
      font-style: italic;
      color: rgba(255, 255, 255, 0.9);
    }
    
    .commerce-intel {
      background: rgba(16, 185, 129, 0.2);
      border-left: 3px solid rgba(16, 185, 129, 0.8);
      border-radius: 8px;
      padding: 12px;
      margin: 12px 0;
    }
    
    .brand-loyalty {
      display: inline-block;
      background: rgba(59, 130, 246, 0.3);
      color: #93c5fd;
      padding: 2px 6px;
      border-radius: 8px;
      font-size: 11px;
      margin-right: 4px;
    }
    
    .email-subject {
      font-weight: 600;
      margin-bottom: 8px;
      color: white;
      font-size: 16px;
    }
    
    .email-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
      color: rgba(255, 255, 255, 0.6);
      margin-bottom: 12px;
    }
    
    .email-category {
      background: rgba(255, 255, 255, 0.2);
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
    }
    
    .email-preview {
      font-size: 14px;
      color: rgba(255, 255, 255, 0.8);
      line-height: 1.4;
    }
    
    /* CALENDAR STYLES */
    .day-header {
      background: rgba(255, 255, 255, 0.2);
      color: rgba(255, 255, 255, 0.8);
      text-align: center;
      padding: 12px 4px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .calendar-day {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .calendar-day:hover {
      background: rgba(255, 255, 255, 0.1);
    }
    
    .calendar-day.today {
      background: rgba(255, 255, 255, 0.3);
      font-weight: bold;
      color: #fff;
    }
    
    .calendar-day.other-month {
      color: rgba(255, 255, 255, 0.3);
    }
    
    .calendar-day.has-events {
      background: rgba(255, 255, 255, 0.2);
      position: relative;
    }
    
    .calendar-day.has-events::after {
      content: '';
      position: absolute;
      bottom: 2px;
      left: 50%;
      transform: translateX(-50%);
      width: 4px;
      height: 4px;
      background: rgba(255, 255, 255, 0.8);
      border-radius: 50%;
    }
    
    .today-events {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 16px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    /* TYPING ANIMATION */
    .typing-dots {
      display: inline-flex;
      gap: 2px;
    }
    
    .typing-dots span {
      animation: typing 1.4s infinite;
      animation-fill-mode: both;
    }
    
    .typing-dots span:nth-child(2) {
      animation-delay: 0.2s;
    }
    
    .typing-dots span:nth-child(3) {
      animation-delay: 0.4s;
    }
    
    @keyframes typing {
      0%, 60%, 100% {
        transform: translateY(0);
        opacity: 0.4;
      }
      30% {
        transform: translateY(-10px);
        opacity: 1;
      }
    }
  </style>
</head>
<body>
  <div class="mobile-app">
    <!-- Header -->
    <div class="mobile-header">
      <div class="logo">HomeOps</div>
      <div style="font-size: 14px; color: rgba(255,255,255,0.8);">Works!</div>
    </div>
    
    <!-- Content Area -->
    <div class="mobile-content">
      <!-- Chat View -->
      <div id="chat-mobile" class="mobile-view active">
        <div class="chat-messages-mobile">
          <div style="padding: 20px; text-align: center; color: rgba(255,255,255,0.8);">
            👋 Hi! I'm your HomeOps agent.<br><br>
            I'm wired to your personal tone model and can help with productivity, email decoding, and calendar management.<br><br>
            <em>Ask me anything...</em>
          </div>
        </div>
        <div class="chat-input-mobile">
          <input type="text" class="mobile-input" placeholder="Type your message..." id="chatInput">
          <button class="send-btn" onclick="sendMessage()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="22" y1="2" x2="11" y2="13"></line>
              <polygon points="22,2 15,22 11,13 2,9"></polygon>
            </svg>
          </button>
        </div>
      </div>
      
      <!-- Email Decoder View -->
      <div id="email-mobile" class="mobile-view">
        <!-- AI Chief of Staff Header -->
        <div class="chief-of-staff-header" style="background: rgba(255,255,255,0.15); border-radius: 20px; padding: 20px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.2);">
          <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
            <div style="width: 48px; height: 48px; background: rgba(255,255,255,0.3); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px;">🧠</div>
            <div>
              <div style="font-weight: 700; font-size: 18px;">Your AI Chief of Staff</div>
              <div style="font-size: 14px; color: rgba(255,255,255,0.8);">Translating noise into clarity</div>
            </div>
          </div>
          <div id="chief-insights" style="font-style: italic; color: rgba(255,255,255,0.9); line-height: 1.4;">
            "I'm scanning your inbox right now. Let me surface what actually matters to your family and work life."
          </div>
        </div>

        <!-- Gmail Connection Status -->
        <div id="gmail-status" class="email-section">
          <div class="section-title">📧 Inbox Intelligence Engine</div>
          <div id="connection-status" style="padding: 16px; border-radius: 12px; margin-bottom: 16px; background: rgba(255,193,7,0.2); border: 1px solid rgba(255,193,7,0.3);">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
              <div class="typing-dots">
                <span>.</span><span>.</span><span>.</span>
              </div>
              <span>Checking Gmail connection...</span>
            </div>
          </div>
          
          <!-- Connect Gmail Button -->
          <button id="connect-gmail-mobile" class="decode-btn-mobile" onclick="connectGmailMobile()" style="display: none;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px;">
              <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
              <polyline points="22,6 12,13 2,6"></polyline>
            </svg>
            Connect Gmail to Start Intelligence
          </button>
          
          <!-- Process Emails Button -->
          <button id="process-emails-mobile" class="decode-btn-mobile" onclick="processEmailsMobile()" style="display: none;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px;">
              <circle cx="12" cy="12" r="3"></circle>
              <path d="M12 1v6m0 6v6m11-7h-6m-6 0H1"></path>
            </svg>
            Scan & Translate Latest Emails
          </button>
          
          <!-- Intelligence Categories -->
          <div id="email-categories" style="display: none;">
            <div class="intelligence-tabs" style="display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap;">
              <button class="intel-tab active" data-category="all" onclick="showIntelCategory('all', this)">
                <span>📋</span> All Insights
              </button>
              <button class="intel-tab" data-category="urgent" onclick="showIntelCategory('urgent', this)">
                <span>⚡</span> Urgent
              </button>
              <button class="intel-tab" data-category="family" onclick="showIntelCategory('family', this)">
                <span>👨‍👩‍👧‍👦</span> Family
              </button>
              <button class="intel-tab" data-category="commerce" onclick="showIntelCategory('commerce', this)">
                <span>🛍️</span> Commerce Intel
              </button>
              <button class="intel-tab" data-category="schedule" onclick="showIntelCategory('schedule', this)">
                <span>📅</span> Schedule
              </button>
            </div>
            
            <!-- AI-Translated Emails -->
            <div id="translated-emails-mobile" class="translated-emails-mobile">
              <!-- Dynamic content goes here -->
            </div>
          </div>
          
          <!-- Processing Status -->
          <div id="processing-status" style="display: none; text-align: center; padding: 20px;">
            <div class="typing-dots" style="margin-bottom: 10px;">
              <span>.</span><span>.</span><span>.</span>
            </div>
            <div id="processing-message">Your AI Chief of Staff is reading...</div>
          </div>
        </div>
      </div>
      
      <!-- Calendar View -->
      <div id="calendar-mobile" class="mobile-view">
        <div class="calendar-section">
          <div class="calendar-header">
            <button class="month-nav" onclick="changeMonth(-1)">‹</button>
            <div class="section-title" id="current-month">📅 July 2025</div>
            <button class="month-nav" onclick="changeMonth(1)">›</button>
          </div>
          
          <!-- Calendar Grid -->
          <div class="calendar-grid" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: rgba(255,255,255,0.1); border-radius: 12px; overflow: hidden; margin-bottom: 20px;">
            <!-- Day headers -->
            <div class="day-header">S</div>
            <div class="day-header">M</div>
            <div class="day-header">T</div>
            <div class="day-header">W</div>
            <div class="day-header">T</div>
            <div class="day-header">F</div>
            <div class="day-header">S</div>
            
            <!-- Calendar days (will be populated by JS) -->
            <div id="calendar-days" style="display: contents;">
              <!-- JS will populate calendar days here -->
            </div>
          </div>
          
          <!-- Today's Events -->
          <div class="today-events">
            <div style="font-weight: 600; margin-bottom: 12px; color: #fff;">Today's Schedule</div>
            <div class="events-list" id="today-events-list">
              <div class="event-item">
                <div class="event-title">Team Standup</div>
                <div class="event-time">2:00 PM - 2:30 PM</div>
              </div>
              <div class="event-item">
                <div class="event-title">Pick up groceries</div>
                <div class="event-time">5:00 PM</div>
              </div>
            </div>
          </div>
          
          <!-- Add Event Quick Button -->
          <button class="decode-btn-mobile" onclick="addEventMobile()" style="margin-top: 16px;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px;">
              <line x1="12" y1="5" x2="12" y2="19"></line>
              <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            Quick Add Event
          </button>
        </div>
      </div>
    </div>
    
    <!-- Bottom Navigation -->
    <div class="mobile-nav">
      <button class="nav-btn active" onclick="showView('chat-mobile', this)">
        <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"></path>
        </svg>
        Chat
      </button>
      <button class="nav-btn" onclick="showView('email-mobile', this)">
        <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
          <polyline points="22,6 12,13 2,6"></polyline>
        </svg>
        Email
      </button>
      <button class="nav-btn" onclick="showView('calendar-mobile', this)">
        <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
          <line x1="16" y1="2" x2="16" y2="6"></line>
          <line x1="8" y1="2" x2="8" y2="6"></line>
          <line x1="3" y1="10" x2="21" y2="10"></line>
        </svg>
        Calendar
      </button>
    </div>
  </div>
  
  <script>
    // Mobile-First JavaScript
    function showView(viewId, button) {
      console.log('Switching to view:', viewId);
      
      // Hide all views immediately
      document.querySelectorAll('.mobile-view').forEach(view => {
        view.classList.remove('active');
        view.style.display = 'none';
      });
      
      // Remove active from all nav buttons
      document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      
      // Show selected view immediately
      const targetView = document.getElementById(viewId);
      if (targetView) {
        targetView.style.display = 'block';
        targetView.classList.add('active');
        
        // Initialize view-specific content
        if (viewId === 'email-mobile') {
          initializeEmailView();
        } else if (viewId === 'calendar-mobile') {
          initializeCalendarView();
        }
      }
      
      button.classList.add('active');
      
      // Haptic feedback
      if (navigator.vibrate) {
        navigator.vibrate(10);
      }
    }
    
    function initializeEmailView() {
      console.log('Initializing email view...');
      if (!document.getElementById('gmail-status').querySelector('.typing-dots')) {
        checkGmailConnection();
      }
    }
    
    function initializeCalendarView() {
      console.log('Initializing calendar view...');
      if (!document.getElementById('calendar-days').innerHTML) {
        renderCalendar();
      }
    }
    
    function sendMessage() {
      const input = document.getElementById('chatInput');
      const message = input.value.trim();
      
      if (!message) return;
      
      const messagesDiv = document.querySelector('.chat-messages-mobile');
      
      // Add user message with better styling
      messagesDiv.innerHTML += `
        <div style="padding: 12px 20px; background: rgba(255,255,255,0.3); backdrop-filter: blur(10px); margin: 8px 0; border-radius: 18px 18px 4px 18px; max-width: 85%; margin-left: auto; border: 1px solid rgba(255,255,255,0.2);">
          ${message}
        </div>
      `;
      
      input.value = '';
      
      // Add typing indicator
      messagesDiv.innerHTML += `
        <div id="typing-indicator" style="padding: 12px 20px; background: rgba(255,255,255,0.1); margin: 8px 0; border-radius: 18px 18px 18px 4px; max-width: 85%; border: 1px solid rgba(255,255,255,0.1);">
          <div style="display: flex; align-items: center; gap: 8px; color: rgba(255,255,255,0.7);">
            <div class="typing-dots">
              <span>.</span><span>.</span><span>.</span>
            </div>
            HomeOps is thinking...
          </div>
        </div>
      `;
      
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
      
      // Call your actual AI backend
      callHomeOpsAI(message).then(response => {
        const typingEl = document.getElementById('typing-indicator');
        if (typingEl) {
          typingEl.innerHTML = response;
          typingEl.style.background = 'rgba(255,255,255,0.1)';
          typingEl.style.color = 'white';
          typingEl.removeAttribute('id');
        }
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }).catch(error => {
        console.error('AI Error:', error);
        const typingEl = document.getElementById('typing-indicator');
        if (typingEl) {
          typingEl.innerHTML = "I'm having trouble connecting right now. Your tone-aware AI model will be back online shortly!";
          typingEl.style.background = 'rgba(255,200,100,0.2)';
          typingEl.removeAttribute('id');
        }
      });
    }
    
    // Mobile Email Decoder Functions
    let currentUserId = null;
    let currentCategory = 'all';
    let decodedEmails = [];
    let currentDate = new Date();
    
    // Initialize on load
    window.addEventListener('DOMContentLoaded', function() {
      console.log('🚀 Mobile app initializing...');
      
      // Force show chat view initially
      const chatView = document.getElementById('chat-mobile');
      const chatBtn = document.querySelector('.nav-btn[onclick*="chat-mobile"]');
      
      if (chatView && chatBtn) {
        showView('chat-mobile', chatBtn);
      }
      
      // Handle virtual keyboard visibility
      setupKeyboardHandling();
      
      // Initialize other components
      setTimeout(() => {
        checkGmailConnection();
        renderCalendar();
      }, 500);
    });
    
    function setupKeyboardHandling() {
      // iOS viewport height adjustment for virtual keyboard
      function setViewportHeight() {
        const vh = window.innerHeight * 0.01;
        document.documentElement.style.setProperty('--vh', `${vh}px`);
      }
      
      setViewportHeight();
      window.addEventListener('resize', setViewportHeight);
      
      // Handle input focus/blur for better UX
      const chatInput = document.getElementById('chatInput');
      if (chatInput) {
        chatInput.addEventListener('focus', function() {
          // Scroll to input when focused
          setTimeout(() => {
            this.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }, 300);
        });
        
        chatInput.addEventListener('blur', function() {
          // Scroll back to show messages when done typing
          setTimeout(() => {
            const messagesDiv = document.querySelector('.chat-messages-mobile');
            if (messagesDiv) {
              messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }
          }, 100);
        });
      }
    }
    
    async function checkGmailConnection() {
      const statusEl = document.getElementById('connection-status');
      const connectBtn = document.getElementById('connect-gmail-mobile');
      const processBtn = document.getElementById('process-emails-mobile');
      
      if (!statusEl) {
        console.warn('Gmail status element not found');
        return;
      }
      
      // Show loading state
      statusEl.innerHTML = `
        <div style="display: flex; align-items: center; gap: 8px; color: rgba(255,255,255,0.7);">
          <div class="typing-dots">
            <span>.</span><span>.</span><span>.</span>
          </div>
          <span>Checking Gmail connection...</span>
        </div>
      `;
      
      try {
        const response = await fetch('/api/auth/status');
        const data = await response.json();
        
        if (data.authenticated && data.user_id) {
          currentUserId = data.user_id;
          statusEl.innerHTML = `
            <div style="color: rgba(34, 197, 94, 1); display: flex; align-items: center; gap: 8px;">
              <span>✅</span>
              <span>Gmail connected (${data.email || 'Unknown'})</span>
            </div>
          `;
          if (connectBtn) connectBtn.style.display = 'none';
          if (processBtn) processBtn.style.display = 'block';
          
          // Auto-load recent emails if available
          loadRecentEmails();
        } else {
          statusEl.innerHTML = `
            <div style="color: rgba(251, 191, 36, 1); display: flex; align-items: center; gap: 8px;">
              <span>⚠️</span>
              <span>Gmail not connected - Click below to connect</span>
            </div>
          `;
          if (connectBtn) connectBtn.style.display = 'block';
          if (processBtn) processBtn.style.display = 'none';
        }
      } catch (error) {
        console.error('Connection check failed:', error);
        statusEl.innerHTML = `
          <div style="color: rgba(239, 68, 68, 1); display: flex; align-items: center; gap: 8px;">
            <span>❌</span>
            <span>Connection check failed - Using demo mode</span>
          </div>
        `;
        if (connectBtn) connectBtn.style.display = 'block';
        if (processBtn) processBtn.style.display = 'none';
        
        // Show demo emails
        showDemoEmails();
      }
    }
    
    function showDemoEmails() {
      const emailCategories = document.getElementById('email-categories');
      if (emailCategories) {
        emailCategories.style.display = 'block';
        
        // Sophisticated demo email intelligence
        decodedEmails = [
          {
            id: 'demo1',
            subject: 'Soccer practice moved to 4pm',
            sender: 'Coach Sarah',
            category: 'family',
            priority: 'medium',
            preview: 'Hi parents, due to field maintenance...',
            summary: 'Schedule change for kids activity',
            ai_translation: "Your chief of staff says: This isn't just a schedule change—it's a ripple effect. The 4pm time means pickup conflicts with your Tuesday meetings. I've noted this for calendar optimization.",
            action_items: ['Update calendar', 'Arrange carpool backup', 'Inform spouse of time change']
          },
          {
            id: 'demo2', 
            subject: 'URGENT: Project deadline moved up',
            sender: 'Project Manager',
            category: 'urgent',
            priority: 'high',
            preview: 'The client wants to move the launch date...',
            summary: 'Work deadline change requiring immediate attention',
            ai_translation: "Red flag detected: This 'urgent' request sounds like poor planning disguised as client demands. Your energy is being hijacked. What's the real deadline vs. their panic?",
            action_items: ['Clarify actual vs. artificial urgency', 'Assess resource impact', 'Set boundaries on scope']
          },
          {
            id: 'demo3',
            subject: 'Your Patagonia order is ready for pickup',
            sender: 'Patagonia',
            category: 'commerce',
            priority: 'low',
            preview: 'Your sustainable outdoor gear awaits...',
            summary: 'Brand purchase confirmation from trusted retailer',
            ai_translation: "Smart purchase detected: Patagonia aligns with your values-based spending. Your loyalty score with this brand is 9/10.",
            commerce_intel: {
              brand_loyalty: 'High',
              purchase_pattern: 'Seasonal outdoor gear',
              recommendation: 'Consider their repair program instead of new purchases',
              similar_brands: ['REI Co-op', 'Eileen Fisher', 'Allbirds']
            }
          },
          {
            id: 'demo4',
            subject: 'Parent-Teacher Conference Available Times',
            sender: 'Lincoln Elementary',
            category: 'family',
            priority: 'medium',
            preview: 'Please select your preferred time slot...',
            summary: 'School scheduling requiring parent response',
            ai_translation: "Subtext: This is a bid for your attention disguised as scheduling. Your presence matters more than the specific time. Book it now before the good slots disappear.",
            action_items: ['Choose time slot within 24hrs', 'Block calendar time', 'Prepare questions about academic progress']
          }
        ];
        
        renderEmailInsights();
        updateChiefInsights();
      }
    }
    
    function updateChiefInsights() {
      const insightsEl = document.getElementById('chief-insights');
      const insights = [
        "I've spotted 1 urgent item that's actually manufactured urgency. Your family schedule needs 2 adjustments. Your commerce patterns show strong values alignment.",
        "3 emails require action, 1 is emotional manipulation. Your purchase behavior suggests you value sustainability over speed.",
        "Family logistics are creating calendar conflicts. I'm tracking patterns that show you're overcommitted on Tuesdays.",
        "Your inbox shows classic 'urgent vs important' confusion. Let me help you separate real deadlines from other people's poor planning."
      ];
      
      if (insightsEl) {
        insightsEl.textContent = `"${insights[Math.floor(Math.random() * insights.length)]}"`;
      }
    }
    
    async function connectGmailMobile() {
      try {
        window.location.href = '/api/auth/gmail';
      } catch (error) {
        console.error('Gmail connection failed:', error);
      }
    }
    
    async function processEmailsMobile() {
      const processBtn = document.getElementById('process-emails-mobile');
      const processingStatus = document.getElementById('processing-status');
      const emailCategories = document.getElementById('email-categories');
      
      processBtn.style.display = 'none';
      processingStatus.style.display = 'block';
      emailCategories.style.display = 'none';
      
      const messages = [
        'Scanning your inbox...',
        'Detecting calendar invites, receipts, school messages...',
        'Learning your communication patterns...',
        'Organizing by priority...'
      ];
      
      let messageIndex = 0;
      const messageEl = document.getElementById('processing-message');
      const messageInterval = setInterval(() => {
        if (messageIndex < messages.length) {
          messageEl.textContent = messages[messageIndex];
          messageIndex++;
        }
      }, 2000);
      
      try {
        const response = await fetch('/api/email-decoder/process', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ user_id: currentUserId })
        });
        
        clearInterval(messageInterval);
        
        if (!response.ok) {
          throw new Error('Processing failed');
        }
        
        const result = await response.json();
        decodedEmails = result.decoded_emails || [];
        
        processingStatus.style.display = 'none';
        emailCategories.style.display = 'block';
        processBtn.style.display = 'block';
        
        renderEmailCards();
        
      } catch (error) {
        clearInterval(messageInterval);
        console.error('Email processing failed:', error);
        
        processingStatus.innerHTML = `
          <div style="color: rgba(239, 68, 68, 1); padding: 16px;">
            ❌ Processing failed. Please check your connection and try again.
          </div>
        `;
        
        setTimeout(() => {
          processingStatus.style.display = 'none';
          processBtn.style.display = 'block';
        }, 3000);
      }
    }
    
    async function loadRecentEmails() {
      try {
        const response = await fetch(`/api/email-decoder/recent?user_id=${currentUserId}`);
        if (response.ok) {
          const data = await response.json();
          decodedEmails = data.decoded_emails || [];
          if (decodedEmails.length > 0) {
            document.getElementById('email-categories').style.display = 'block';
            renderEmailCards();
          }
        }
      } catch (error) {
        console.error('Failed to load recent emails:', error);
      }
    }
    
    function showIntelCategory(category, button) {
      // Update active tab
      document.querySelectorAll('.intel-tab').forEach(btn => {
        btn.classList.remove('active');
      });
      button.classList.add('active');
      
      currentCategory = category;
      renderEmailInsights();
      
      if (navigator.vibrate) {
        navigator.vibrate(10);
      }
    }
    
    function renderEmailInsights() {
      const container = document.getElementById('translated-emails-mobile');
      
      let filteredEmails = decodedEmails;
      if (currentCategory !== 'all') {
        filteredEmails = decodedEmails.filter(email => email.category === currentCategory);
      }
      
      if (filteredEmails.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 40px; color: rgba(255,255,255,0.6);">
            ${currentCategory === 'all' ? 'No emails analyzed yet' : `No ${currentCategory} insights found`}
          </div>
        `;
        return;
      }
      
      container.innerHTML = filteredEmails.map(email => {
        const priorityClass = email.priority === 'high' ? 'priority-high' : 
                             email.priority === 'medium' ? 'priority-medium' : 'priority-low';
        
        let categorySpecificContent = '';
        
        if (email.category === 'commerce' && email.commerce_intel) {
          categorySpecificContent = `
            <div class="commerce-intel">
              <div style="font-weight: 600; margin-bottom: 8px; color: #10b981;">💰 Commerce Intelligence</div>
              <div style="font-size: 13px; line-height: 1.4;">
                <div>• Brand Loyalty: <span class="brand-loyalty">${email.commerce_intel.brand_loyalty}</span></div>
                <div>• Pattern: ${email.commerce_intel.purchase_pattern}</div>
                <div>• Recommendation: ${email.commerce_intel.recommendation}</div>
                <div>• Similar Values-Based Brands: ${email.commerce_intel.similar_brands.join(', ')}</div>
              </div>
            </div>
          `;
        }
        
        return `
          <div class="email-insight-card" onclick="openEmailInsight('${email.id}')">
            <div class="insight-priority ${priorityClass}">${email.priority}</div>
            <div class="email-subject">${email.subject || 'No Subject'}</div>
            <div class="email-meta">
              <span>${email.sender || 'Unknown Sender'}</span>
              <span class="email-category">${email.category || 'General'}</span>
            </div>
            
            ${email.ai_translation ? `
              <div class="ai-translation">
                <strong>🧠 AI Translation:</strong><br>
                ${email.ai_translation}
              </div>
            ` : ''}
            
            ${categorySpecificContent}
            
            ${email.action_items ? `
              <div style="margin-top: 12px;">
                <div style="font-weight: 600; font-size: 13px; margin-bottom: 6px; color: rgba(255,255,255,0.9);">⚡ Action Items:</div>
                <div style="font-size: 12px; color: rgba(255,255,255,0.8);">
                  ${email.action_items.map(item => `• ${item}`).join('<br>')}
                </div>
              </div>
            ` : ''}
          </div>
        `;
      }).join('');
    }
    
    function openEmailInsight(emailId) {
      // Enhanced interaction for email insights
      const email = decodedEmails.find(e => e.id === emailId);
      if (email) {
        console.log('Opening detailed insight for:', email.subject);
        // Could open modal or detailed view
        if (navigator.vibrate) {
          navigator.vibrate(20);
        }
      }
    }
    
    // Calendar Functions
    function renderCalendar() {
      const calendarDays = document.getElementById('calendar-days');
      const monthEl = document.getElementById('current-month');
      
      if (!calendarDays || !monthEl) {
        console.warn('Calendar elements not found');
        return;
      }
      
      const months = ['January', 'February', 'March', 'April', 'May', 'June',
                     'July', 'August', 'September', 'October', 'November', 'December'];
      
      monthEl.textContent = `📅 ${months[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
      
      const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
      const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
      const startDate = new Date(firstDay);
      startDate.setDate(startDate.getDate() - firstDay.getDay());
      
      const today = new Date();
      const daysHtml = [];
      
      for (let i = 0; i < 42; i++) {
        const day = new Date(startDate);
        day.setDate(startDate.getDate() + i);
        
        const isToday = day.toDateString() === today.toDateString();
        const isCurrentMonth = day.getMonth() === currentDate.getMonth();
        const hasEvents = Math.random() > 0.7; // Simulate some events
        
        let classes = 'calendar-day';
        if (isToday) classes += ' today';
        if (!isCurrentMonth) classes += ' other-month';
        if (hasEvents && isCurrentMonth) classes += ' has-events';
        
        daysHtml.push(`<div class="${classes}" onclick="selectDate('${day.toISOString()}')">${day.getDate()}</div>`);
      }
      
      calendarDays.innerHTML = daysHtml.join('');
      console.log('Calendar rendered with', daysHtml.length, 'days');
    }
    
    function changeMonth(direction) {
      currentDate.setMonth(currentDate.getMonth() + direction);
      renderCalendar();
      
      if (navigator.vibrate) {
        navigator.vibrate(10);
      }
    }
    
    function selectDate(dateString) {
      console.log('Selected date:', dateString);
      if (navigator.vibrate) {
        navigator.vibrate(10);
      }
    }
    
    function addEventMobile() {
      const eventTitle = prompt('Event title:');
      if (eventTitle) {
        const todayList = document.getElementById('today-events-list');
        todayList.innerHTML += `
          <div class="event-item">
            <div class="event-title">${eventTitle}</div>
            <div class="event-time">Added just now</div>
          </div>
        `;
      }
    }
    
    async function callHomeOpsAI(message) {
      // This connects to your actual HomeOps AI backend
      try {
        const response = await fetch('/api/chat', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            message: message,
            context: 'mobile-chat',
            user_id: currentUserId || 'mobile-user'
          })
        });
        
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        
        const data = await response.json();
        return data.response || data.message || "I'm processing your request...";
        
      } catch (error) {
        console.error('AI Backend Error:', error);
        
        // Fallback response with your tone model characteristics
        const responses = [
          `Got it. "${message}" - let me break this down for you. This isn't about perfection, it's about progress. What's the real question underneath this?`,
          `I hear you asking about "${message}". Here's what I'm seeing: you're looking for clarity, not another task. Let's get specific - what needs to happen first?`,
          `"${message}" - okay, let's cut through the noise. You don't need another system, you need one thing that actually works. What's the non-negotiable here?`,
          `About "${message}" - this sounds like you're carrying too much mental load. Let's extract the actual actionable pieces from this. What can we name and tame?`,
          `I'm tracking "${message}". This feels like overwhelm disguised as a question. Let's get honest about what you actually need right now.`
        ];
        
        return responses[Math.floor(Math.random() * responses.length)];
      }
    }
    
    function previousMonth() {
      if (navigator.vibrate) navigator.vibrate(10);
      // Calendar navigation logic would go here
    }
    
    function nextMonth() {
      if (navigator.vibrate) navigator.vibrate(10);
      // Calendar navigation logic would go here
    }
    
    // Enter key support for chat
    document.getElementById('chatInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        sendMessage();
      }
    });
    
    console.log('🚀 Mobile-First HomeOps Loaded Successfully - NO REDIRECTS!');
  </script>
</body>
</html>
