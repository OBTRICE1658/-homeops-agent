<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HomeOps Command Center</title>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  
  <!-- Lucide Icons CDN -->
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      min-height: 100vh;
      margin: 0;
      padding: 20px;
    }

    .command-center {
      max-width: 1200px;
      margin: 0 auto;
    }

    .hero-header {
      text-align: center;
      margin-bottom: 32px;
      padding: 24px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 16px;
      backdrop-filter: blur(20px);
    }

    .hero-title {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .hero-subtitle {
      font-size: 16px;
      opacity: 0.8;
      font-weight: 500;
    }

    .action-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 20px;
      margin-bottom: 32px;
    }

    @media (min-width: 768px) {
      .action-grid {
        grid-template-columns: 1fr 1fr;
      }
    }

    .action-card {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 16px;
      padding: 24px;
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      transition: all 0.2s ease;
      cursor: pointer;
    }

    .action-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.2);
      background: rgba(255, 255, 255, 0.15);
    }

    .card-header {
      display: flex;
      align-items: center;
      margin-bottom: 16px;
    }

    .card-icon {
      margin-right: 12px;
      color: rgba(255, 255, 255, 0.9);
    }

    .card-title {
      font-size: 18px;
      font-weight: 600;
    }

    .card-content {
      margin-bottom: 16px;
    }

    .metric {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .metric-label {
      font-size: 14px;
      opacity: 0.7;
    }

    .insight-text {
      font-size: 14px;
      line-height: 1.4;
      opacity: 0.9;
      margin-bottom: 12px;
    }

    .quick-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .action-btn {
      background: rgba(255, 255, 255, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 8px;
      padding: 8px 12px;
      font-size: 12px;
      color: #fff;
      cursor: pointer;
      transition: all 0.2s ease;
      text-decoration: none;
      display: inline-block;
    }

    .action-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-1px);
    }

    .loading {
      text-align: center;
      opacity: 0.7;
      margin: 20px 0;
    }

    .error {
      background: rgba(255, 0, 0, 0.1);
      border: 1px solid rgba(255, 0, 0, 0.3);
      border-radius: 8px;
      padding: 12px;
      margin: 12px 0;
      font-size: 14px;
    }

    .time-greeting {
      font-size: 20px;
      margin-bottom: 8px;
      opacity: 0.9;
    }
  </style>
</head>
<body>
  <div class="command-center">
    <div class="hero-header">
      <div class="time-greeting" id="greeting">Good morning!</div>
      <div class="hero-title">HomeOps Command Center</div>
      <div class="hero-subtitle">Your personalized daily dashboard</div>
    </div>

    <div class="action-grid">
      <!-- Email Intelligence Card -->
      <div class="action-card" onclick="openEmailDetails()">
        <div class="card-header">
          <i data-lucide="mail" class="card-icon"></i>
          <div class="card-title">Email Intelligence</div>
        </div>
        <div class="card-content">
          <div class="metric" id="urgent-count">-</div>
          <div class="metric-label">Urgent messages need attention</div>
          <div class="insight-text" id="email-insight">Loading your email insights...</div>
        </div>
        <div class="quick-actions">
          <div class="action-btn" onclick="event.stopPropagation(); openGmail()">Open Gmail</div>
          <div class="action-btn" onclick="event.stopPropagation(); snoozeAll()">Snooze All</div>
        </div>
      </div>

      <!-- Calendar Card -->
      <div class="action-card" onclick="openCalendar()">
        <div class="card-header">
          <i data-lucide="calendar" class="card-icon"></i>
          <div class="card-title">Today's Schedule</div>
        </div>
        <div class="card-content">
          <div class="metric" id="events-count">-</div>
          <div class="metric-label">Events today</div>
          <div class="insight-text" id="calendar-insight">Loading your schedule...</div>
        </div>
        <div class="quick-actions">
          <div class="action-btn" onclick="event.stopPropagation(); addEvent()">Quick Add</div>
          <div class="action-btn" onclick="event.stopPropagation(); findMeetingTime()">Find Time</div>
        </div>
      </div>

      <!-- Commerce Intelligence Card -->
      <div class="action-card" onclick="openDeals()">
        <div class="card-header">
          <i data-lucide="shopping-bag" class="card-icon"></i>
          <div class="card-title">Smart Shopping</div>
        </div>
        <div class="card-content">
          <div class="metric" id="deals-count">-</div>
          <div class="metric-label">Active deals from your brands</div>
          <div class="insight-text" id="commerce-insight">Finding personalized deals...</div>
        </div>
        <div class="quick-actions">
          <div class="action-btn" onclick="event.stopPropagation(); viewDeals()">View Deals</div>
          <div class="action-btn" onclick="event.stopPropagation(); trackPackages()">Track Packages</div>
        </div>
      </div>

      <!-- Quick Actions Card -->
      <div class="action-card">
        <div class="card-header">
          <i data-lucide="zap" class="card-icon"></i>
          <div class="card-title">Quick Actions</div>
        </div>
        <div class="card-content">
          <div class="insight-text">Your most-used shortcuts based on patterns</div>
        </div>
        <div class="quick-actions">
          <div class="action-btn" onclick="orderUber()">Book Uber</div>
          <div class="action-btn" onclick="orderFood()">Order Lunch</div>
          <div class="action-btn" onclick="checkWeather()">Weather</div>
          <div class="action-btn" onclick="setReminder()">Set Reminder</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      console.log('ðŸš€ Command Center loaded');
      
      // Initialize Lucide icons
      if (typeof lucide !== 'undefined') {
        lucide.createIcons();
      }
      
      // Set greeting
      setTimeBasedGreeting();
      
      // Load dashboard data
      loadDashboardData();
    });

    function setTimeBasedGreeting() {
      const hour = new Date().getHours();
      let greeting = 'Good morning!';
      
      if (hour >= 12 && hour < 18) {
        greeting = 'Good afternoon!';
      } else if (hour >= 18) {
        greeting = 'Good evening!';
      }
      
      document.getElementById('greeting').textContent = greeting;
    }

    async function loadDashboardData() {
      const userId = localStorage.getItem('homeops_user_id') || 'demo-user';
      
      try {
        // Load email intelligence
        await loadEmailIntelligence(userId);
        
        // Load calendar events
        await loadCalendarEvents(userId);
        
        // Load commerce data
        await loadCommerceData(userId);
        
      } catch (error) {
        console.error('Dashboard loading error:', error);
        showError('Unable to load dashboard data. Please refresh.');
      }
    }

    async function loadEmailIntelligence(userId) {
      try {
        const response = await fetch(`/api/email-intelligence?userId=${userId}&limit=10&days=7`);
        const data = await response.json();
        
        if (data.success && data.emails) {
          const urgentCount = data.emails.filter(email => 
            email.priority === 'high' || 
            email.urgency_score > 0.7
          ).length;
          
          document.getElementById('urgent-count').textContent = urgentCount;
          
          // Generate insight
          let insight = 'Your inbox is under control.';
          if (urgentCount > 0) {
            insight = `${urgentCount} urgent emails need your attention. `;
            const brands = data.emails.filter(e => e.brand).map(e => e.brand).slice(0, 2);
            if (brands.length > 0) {
              insight += `Including updates from ${brands.join(', ')}.`;
            }
          }
          
          document.getElementById('email-insight').textContent = insight;
        }
      } catch (error) {
        console.error('Email loading error:', error);
        document.getElementById('email-insight').textContent = 'Unable to load email data';
      }
    }

    async function loadCalendarEvents(userId) {
      try {
        // Get today's events from localStorage (populated by calendar sync)
        const allEvents = JSON.parse(localStorage.getItem('homeops_calendar_events') || '[]');
        const today = new Date().toDateString();
        const todayEvents = allEvents.filter(event => {
          const eventDate = new Date(event.start || event.date).toDateString();
          return eventDate === today;
        });
        
        document.getElementById('events-count').textContent = todayEvents.length;
        
        // Generate insight
        let insight = 'Free day ahead!';
        if (todayEvents.length > 0) {
          const nextEvent = todayEvents.find(event => {
            const eventTime = new Date(event.start || event.date);
            return eventTime > new Date();
          });
          
          if (nextEvent) {
            const timeUntil = Math.round((new Date(nextEvent.start || nextEvent.date) - new Date()) / 60000);
            if (timeUntil < 60) {
              insight = `Next meeting "${nextEvent.summary}" in ${timeUntil} minutes.`;
            } else {
              insight = `${todayEvents.length} events today. Next: "${nextEvent.summary}".`;
            }
          } else {
            insight = `${todayEvents.length} events completed today.`;
          }
        }
        
        document.getElementById('calendar-insight').textContent = insight;
      } catch (error) {
        console.error('Calendar loading error:', error);
        document.getElementById('calendar-insight').textContent = 'Unable to load calendar data';
      }
    }

    async function loadCommerceData(userId) {
      try {
        // For now, show static data - can be enhanced with real commerce API
        const mockDeals = ['Nike: 20% off running shoes', 'Amazon: Prime deals ending today', 'Starbucks: Free drink with purchase'];
        
        document.getElementById('deals-count').textContent = mockDeals.length;
        document.getElementById('commerce-insight').textContent = mockDeals[0] + ' and ' + (mockDeals.length - 1) + ' more deals available.';
      } catch (error) {
        console.error('Commerce loading error:', error);
        document.getElementById('commerce-insight').textContent = 'Unable to load deal data';
      }
    }

    function showError(message) {
      const errorDiv = document.createElement('div');
      errorDiv.className = 'error';
      errorDiv.textContent = message;
      document.querySelector('.command-center').appendChild(errorDiv);
    }

    // Action handlers
    function openEmailDetails() {
      // Could open email intelligence in parent window
      if (window.parent) {
        window.parent.postMessage({action: 'switchTab', tab: 'decoder'}, '*');
      }
    }

    function openCalendar() {
      if (window.parent) {
        window.parent.postMessage({action: 'switchTab', tab: 'calendar'}, '*');
      }
    }

    function openDeals() {
      alert('Commerce intelligence coming soon!');
    }

    function openGmail() {
      window.open('https://gmail.com', '_blank');
    }

    function snoozeAll() {
      alert('Snooze all urgent emails feature coming soon!');
    }

    function addEvent() {
      const title = prompt('Quick event title:');
      if (title) {
        alert(`Adding "${title}" to your calendar...`);
      }
    }

    function findMeetingTime() {
      alert('Finding available meeting times...');
    }

    function viewDeals() {
      alert('Opening personalized deals...');
    }

    function trackPackages() {
      alert('Package tracking feature coming soon!');
    }

    function orderUber() {
      alert('Uber integration coming soon!');
    }

    function orderFood() {
      alert('Food delivery integration coming soon!');
    }

    function checkWeather() {
      alert('Weather widget coming soon!');
    }

    function setReminder() {
      const reminder = prompt('What would you like to be reminded about?');
      if (reminder) {
        alert(`Reminder set: "${reminder}"`);
      }
    }
  </script>
</body>
</html>
