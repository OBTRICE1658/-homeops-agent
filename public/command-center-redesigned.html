<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HomeOps Command Center</title>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  
  <!-- Lucide Icons CDN -->
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      min-height: 100vh;
      margin: 0;
      padding: 20px;
    }

    .command-center {
      max-width: 1200px;
      margin: 0 auto;
    }

    .hero-header {
      text-align: center;
      margin-bottom: 32px;
      padding: 24px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 16px;
      backdrop-filter: blur(20px);
    }

    .hero-title {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .hero-subtitle {
      font-size: 16px;
      opacity: 0.8;
      font-weight: 500;
    }

    .action-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 20px;
      margin-bottom: 32px;
    }

    @media (min-width: 768px) {
      .action-grid {
        grid-template-columns: 1fr 1fr;
      }
    }

    .action-card {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 16px;
      padding: 24px;
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      transition: all 0.2s ease;
      cursor: pointer;
    }

    .action-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.2);
      background: rgba(255, 255, 255, 0.15);
    }

    .card-header {
      display: flex;
      align-items: center;
      margin-bottom: 16px;
    }

    .card-icon {
      margin-right: 12px;
      color: rgba(255, 255, 255, 0.9);
    }

    .card-title {
      font-size: 18px;
      font-weight: 600;
    }

    .card-content {
      margin-bottom: 16px;
    }

    .metric {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .metric-label {
      font-size: 14px;
      opacity: 0.7;
    }

    .insight-text {
      font-size: 14px;
      line-height: 1.4;
      opacity: 0.9;
      margin-bottom: 12px;
    }

    .quick-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .action-btn {
      background: rgba(255, 255, 255, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 8px;
      padding: 8px 12px;
      font-size: 12px;
      color: #fff;
      cursor: pointer;
      transition: all 0.2s ease;
      text-decoration: none;
      display: inline-block;
    }

    .action-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-1px);
    }

    .loading {
      text-align: center;
      opacity: 0.7;
      margin: 20px 0;
    }

    .error {
      background: rgba(255, 0, 0, 0.1);
      border: 1px solid rgba(255, 0, 0, 0.3);
      border-radius: 8px;
      padding: 12px;
      margin: 12px 0;
      font-size: 14px;
    }

    .time-greeting {
      font-size: 20px;
      margin-bottom: 8px;
      opacity: 0.9;
    }

    /* Top Emails Styling */
    .top-emails-list {
      margin-top: 16px;
      max-height: 200px;
      overflow-y: auto;
    }

    .email-item {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 8px;
      transition: all 0.2s ease;
      cursor: pointer;
    }

    .email-item:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateX(4px);
    }

    .email-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .email-from {
      font-size: 12px;
      font-weight: 600;
      opacity: 0.9;
    }

    .email-importance {
      font-size: 10px;
      background: rgba(255, 255, 255, 0.3);
      padding: 2px 6px;
      border-radius: 4px;
      text-transform: uppercase;
    }

    .email-subject {
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 4px;
      line-height: 1.2;
    }

    .email-summary {
      font-size: 11px;
      opacity: 0.8;
      line-height: 1.3;
    }

    .loading-emails {
      text-align: center;
      opacity: 0.7;
      font-style: italic;
      padding: 20px;
    }

    /* Weekly Summary Styling */
    .weekly-summary {
      margin-top: 16px;
      max-height: 200px;
      overflow-y: auto;
    }

    .loading-summary {
      text-align: center;
      opacity: 0.7;
      font-style: italic;
      padding: 20px;
    }

    .week-greeting {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 12px;
      color: rgba(255, 255, 255, 0.9);
    }

    .week-insights {
      font-size: 13px;
      line-height: 1.4;
      opacity: 0.9;
      margin-bottom: 12px;
    }

    .priority-events {
      margin-top: 12px;
    }

    .priority-event {
      background: rgba(255, 255, 255, 0.1);
      border-left: 3px solid rgba(255, 255, 255, 0.5);
      padding: 8px 12px;
      margin-bottom: 6px;
      border-radius: 4px;
      font-size: 12px;
    }

    .event-day {
      font-weight: 600;
      color: rgba(255, 255, 255, 0.8);
    }

    .event-title {
      margin-left: 8px;
      opacity: 0.9;
    }
  </style>
</head>
<body>
  <div class="command-center">
    <div class="hero-header">
      <div class="time-greeting" id="greeting">Good morning!</div>
      <div class="hero-title">HomeOps Command Center</div>
      <div class="hero-subtitle">Your personalized daily dashboard</div>
    </div>

    <div class="action-grid">
      <!-- Email Intelligence Card -->
      <div class="action-card" onclick="openEmailDetails()">
        <div class="card-header">
          <i data-lucide="mail" class="card-icon"></i>
          <div class="card-title">Top 5 Important Emails Today</div>
        </div>
        <div class="card-content">
          <div class="metric" id="urgent-count">-</div>
          <div class="metric-label">Critical emails decoded</div>
          <div class="top-emails-list" id="top-emails-list">
            <div class="loading-emails">üß† AI is analyzing your inbox...</div>
          </div>
        </div>
        <div class="quick-actions">
          <div class="action-btn" onclick="event.stopPropagation(); openGmail()">Open Gmail</div>
          <div class="action-btn" onclick="event.stopPropagation(); refreshEmails()">Refresh</div>
        </div>
      </div>

      <!-- Calendar Card -->
      <div class="action-card" onclick="openCalendar()">
        <div class="card-header">
          <i data-lucide="calendar" class="card-icon"></i>
          <div class="card-title">This Week's Overview</div>
        </div>
        <div class="card-content">
          <div class="metric" id="events-count">-</div>
          <div class="metric-label">Events this week</div>
          <div class="weekly-summary" id="weekly-summary">
            <div class="loading-summary">üóìÔ∏è AI is analyzing your upcoming week...</div>
          </div>
        </div>
        <div class="quick-actions">
          <div class="action-btn" onclick="event.stopPropagation(); openCalendar()">View Calendar</div>
          <div class="action-btn" onclick="event.stopPropagation(); refreshCalendar()">Refresh</div>
        </div>
      </div>

      <!-- Commerce Intelligence Card -->
      <div class="action-card" onclick="openDeals()">
        <div class="card-header">
          <i data-lucide="shopping-bag" class="card-icon"></i>
          <div class="card-title">Smart Shopping</div>
        </div>
        <div class="card-content">
          <div class="metric" id="deals-count">-</div>
          <div class="metric-label">Active deals from your brands</div>
          <div class="insight-text" id="commerce-insight">Finding personalized deals...</div>
        </div>
        <div class="quick-actions">
          <div class="action-btn" onclick="event.stopPropagation(); viewDeals()">View Deals</div>
          <div class="action-btn" onclick="event.stopPropagation(); trackPackages()">Track Packages</div>
        </div>
      </div>

      <!-- Quick Actions Card -->
      <div class="action-card">
        <div class="card-header">
          <i data-lucide="zap" class="card-icon"></i>
          <div class="card-title">Quick Actions</div>
        </div>
        <div class="card-content">
          <div class="insight-text">Your most-used shortcuts based on patterns</div>
        </div>
        <div class="quick-actions">
          <div class="action-btn" onclick="orderUber()">Book Uber</div>
          <div class="action-btn" onclick="orderFood()">Order Lunch</div>
          <div class="action-btn" onclick="checkWeather()">Weather</div>
          <div class="action-btn" onclick="setReminder()">Set Reminder</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üöÄ Command Center loaded');
      
      // Initialize Lucide icons
      if (typeof lucide !== 'undefined') {
        lucide.createIcons();
      }
      
      // Set greeting
      setTimeBasedGreeting();
      
      // Load dashboard data
      loadDashboardData();
    });

    function setTimeBasedGreeting() {
      const hour = new Date().getHours();
      let greeting = 'Good morning!';
      
      if (hour >= 12 && hour < 18) {
        greeting = 'Good afternoon!';
      } else if (hour >= 18) {
        greeting = 'Good evening!';
      }
      
      document.getElementById('greeting').textContent = greeting;
    }

    async function loadDashboardData() {
      const userId = localStorage.getItem('homeops_user_id') || 'demo-user';
      
      console.log('üîÑ Loading dashboard data for user:', userId);
      
      // Show loading states
      document.getElementById('urgent-count').textContent = '...';
      document.getElementById('events-count').textContent = '...';
      document.getElementById('deals-count').textContent = '...';
      document.getElementById('top-emails-list').innerHTML = '<div class="loading-emails">üß† AI is scanning for important emails...</div>';
      document.getElementById('weekly-summary').innerHTML = '<div class="loading-summary">üóìÔ∏è AI is analyzing your upcoming week...</div>';
      document.getElementById('commerce-insight').textContent = 'Finding deals...';
      
      try {
        // Load all data in parallel for better performance
        const loadPromises = [
          loadEmailIntelligence(userId).catch(e => console.error('Email load failed:', e)),
          loadCalendarEvents(userId).catch(e => console.error('Calendar load failed:', e)),
          loadCommerceData(userId).catch(e => console.error('Commerce load failed:', e))
        ];
        
        await Promise.allSettled(loadPromises);
        
        console.log('‚úÖ Dashboard data loading completed');
        
        // Add refresh functionality
        setTimeout(() => {
          const refreshBtn = document.createElement('div');
          refreshBtn.className = 'action-btn';
          refreshBtn.textContent = 'üîÑ Refresh';
          refreshBtn.style.position = 'fixed';
          refreshBtn.style.top = '20px';
          refreshBtn.style.right = '20px';
          refreshBtn.style.zIndex = '1000';
          refreshBtn.onclick = () => {
            console.log('üîÑ Manual refresh triggered');
            loadDashboardData();
          };
          document.body.appendChild(refreshBtn);
        }, 2000);
        
      } catch (error) {
        console.error('Dashboard loading error:', error);
        showError('Unable to load dashboard data. Please refresh the page.');
      }
    }

    async function loadEmailIntelligence(userId) {
      try {
        console.log('üìß Loading email intelligence for user:', userId);
        const response = await fetch(`/api/email-intelligence?userId=${userId}&limit=20&days=1`);
        const data = await response.json();
        
        console.log('üìß Email intelligence data:', data);
        
        if (data.success && data.insights) {
          // Filter and rank emails by importance
          const importantEmails = data.insights
            .filter(email => {
              // Focus on 1:1 emails, bills, school, personal important stuff
              const isPersonal = email.category !== 'Promotional' && email.category !== 'Marketing';
              const isImportant = 
                email.manipulation_score > 5 ||
                email.priority === 'high' ||
                email.priority === 'High' ||
                (email.title && (
                  email.title.toLowerCase().includes('bill') ||
                  email.title.toLowerCase().includes('payment') ||
                  email.title.toLowerCase().includes('school') ||
                  email.title.toLowerCase().includes('camp') ||
                  email.title.toLowerCase().includes('appointment') ||
                  email.title.toLowerCase().includes('meeting') ||
                  email.title.toLowerCase().includes('urgent') ||
                  email.title.toLowerCase().includes('important') ||
                  email.title.toLowerCase().includes('reminder') ||
                  email.title.toLowerCase().includes('due') ||
                  email.title.toLowerCase().includes('deadline')
                )) ||
                (email.from && !email.from.includes('noreply'));
              
              return isPersonal && isImportant;
            })
            .sort((a, b) => {
              // Sort by importance score
              const scoreA = (a.manipulation_score || 0) + (a.personalized_score || 0) * 10;
              const scoreB = (b.manipulation_score || 0) + (b.personalized_score || 0) * 10;
              return scoreB - scoreA;
            })
            .slice(0, 5); // Top 5

          document.getElementById('urgent-count').textContent = importantEmails.length;
          
          // Render the top emails list
          const emailsList = document.getElementById('top-emails-list');
          
          if (importantEmails.length === 0) {
            emailsList.innerHTML = `
              <div class="loading-emails">
                ‚úÖ No critical emails today! Your inbox is under control.
                ${data.dataSource === 'fallback' ? '<br><small>(Connect Gmail for real insights)</small>' : ''}
              </div>
            `;
          } else {
            emailsList.innerHTML = importantEmails.map((email, index) => {
              const importance = email.manipulation_score > 8 ? 'URGENT' : 
                               email.manipulation_score > 6 ? 'HIGH' : 'IMPORTANT';
              
              const aiSummary = generateAISummary(email);
              
              return `
                <div class="email-item" onclick="openSpecificEmail('${email.id || index}')">
                  <div class="email-header">
                    <div class="email-from">${email.from || 'Unknown Sender'}</div>
                    <div class="email-importance">${importance}</div>
                  </div>
                  <div class="email-subject">${email.title || 'No Subject'}</div>
                  <div class="email-summary">${aiSummary}</div>
                </div>
              `;
            }).join('');
          }
          
          // Store important emails for other functions
          window.homeOpsImportantEmails = importantEmails;
          
        } else {
          throw new Error('Invalid email intelligence response');
        }
      } catch (error) {
        console.error('Email loading error:', error);
        document.getElementById('urgent-count').textContent = '?';
        document.getElementById('top-emails-list').innerHTML = `
          <div class="loading-emails">‚ùå Unable to load emails. Please check connection.</div>
        `;
      }
    }

    function generateAISummary(email) {
      // AI-powered summary generation based on email content
      const subject = (email.title || '').toLowerCase();
      const description = (email.description || '').toLowerCase();
      const from = (email.from || '').toLowerCase();
      
      // Bill/Payment detection
      if (subject.includes('bill') || subject.includes('payment') || subject.includes('invoice')) {
        return `üí∞ Bill payment detected - requires your attention for payment processing`;
      }
      
      // School/Education
      if (subject.includes('school') || subject.includes('teacher') || subject.includes('class') || 
          from.includes('school') || from.includes('edu')) {
        return `üéì School-related communication - likely about schedules, events, or student updates`;
      }
      
      // Camp/Activities
      if (subject.includes('camp') || subject.includes('activity') || subject.includes('registration')) {
        return `üèïÔ∏è Camp or activity update - may contain schedule changes or important instructions`;
      }
      
      // Appointments/Meetings
      if (subject.includes('appointment') || subject.includes('meeting') || subject.includes('reminder')) {
        return `üìÖ Appointment or meeting notice - check for time, location, or cancellation details`;
      }
      
      // Personal/1:1 communication
      if (!from.includes('noreply') && !from.includes('no-reply') && !subject.includes('newsletter')) {
        return `üë§ Personal message - direct communication that likely needs your response`;
      }
      
      // Financial/Important documents
      if (subject.includes('statement') || subject.includes('document') || subject.includes('tax')) {
        return `üìÑ Important document received - may be financial or legal in nature`;
      }
      
      // Urgent/Time-sensitive
      if (subject.includes('urgent') || subject.includes('asap') || subject.includes('deadline')) {
        return `‚ö° Time-sensitive message - immediate attention may be required`;
      }
      
      // Default summary
      return `üìß ${email.category || 'Important'} email from ${email.from || 'sender'} - AI detected this needs your attention`;
    }

    async function loadCalendarEvents(userId) {
      try {
        // Get user's first name for personalized greeting
        const userEmail = localStorage.getItem('homeops_user_email') || '';
        const firstName = userEmail ? userEmail.split('@')[0].split('.')[0] : 'there';
        const capitalizedName = firstName.charAt(0).toUpperCase() + firstName.slice(1);

        // Get this week's events from localStorage (populated by calendar sync)
        let weekEvents = [];
        const allEvents = JSON.parse(localStorage.getItem('homeops_calendar_events') || '[]');
        
        if (allEvents.length > 0) {
          const today = new Date();
          const startOfWeek = new Date(today);
          startOfWeek.setDate(today.getDate() - today.getDay()); // Start of this week (Sunday)
          const endOfWeek = new Date(startOfWeek);
          endOfWeek.setDate(startOfWeek.getDate() + 6); // End of this week (Saturday)
          
          weekEvents = allEvents.filter(event => {
            try {
              const eventDate = new Date(event.start?.dateTime || event.start?.date || event.date);
              return eventDate >= startOfWeek && eventDate <= endOfWeek;
            } catch (e) {
              return false;
            }
          });
        }
        
        // Also try to fetch from API as backup
        try {
          const response = await fetch(`/api/calendar-events?userId=${userId}&days=7`);
          if (response.ok) {
            const calendarData = await response.json();
            if (calendarData.events && calendarData.events.length > 0) {
              const today = new Date();
              const startOfWeek = new Date(today);
              startOfWeek.setDate(today.getDate() - today.getDay());
              const endOfWeek = new Date(startOfWeek);
              endOfWeek.setDate(startOfWeek.getDate() + 6);
              
              const apiWeekEvents = calendarData.events.filter(event => {
                try {
                  const eventDate = new Date(event.start?.dateTime || event.start?.date || event.date);
                  return eventDate >= startOfWeek && eventDate <= endOfWeek;
                } catch (e) {
                  return false;
                }
              });
              
              // Merge events, avoiding duplicates
              apiWeekEvents.forEach(apiEvent => {
                const exists = weekEvents.some(localEvent => 
                  localEvent.id === apiEvent.id || 
                  localEvent.summary === apiEvent.summary
                );
                if (!exists) {
                  weekEvents.push(apiEvent);
                }
              });
            }
          }
        } catch (apiError) {
          console.log('Calendar API not available, using localStorage only');
        }
        
        document.getElementById('events-count').textContent = weekEvents.length;
        
        // Generate AI-powered weekly summary
        const weeklySummary = generateWeeklySummary(capitalizedName, weekEvents);
        document.getElementById('weekly-summary').innerHTML = weeklySummary;
        
        // Store events count for other functions
        window.homeOpsWeekEvents = weekEvents;
        
      } catch (error) {
        console.error('Calendar loading error:', error);
        document.getElementById('events-count').textContent = '?';
        document.getElementById('weekly-summary').innerHTML = `
          <div class="loading-summary">‚ùå Unable to load calendar data</div>
        `;
      }
    }

    function generateWeeklySummary(firstName, weekEvents) {
      if (weekEvents.length === 0) {
        return `
          <div class="week-greeting">Hey ${firstName}! üëã</div>
          <div class="week-insights">
            You have a completely free week ahead! This is a great opportunity to:
            <br>‚Ä¢ Focus on personal projects
            <br>‚Ä¢ Plan ahead for busy weeks
            <br>‚Ä¢ Take some well-deserved downtime
          </div>
        `;
      }

      // Analyze the week's events
      const eventsByDay = {};
      const today = new Date();
      const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
      
      weekEvents.forEach(event => {
        try {
          const eventDate = new Date(event.start?.dateTime || event.start?.date || event.date);
          const dayName = dayNames[eventDate.getDay()];
          const dateKey = eventDate.toDateString();
          
          if (!eventsByDay[dayName]) {
            eventsByDay[dayName] = [];
          }
          eventsByDay[dayName].push({
            ...event,
            eventDate,
            dayName,
            isToday: dateKey === today.toDateString(),
            isPast: eventDate < today
          });
        } catch (e) {
          console.log('Error parsing event date:', e);
        }
      });

      // Generate AI insights
      let insights = [];
      const totalEvents = weekEvents.length;
      const busyDays = Object.keys(eventsByDay).length;
      
      // Intensity analysis
      if (totalEvents > 15) {
        insights.push("This is a particularly busy week for you");
      } else if (totalEvents > 8) {
        insights.push("You have a moderately busy week ahead");
      } else {
        insights.push("You have a manageable week with good breathing room");
      }

      // Day distribution analysis
      if (busyDays <= 2) {
        insights.push(`Most of your commitments are concentrated in just ${busyDays} day${busyDays > 1 ? 's' : ''}`);
      } else if (busyDays >= 5) {
        insights.push("Your schedule is spread throughout the week");
      }

      // Find priority/important events
      const priorityEvents = weekEvents
        .filter(event => {
          const title = (event.summary || event.title || '').toLowerCase();
          return title.includes('meeting') || 
                 title.includes('appointment') || 
                 title.includes('deadline') ||
                 title.includes('presentation') ||
                 title.includes('interview') ||
                 title.includes('call') ||
                 (event.start?.dateTime && !event.start?.date); // Timed events are usually more important
        })
        .slice(0, 3); // Top 3 priority events

      // Build the summary HTML
      let summaryHTML = `
        <div class="week-greeting">Hey ${firstName}! üëã</div>
        <div class="week-insights">
          Here's your upcoming week overview:<br>
          ‚Ä¢ ${insights.join('<br>‚Ä¢ ')}
        </div>
      `;

      if (priorityEvents.length > 0) {
        summaryHTML += `<div class="priority-events">`;
        summaryHTML += `<div style="font-size: 12px; font-weight: 600; margin-bottom: 8px; opacity: 0.8;">Key Events:</div>`;
        
        priorityEvents.forEach(event => {
          const eventDate = new Date(event.start?.dateTime || event.start?.date || event.date);
          const dayName = dayNames[eventDate.getDay()];
          const isToday = eventDate.toDateString() === today.toDateString();
          const dayLabel = isToday ? 'Today' : dayName;
          
          summaryHTML += `
            <div class="priority-event">
              <span class="event-day">${dayLabel}:</span>
              <span class="event-title">${event.summary || event.title || 'Untitled Event'}</span>
            </div>
          `;
        });
        
        summaryHTML += `</div>`;
      }

      return summaryHTML;
    }

    async function loadCommerceData(userId) {
      try {
        console.log('üõçÔ∏è Loading commerce intelligence for user:', userId);
        
        // Use the new dedicated commerce intelligence API
        const response = await fetch(`/api/commerce-intelligence?userId=${userId}&limit=5`);
        const data = await response.json();
        
        console.log('üõçÔ∏è Commerce intelligence data:', data);
        
        if (data.success) {
          const totalDeals = data.deals.length + data.packages.length + data.priceDrops.length;
          document.getElementById('deals-count').textContent = totalDeals;
          
          // Generate smart insight based on actual data
          let insight = 'No active deals found in your inbox.';
          
          if (data.deals.length > 0) {
            const deal = data.deals[0];
            if (deal.discount) {
              insight = `${deal.brand}: ${deal.discount}% off ${deal.category || 'items'}`;
            } else if (deal.savings) {
              insight = `${deal.brand}: Save $${deal.savings} - ${deal.description || 'limited time'}`;
            } else {
              insight = deal.title;
            }
            
            if (totalDeals > 1) {
              insight += ` and ${totalDeals - 1} more deals available`;
            }
          } else if (data.packages.length > 0) {
            const pkg = data.packages[0];
            insight = `Package from ${pkg.carrier}: ${pkg.status}`;
            if (pkg.estimatedDelivery) {
              insight += ` - arriving ${pkg.estimatedDelivery}`;
            }
          }
          
          document.getElementById('commerce-insight').textContent = insight;
          
          // Store commerce data for detailed view
          window.homeOpsCommerceData = data;
          
        } else {
          throw new Error('Invalid commerce intelligence response');
        }
      } catch (error) {
        console.error('Commerce loading error:', error);
        document.getElementById('deals-count').textContent = '?';
        document.getElementById('commerce-insight').textContent = 'Unable to load deal data';
      }
    }

    function showError(message) {
      const errorDiv = document.createElement('div');
      errorDiv.className = 'error';
      errorDiv.textContent = message;
      document.querySelector('.command-center').appendChild(errorDiv);
    }

    // Action handlers
    function openEmailDetails() {
      // Could open email intelligence in parent window
      if (window.parent) {
        window.parent.postMessage({action: 'switchTab', tab: 'decoder'}, '*');
      }
    }

    function openCalendar() {
      if (window.parent) {
        window.parent.postMessage({action: 'switchTab', tab: 'calendar'}, '*');
      }
    }

    function openDeals() {
      const commerceData = window.homeOpsCommerceData;
      
      if (!commerceData) {
        alert('Loading commerce data... Please try again in a moment.');
        return;
      }
      
      // Create a detailed commerce modal
      let modalContent = '<div style="max-height: 400px; overflow-y: auto;">';
      
      // Deals section
      if (commerceData.deals.length > 0) {
        modalContent += '<h3 style="color: #667eea; margin-bottom: 15px;">üéØ Active Deals</h3>';
        commerceData.deals.forEach(deal => {
          modalContent += `
            <div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 12px; margin-bottom: 10px;">
              <div style="font-weight: 600; margin-bottom: 5px;">${deal.title}</div>
              <div style="font-size: 12px; color: #666; margin-bottom: 5px;">
                ${deal.brand} ${deal.discount ? `- ${deal.discount}% off` : ''} ${deal.savings ? `Save $${deal.savings}` : ''}
              </div>
              <div style="font-size: 11px; color: #888;">${deal.description || ''}</div>
              ${deal.expiry ? `<div style="font-size: 11px; color: #f56565; margin-top: 5px;">Expires: ${deal.expiry}</div>` : ''}
            </div>
          `;
        });
      }
      
      // Packages section
      if (commerceData.packages.length > 0) {
        modalContent += '<h3 style="color: #667eea; margin: 20px 0 15px 0;">üì¶ Package Tracking</h3>';
        commerceData.packages.forEach(pkg => {
          modalContent += `
            <div style="background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 8px; padding: 12px; margin-bottom: 10px;">
              <div style="font-weight: 600; margin-bottom: 5px;">${pkg.title}</div>
              <div style="font-size: 12px; color: #666; margin-bottom: 5px;">
                ${pkg.carrier} - ${pkg.status}
              </div>
              ${pkg.trackingNumber ? `<div style="font-size: 11px; color: #888;">Tracking: ${pkg.trackingNumber}</div>` : ''}
              ${pkg.estimatedDelivery ? `<div style="font-size: 11px; color: #059669; margin-top: 5px;">Estimated delivery: ${pkg.estimatedDelivery}</div>` : ''}
            </div>
          `;
        });
      }
      
      // Price drops section  
      if (commerceData.priceDrops.length > 0) {
        modalContent += '<h3 style="color: #667eea; margin: 20px 0 15px 0;">üí∞ Price Drops</h3>';
        commerceData.priceDrops.forEach(drop => {
          modalContent += `
            <div style="background: #fef7f0; border: 1px solid #fed7aa; border-radius: 8px; padding: 12px; margin-bottom: 10px;">
              <div style="font-weight: 600; margin-bottom: 5px;">${drop.title}</div>
              <div style="font-size: 12px; color: #666;">
                ${drop.product} - ${drop.oldPrice ? `Was $${drop.oldPrice}` : ''} ${drop.newPrice ? `Now $${drop.newPrice}` : ''}
              </div>
              ${drop.savings ? `<div style="font-size: 11px; color: #059669; margin-top: 5px;">Save $${drop.savings}</div>` : ''}
            </div>
          `;
        });
      }
      
      // Recommendations section
      if (commerceData.recommendations.length > 0) {
        modalContent += '<h3 style="color: #667eea; margin: 20px 0 15px 0;">üí° Smart Recommendations</h3>';
        commerceData.recommendations.forEach(rec => {
          modalContent += `
            <div style="background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 8px; padding: 10px; margin-bottom: 8px;">
              <div style="font-size: 12px; color: #166534;">${rec}</div>
            </div>
          `;
        });
      }
      
      // Total savings
      if (commerceData.totalSavings > 0) {
        modalContent += `
          <div style="background: #667eea; color: white; border-radius: 8px; padding: 15px; margin-top: 20px; text-align: center;">
            <div style="font-size: 14px; font-weight: 600;">Total Potential Savings</div>
            <div style="font-size: 24px; font-weight: 700; margin-top: 5px;">$${commerceData.totalSavings}</div>
          </div>
        `;
      }
      
      modalContent += '</div>';
      
      // Display in a simple modal (you could enhance this with a proper modal library)
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background: rgba(0,0,0,0.5); z-index: 1000; display: flex; 
        align-items: center; justify-content: center; padding: 20px;
      `;
      
      const modalDialog = document.createElement('div');
      modalDialog.style.cssText = `
        background: white; border-radius: 16px; padding: 20px; 
        max-width: 500px; width: 100%; max-height: 80vh; overflow-y: auto;
      `;
      
      modalDialog.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h2 style="margin: 0; color: #2d3748;">üõçÔ∏è Smart Shopping</h2>
          <button onclick="this.closest('[style*=fixed]').remove()" style="background: none; border: none; font-size: 20px; cursor: pointer;">&times;</button>
        </div>
        ${modalContent}
      `;
      
      modal.appendChild(modalDialog);
      document.body.appendChild(modal);
      
      // Close on background click
      modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.remove();
      });
    }

    function openGmail() {
      window.open('https://gmail.com', '_blank');
    }

    function refreshEmails() {
      console.log('üîÑ Refreshing email intelligence...');
      const userId = localStorage.getItem('homeops_user_id') || 'demo-user';
      loadEmailIntelligence(userId);
    }

    function refreshCalendar() {
      console.log('üîÑ Refreshing calendar overview...');
      const userId = localStorage.getItem('homeops_user_id') || 'demo-user';
      loadCalendarEvents(userId);
    }

    function openSpecificEmail(emailId) {
      console.log('üìß Opening email:', emailId);
      // Could open specific email or navigate to decoder with this email highlighted
      if (window.parent) {
        window.parent.postMessage({
          action: 'switchTab', 
          tab: 'decoder',
          emailId: emailId
        }, '*');
      }
    }

    function snoozeAll() {
      alert('Snooze all urgent emails feature coming soon!');
    }

    function addEvent() {
      const title = prompt('Quick event title:');
      if (title) {
        alert(`Adding "${title}" to your calendar...`);
      }
    }

    function findMeetingTime() {
      alert('Finding available meeting times...');
    }

    function viewDeals() {
      openDeals(); // Use the new detailed commerce modal
    }

    function trackPackages() {
      const commerceData = window.homeOpsCommerceData;
      
      if (!commerceData || commerceData.packages.length === 0) {
        alert('No packages found in your recent emails.');
        return;
      }
      
      let trackingInfo = 'Your Active Packages:\n\n';
      commerceData.packages.forEach((pkg, index) => {
        trackingInfo += `${index + 1}. ${pkg.title}\n`;
        trackingInfo += `   Carrier: ${pkg.carrier}\n`;
        trackingInfo += `   Status: ${pkg.status}\n`;
        if (pkg.trackingNumber) {
          trackingInfo += `   Tracking: ${pkg.trackingNumber}\n`;
        }
        if (pkg.estimatedDelivery) {
          trackingInfo += `   Delivery: ${pkg.estimatedDelivery}\n`;
        }
        trackingInfo += '\n';
      });
      
      alert(trackingInfo);
    }

    function orderUber() {
      alert('Uber integration coming soon!');
    }

    function orderFood() {
      alert('Food delivery integration coming soon!');
    }

    function checkWeather() {
      alert('Weather widget coming soon!');
    }

    function setReminder() {
      const reminder = prompt('What would you like to be reminded about?');
      if (reminder) {
        alert(`Reminder set: "${reminder}"`);
      }
    }
  </script>
</body>
</html>
