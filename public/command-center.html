<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HomeOps Command Center</title>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  
  <!-- Lucide Icons CDN -->
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      min-height: 100vh;
      margin: 0;
      padding: 0;
    }
    
    .command-center {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px 20px 20px;
    }
    
    .hero-header {
      text-align: center;
      margin-bottom: 16px;
      padding: 8px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 16px;
      backdrop-filter: blur(20px);
      margin-top: 0px;
    }
    
    .hero-title {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 8px;
      text-align: center;
      line-height: 1.2;
    }
    
    .hero-subtitle {
      font-size: 16px;
      opacity: 0.8;
      font-weight: 500;
    }
    
    .summary-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 32px;
    }
    
    .summary-tile {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 16px;
      padding: 20px;
      text-align: center;
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      transition: transform 0.2s, box-shadow 0.2s, background 0.2s;
      cursor: pointer;
    }
    
    .summary-tile:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.2);
      background: rgba(255, 255, 255, 0.15);
    }
    
    .summary-tile:active {
      transform: translateY(1px);
      background: rgba(255, 255, 255, 0.2);
    }
    
    .tile-icon {
      margin-bottom: 12px;
      color: rgba(255, 255, 255, 0.9);
    }
    
    .tile-count {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 8px;
    }
    
    .tile-label {
      font-size: 14px;
      opacity: 0.8;
      font-weight: 500;
    }
    
    .insights-section {
      margin-bottom: 32px;
    }
    
    .section-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
      font-size: 24px;
      font-weight: 600;
    }
    
    .insights-container {
      display: grid;
      gap: 16px;
    }
    
    .insight-card {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      padding: 20px;
      backdrop-filter: blur(10px);
      transition: transform 0.2s;
    }
    
    .insight-card:hover {
      transform: translateY(-1px);
    }
    
    .insight-header {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 12px;
    }
    
    .insight-icon {
      margin-top: 2px;
      flex-shrink: 0;
    }
    
    .insight-content {
      flex: 1;
    }
    
    .insight-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    
    .insight-meta {
      display: flex;
      gap: 12px;
      font-size: 12px;
      opacity: 0.7;
      margin-bottom: 8px;
    }
    
    .insight-text {
      font-size: 14px;
      line-height: 1.5;
      margin-bottom: 16px;
      opacity: 0.9;
    }
    
    .insight-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    
    .action-btn {
      background: rgba(255, 255, 255, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 8px;
      padding: 8px 16px;
      color: white;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .action-btn:hover {
      background: rgba(255, 255, 255, 0.25);
      transform: translateY(-1px);
    }
    
    .action-btn.primary {
      background: rgba(139, 92, 246, 0.3);
      border-color: rgba(139, 92, 246, 0.5);
    }
    
    .action-btn.primary:hover {
      background: rgba(139, 92, 246, 0.4);
    }
    
    .loading-state {
      text-align: center;
      padding: 40px;
      opacity: 0.6;
    }
    
    .activity-timeline {
      margin-top: 32px;
    }
    
    .timeline-item {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      padding: 12px 16px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 14px;
    }
    
    .timeline-icon {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    
    .timeline-icon.email { background: #8b5cf6; }
    .timeline-icon.calendar { background: #22c55e; }
    .timeline-icon.commerce { background: #f59e0b; }
    .timeline-icon.system { background: #06b6d4; }
    
    .reframe-section {
      background: rgba(251, 191, 36, 0.15);
      border: 1px solid rgba(251, 191, 36, 0.3);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 32px;
      text-align: center;
    }
    
    .reframe-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .reframe-text {
      font-size: 14px;
      opacity: 0.9;
      margin-bottom: 16px;
    }
    
    @media (max-width: 768px) {
      .command-center {
        padding: 16px;
      }
      
      .hero-title {
        font-size: 24px;
      }
      
      .summary-row {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
      }
      
      .summary-tile {
        padding: 16px;
      }
      
      .tile-count {
        font-size: 24px;
      }
      
      .section-header {
        font-size: 20px;
      }
      
      .insight-actions {
        flex-direction: column;
      }
      
      .action-btn {
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <div class="command-center">
    <!-- Dynamic Hero Header -->
    <div class="hero-header">
      <h1 class="hero-title" id="dynamic-greeting">
        Hi there<br>
        <span style="font-size: 0.7em; opacity: 0.8;">Today is July 28, 2025</span>
      </h1>
    </div>
    
    <!-- Summary Tile Row (Mental Load Digest) -->
    <div class="summary-row">
      <div class="summary-tile">
        <div class="tile-icon">
          <i data-lucide="alert-triangle" style="width: 32px; height: 32px;"></i>
        </div>
        <div class="tile-count" id="urgent-count">-</div>
        <div class="tile-label">Urgent Messages</div>
      </div>
      
      <div class="summary-tile">
        <div class="tile-icon">
          <i data-lucide="calendar-days" style="width: 32px; height: 32px; color: white;"></i>
        </div>
        <div class="tile-count" id="events-count">-</div>
        <div class="tile-label">Calendar Events</div>
      </div>
      
      <div class="summary-tile">
        <div class="tile-icon">
          <i data-lucide="shopping-cart" style="width: 32px; height: 32px;"></i>
        </div>
        <div class="tile-count" id="commerce-count">-</div>
        <div class="tile-label">Top Brand Deals</div>
      </div>
      
      <div class="summary-tile">
        <div class="tile-icon">
          <i data-lucide="brain" style="width: 32px; height: 32px; color: white;"></i>
        </div>
        <div class="tile-count" id="insights-count">-</div>
        <div class="tile-label">Total Insights</div>
      </div>
    </div>
    
    <!-- This Week's Intelligence Module -->
    <div class="insights-section">
      <h2 class="section-header">
        <i data-lucide="brain" style="width: 24px; height: 24px; color: white;"></i>
        This Week's Intelligence
      </h2>
      
      <div class="insights-container" id="insights-container">
        <div class="loading-state">
          <i data-lucide="loader" style="width: 24px; height: 24px; margin-bottom: 8px;"></i>
          <div>Loading insights...</div>
        </div>
      </div>
    </div>
    
    <!-- Reframe or Relax Section -->
    <div class="reframe-section" id="reframe-section" style="display: none;">
      <h3 class="reframe-title">
        <i data-lucide="refresh-cw" style="width: 20px; height: 20px;"></i>
        Mindset Check
      </h3>
      <p class="reframe-text" id="reframe-text">
        You've had a busy week with multiple urgent items. Want a mindset reset?
      </p>
      <button class="action-btn primary" onclick="reframeWeek()">
        <i data-lucide="sparkles" style="width: 16px; height: 16px;"></i>
        Reframe My Week
      </button>
    </div>
    
    <!-- Recent Activity Timeline -->
    <div class="activity-timeline">
      <h2 class="section-header">
        <i data-lucide="activity" style="width: 24px; height: 24px;"></i>
        Recent Activity
      </h2>
      
      <div id="activity-timeline">
        <div class="loading-state">
          <i data-lucide="loader" style="width: 20px; height: 20px; margin-bottom: 8px;"></i>
          <div>Loading activity...</div>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    // Global state management
    let dashboardData = {
      summary: {},
      insights: [],
      activity: [],
      currentUser: null
    };
    
    // Initialize Lucide icons and dashboard
    document.addEventListener('DOMContentLoaded', function() {
      console.log('🚀 HomeOps Command Center Loading...');
      lucide.createIcons();
      initializeUser();
    });
    
    // User initialization and management
    async function initializeUser() {
      try {
        // For now, create a demo user - in production this would be actual auth
        const userId = getUserIdFromSession() || 'demo-user';
        
        if (userId === 'demo-user') {
          // Create demo user profile
          await createDemoUser();
        }
        
        dashboardData.currentUser = userId;
        console.log(`👤 User initialized: ${userId}`);
        
        // Update dynamic header
        updateDynamicHeader();
        
        // Load personalized dashboard
        await loadDashboardData();
        
        // Setup interactive tiles
        setupTileInteractions();
        console.log('✅ Dashboard interactions initialized');
        
      } catch (error) {
        console.error('❌ User initialization failed:', error);
        // Fallback to non-personalized mode
        await loadDashboardData();
        setupTileInteractions();
      }
    }
    
    async function createDemoUser() {
      try {
        const response = await fetch('/api/user/login', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            email: 'demo@homeops.app',
            name: 'Demo User'
          })
        });
        
        const result = await response.json();
        if (result.success) {
          localStorage.setItem('homeops-user-id', result.userId);
          console.log('✅ Demo user created:', result.userId);
          return result.userId;
        }
      } catch (error) {
        console.error('❌ Demo user creation failed:', error);
      }
      return 'demo-user';
    }
    
    function getUserIdFromSession() {
      return localStorage.getItem('homeops-user-id') || null;
    }
    
    // Update dynamic header with user name and current date
    function updateDynamicHeader() {
      // Get user's first name from session storage or use fallback
      const userData = JSON.parse(sessionStorage.getItem('homeops-user-data') || '{}');
      const firstName = userData.firstName || userData.name?.split(' ')[0] || 'there';
      
      // Format today's date
      const today = new Date();
      const options = { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
      };
      const formattedDate = today.toLocaleDateString('en-US', options);
      
      // Update the header with two-line format
      const headerElement = document.getElementById('dynamic-greeting');
      if (headerElement) {
        headerElement.innerHTML = `
          Hi ${firstName}<br>
          <span style="font-size: 0.7em; opacity: 0.8;">Today is ${formattedDate}</span>
        `;
      }
      
      console.log(`🎉 Dynamic header updated: Hi ${firstName}, Today is ${formattedDate}`);
    }
    
    // Main data loading function
    async function loadDashboardData() {
      console.log('📊 Loading dashboard data...');
      
      try {
        await loadSummaryData();
        await loadInsightsData();
        await loadActivityData();
        checkReframeSection();
        console.log('✅ Dashboard data loaded successfully');
      } catch (error) {
        console.error('❌ Error loading dashboard data:', error);
        loadFallbackData();
      }
    }
    
    // DEVELOPMENT MODE - Set to false to use real Gmail data
    const DEVELOPMENT_MODE = false;
    
    // Mock data generators
    function getMockDashboardSummary() {
      return {
        success: true,
        summary: {
          urgent: 4,
          events: 6,
          commerce: 3,
          insights: 18
        },
        currentUser: 'demo_user',
        lastSync: new Date().toISOString()
      };
    }
    
    function getMockUrgentMessages() {
      return {
        success: true,
        insights: [
          {
            title: "Flight Gate Change - American Airlines",
            category: "Travel",
            date: "Today",
            priority: "High",
            insight: "Gate changed from B12 to C5. Departure delayed 30 minutes. New boarding time: 4:45 PM.",
            action: "Update Itinerary",
            icon: "plane"
          },
          {
            title: "School Emergency Contact Update Required",
            category: "Education", 
            date: "Today",
            priority: "High",
            insight: "School requires updated emergency contacts by tomorrow. Missing: backup childcare provider info.",
            action: "Update Contacts",
            icon: "phone"
          },
          {
            title: "Doctor Appointment Confirmation Needed",
            category: "Healthcare",
            date: "Today", 
            priority: "High",
            insight: "Dr. Martinez's office needs confirmation for Emma's check-up tomorrow at 2 PM. Reply by 5 PM today.",
            action: "Confirm Appointment",
            icon: "calendar-check"
          },
          {
            title: "Parent-Teacher Conference Rescheduled",
            category: "Family",
            date: "Today",
            priority: "High", 
            insight: "Mrs. Johnson moved our conference from Thursday 3 PM to Friday 2 PM due to illness.",
            action: "Add to Calendar",
            icon: "calendar-days"
          }
        ]
      };
    }
    
    function getMockCalendarEvents() {
      return {
        success: true,
        upcomingEvents: [
          {
            title: 'Parent-Teacher Conference',
            time: '2:00 PM - 3:00 PM',
            date: 'Today',
            type: 'family',
            priority: 'High',
            location: 'Roosevelt Elementary',
            prep: '15 min prep needed'
          },
          {
            title: 'Soccer Practice',
            time: '6:00 PM - 7:30 PM',
            date: 'Today', 
            type: 'family',
            priority: 'Medium',
            location: 'Sports Complex',
            prep: 'Pack water & snacks'
          },
          {
            title: 'Team Standup',
            time: '9:00 AM - 9:30 AM',
            date: 'Tomorrow',
            type: 'work', 
            priority: 'Medium',
            location: 'Virtual',
            prep: 'Review sprint goals'
          },
          {
            title: 'Dentist Appointment - Emma',
            time: '3:30 PM - 4:30 PM',
            date: 'Tomorrow',
            type: 'family',
            priority: 'High', 
            location: 'Smile Dental',
            prep: 'Insurance card & forms'
          },
          {
            title: 'Grocery Shopping',
            time: '10:00 AM - 11:00 AM', 
            date: 'Saturday',
            type: 'personal',
            priority: 'Medium',
            location: 'Whole Foods',
            prep: 'Shopping list ready'
          },
          {
            title: 'Birthday Party - Jake',
            time: '2:00 PM - 5:00 PM',
            date: 'Saturday', 
            type: 'family',
            priority: 'High',
            location: 'Community Center',
            prep: 'Gift & card ready'
          }
        ],
        weeklyLoad: 72,
        upcomingCount: 6
      };
    }
    
    function getMockCommerceUpdates() {
      // Get user's brand preferences for personalization
      const userPrefs = getUserBrandPreferences();
      const brandInsights = extractBrandInsights(userPrefs.customizationText || '');
      
      console.log('🎯 Personalizing deals based on user preferences:', brandInsights);
      
      // Base deal templates that can be personalized
      const dealTemplates = [
        // Tech & Electronics
        {
          brands: ['apple', 'samsung', 'google'],
          template: {
            title: "Apple Store Exclusive Deal",
            item: "AirPods Pro (2nd Generation)",
            brand: "Apple",
            category: "Electronics",
            originalPrice: "$249.99",
            currentPrice: "$179.99",
            savings: "$70.00",
            loyaltyPoints: "1,800 points earned",
            confidence: "High",
            action: "Shop Now",
            urgency: "Limited time - 48 hours only",
            source: "Apple Store Email",
            description: "Your favorite tech brand has a rare discount! Perfect for your active lifestyle.",
            icon: "headphones"
          }
        },
        // Family & Kids
        {
          condition: () => brandInsights.hasKids === true,
          template: {
            title: "Target Circle Family Deal",
            item: (brandInsights.kidsAge && brandInsights.kidsAge < 10) ? "LEGO Creator Set" : "Nintendo Switch Game Bundle",
            brand: "Target",
            category: "Family",
            originalPrice: "$89.99",
            currentPrice: "$59.99",
            savings: "$30.00",
            loyaltyPoints: "1,200 points + 5% RedCard discount",
            confidence: "High",
            action: "Add to Cart",
            urgency: "Back-to-school special ends Monday",
            source: "Target Circle Email",
            description: `Perfect for ${brandInsights.kidsAge ? `your ${brandInsights.kidsAge}-year-old` : 'the kids'}! Top-rated by other parents.`,
            icon: "gift"
          }
        },
        // Fitness & Outdoor
        {
          interests: ['fitness', 'outdoor'],
          template: {
            title: "REI Co-op Member Exclusive",
            item: "Patagonia Down Jacket",
            brand: "Patagonia",
            category: "Outdoor & Fitness",
            originalPrice: "$229.99",
            currentPrice: "$159.99",
            savings: "$70.00",
            loyaltyPoints: "10% member dividend",
            confidence: "High",
            action: "Claim Deal",
            urgency: "Member-only sale ends this weekend",
            source: "REI Member Email",
            description: "Sustainable outdoor gear from your preferred eco-friendly brand. Perfect for your hiking adventures!",
            icon: "mountain"
          }
        },
        // Home & Kitchen
        {
          interests: ['cooking', 'home'],
          template: {
            title: "Williams Sonoma Flash Sale",
            item: "All-Clad Stainless Steel Cookware Set",
            brand: "All-Clad",
            category: "Home & Kitchen",
            originalPrice: "$499.99",
            currentPrice: "$349.99",
            savings: "$150.00",
            loyaltyPoints: "1,750 points earned",
            confidence: "High",
            action: "Shop Sale",
            urgency: "Chef's choice sale - today only",
            source: "Williams Sonoma Email",
            description: "Professional-grade cookware for your culinary adventures. Highly rated by cooking enthusiasts!",
            icon: "chef-hat"
          }
        },
        // Grocery & Food
        {
          brands: ['whole foods', 'trader joes', 'costco'],
          budgetPrefs: ['organic'],
          template: {
            title: "Whole Foods Prime Member Deal",
            item: "Organic Produce Box (Family Size)",
            brand: "Whole Foods",
            category: "Grocery",
            originalPrice: "$79.99",
            currentPrice: "$54.99",
            savings: "$25.00",
            loyaltyPoints: "Additional 10% Prime discount",
            confidence: "Medium",
            action: "Order Now",
            urgency: "Weekly organic box - order by Thursday",
            source: "Whole Foods Prime Email",
            description: "Farm-fresh organic produce delivered to your door. Perfect for your healthy lifestyle goals!",
            icon: "apple"
          }
        },
        // Default fallback deals
        {
          template: {
            title: "Amazon Prime Day Flash Deal",
            item: "Dyson V15 Cordless Vacuum",
            brand: "Dyson",
            category: "Home & Garden",
            originalPrice: "$749.99",
            currentPrice: "$449.99",
            savings: "$300.00",
            loyaltyPoints: "2,250 points earned",
            confidence: "High",
            action: "Claim Deal",
            urgency: "Deal ends in 4 hours",
            source: "Amazon Prime Email",
            description: "Top-rated vacuum cleaner with excellent reviews. Great for busy households!",
            icon: "zap"
          }
        }
      ];
      
      // Filter and select deals based on user preferences
      const personalizedDeals = [];
      
      for (const dealTemplate of dealTemplates) {
        let shouldInclude = false;
        
        // Check brand preferences
        if (dealTemplate.brands && brandInsights.mentionedBrands && Array.isArray(brandInsights.mentionedBrands)) {
          shouldInclude = dealTemplate.brands.some(brand => 
            brandInsights.mentionedBrands.includes(brand)
          );
        }
        
        // Check interests
        if (dealTemplate.interests && brandInsights.interests && Array.isArray(brandInsights.interests)) {
          shouldInclude = shouldInclude || dealTemplate.interests.some(interest => 
            brandInsights.interests.includes(interest)
          );
        }
        
        // Check budget preferences
        if (dealTemplate.budgetPrefs && brandInsights.budgetPrefs && Array.isArray(brandInsights.budgetPrefs)) {
          shouldInclude = shouldInclude || dealTemplate.budgetPrefs.some(pref => 
            brandInsights.budgetPrefs.includes(pref)
          );
        }
        
        // Check custom conditions
        if (dealTemplate.condition) {
          shouldInclude = shouldInclude || dealTemplate.condition();
        }
        
        // Always include default deals if no preferences are set
        if (!dealTemplate.brands && !dealTemplate.interests && !dealTemplate.budgetPrefs && !dealTemplate.condition) {
          shouldInclude = personalizedDeals.length < 3; // Fill up to 3 deals
        }
        
        if (shouldInclude && personalizedDeals.length < 3) {
          personalizedDeals.push(dealTemplate.template);
        }
      }
      
      // If no personalized deals found, use default deals
      if (personalizedDeals.length === 0) {
        personalizedDeals.push(
          dealTemplates[dealTemplates.length - 1].template, // Default Dyson deal
          {
            title: "Target Circle Weekly Special",
            item: "Household Essentials Bundle",
            brand: "Target",
            category: "Home",
            originalPrice: "$54.99",
            currentPrice: "$39.99",
            savings: "$15.00",
            loyaltyPoints: "800 points + 5% RedCard discount",
            confidence: "Medium",
            action: "Add to Cart",
            urgency: "Circle member exclusive",
            source: "Target Circle Email",
            description: "Essential household items at great value. Stock up and save!",
            icon: "shopping-cart"
          }
        );
      }
      
      console.log(`✨ Generated ${personalizedDeals.length} personalized deals based on user preferences`);
      
      return {
        success: true,
        insights: personalizedDeals,
        personalizedBy: userPrefs.customizationText ? 'user preferences' : 'default selection'
      };
    }
    
    function getMockTotalInsights() {
      return {
        success: true,
        insights: [
          {
            title: "Weekly Schedule Optimization",
            category: "Productivity",
            insight: "You have 3 conflicting appointments next Tuesday. Consider rescheduling the 2 PM dentist visit.",
            action: "Review Schedule",  
            icon: "calendar",
            priority: "Medium"
          },
          {
            title: "Budget Alert - Dining Out",
            category: "Finance",
            insight: "Dining expenses are 40% above monthly budget. 8 restaurant visits this week vs usual 3.",
            action: "Review Expenses",
            icon: "dollar-sign", 
            priority: "Medium"
          },
          {
            title: "Email Productivity Pattern",
            category: "Communication", 
            insight: "You respond fastest to school emails (avg 2 hours) but work emails take 8+ hours.",
            action: "Set Email Rules",
            icon: "mail",
            priority: "Low"
          },
          {
            title: "Sleep Schedule Impact",
            category: "Health",
            insight: "Late evening activities correlate with 6.2 hour sleep average. Optimal is 7-8 hours.",
            action: "Adjust Schedule",
            icon: "moon",
            priority: "High"
          }
        ]
      };
    }
    
    function getMockRecentActivity() {
      return {
        success: true,
        activity: [
          { type: 'email', text: 'Processed 23 new emails (4 urgent, 8 actionable)' },
          { type: 'calendar', text: 'Calendar: 6 events this week (medium load)' },
          { type: 'commerce', text: 'Found 3 shopping opportunities with time sensitivity' }, 
          { type: 'system', text: 'Updated intelligence patterns based on your feedback' },
          { type: 'email', text: 'Gmail sync completed - 2 new priority senders identified' },
          { type: 'calendar', text: 'Detected potential scheduling conflict for Tuesday' }
        ]
      };
    }
    
    function getMockInsights() {
      return {
        success: true,
        insights: [
          {
            title: "Soccer Equipment Needed",
            category: "Family",
            date: "2025-07-28",
            priority: "High", 
            insight: "Emma needs new cleats before practice starts Monday. Size 6Y required.",
            action: "Create Shopping List",
            icon: "zap"
          },
          {
            title: "Flight Itinerary Updated", 
            category: "Travel",
            date: "2025-07-28",
            priority: "High",
            insight: "Delta flight to Orlando moved from 8:15 AM to 10:30 AM. Gate change to B7.",
            action: "Update Calendar",
            icon: "plane"
          },
          {
            title: "School Form Deadline",
            category: "Education",
            date: "2025-07-27", 
            priority: "Medium",
            insight: "Emergency contact form due Friday. Missing backup guardian information.",
            action: "Complete Form",
            icon: "graduation-cap"
          }
        ]
      };
    }
    
        // Load summary tile data with personalization
    async function loadSummaryData() {
      try {
        // Use mock data in development mode
        if (DEVELOPMENT_MODE) {
          console.log('🎭 Using mock data for development');
          const data = getMockDashboardSummary();
          
          if (data.success) {
            updateSummaryTiles(data.summary);
            dashboardData.summary = data.summary;
            dashboardData.currentUser = data.currentUser;
            
            // Also load insights and activity with mock data
            loadInsightsData();
            loadActivityData();
          }
          return;
        }
        
        const userId = dashboardData.currentUser || 'default';
        const response = await fetch(`/api/dashboard-summary?userId=${userId}`);
        const data = await response.json();
        
        if (data.success) {
          dashboardData.summary = data.summary;
          updateSummaryTiles(data.summary);
          console.log('📊 Personalized summary loaded for:', userId);
        } else {
          throw new Error('Failed to load summary data');
        }
      } catch (error) {
        console.warn('Using fallback summary data:', error);
        const fallbackSummary = { urgent: 6, events: 3, commerce: 4, insights: 23 };
        dashboardData.summary = fallbackSummary;
        updateSummaryTiles(fallbackSummary);
      }
    }
    
    // Load insights data with personalization
    async function loadInsightsData() {
      try {
        // Use mock data in development mode
        if (DEVELOPMENT_MODE) {
          console.log('🎭 Using mock insights data');
          const data = getMockInsights();
          
          if (data.success && data.insights) {
            dashboardData.insights = data.insights;
            renderInsights(data.insights);
            console.log('🧠 Mock insights loaded');
          }
          return;
        }
        
        const userId = dashboardData.currentUser || 'default';
        const response = await fetch(`/api/email-intelligence?userId=${userId}&limit=5&days=7`);
        const data = await response.json();
        
        if (data.success && data.insights) {
          dashboardData.insights = data.insights;
          renderInsights(data.insights);
          console.log('🧠 Personalized insights loaded for:', userId);
        } else {
          throw new Error('Failed to load insights data');
        }
      } catch (error) {
        console.warn('Using fallback insights data:', error);
        loadFallbackInsights();
      }
    }
    
    // Load activity timeline data with personalization
    async function loadActivityData() {
      try {
        // Use mock data in development mode
        if (DEVELOPMENT_MODE) {
          console.log('🎭 Using mock activity data');
          const data = getMockRecentActivity();
          
          if (data.success && data.activity) {
            dashboardData.activity = data.activity;
            renderActivity(data.activity);
            console.log('🔄 Mock activity loaded');
          }
          return;
        }
        
        const userId = dashboardData.currentUser || 'default';
        const response = await fetch(`/api/recent-activity?userId=${userId}&days=7`);
        const data = await response.json();
        
        if (data.success && data.activity) {
          dashboardData.activity = data.activity;
          renderActivity(data.activity);
          console.log('🔄 Personalized activity loaded for:', userId);
        } else {
          throw new Error('Failed to load activity data');
        }
      } catch (error) {
        console.warn('Using fallback activity data:', error);
        loadFallbackActivity();
      }
    }
    
    // Load insights data
    async function loadInsightsData() {
      try {
        const response = await fetch('/api/email-intelligence?limit=5&days=7');
        const data = await response.json();
        
        if (data.success && data.insights) {
          dashboardData.insights = data.insights;
          renderInsights(data.insights);
        } else {
          throw new Error('Failed to load insights data');
        }
      } catch (error) {
        console.warn('Using fallback insights data:', error);
        loadFallbackInsights();
      }
    }
    
    // Load activity timeline data
    async function loadActivityData() {
      try {
        const response = await fetch('/api/recent-activity?days=7');
        const data = await response.json();
        
        if (data.success && data.activity) {
          dashboardData.activity = data.activity;
          renderActivity(data.activity);
        } else {
          throw new Error('Failed to load activity data');
        }
      } catch (error) {
        console.warn('Using fallback activity data:', error);
        loadFallbackActivity();
      }
    }
    
    // Update summary tiles
    function updateSummaryTiles(summary) {
      document.getElementById('urgent-count').textContent = summary.urgent || 0;
      document.getElementById('events-count').textContent = summary.events || 0;
      document.getElementById('commerce-count').textContent = summary.commerce || 0;
      document.getElementById('insights-count').textContent = summary.insights || 0;
    }
    
    // Render insights
    function renderInsights(insights) {
      const container = document.getElementById('insights-container');
      
      // Ensure insights is an array
      if (!insights || !Array.isArray(insights) || insights.length === 0) {
        container.innerHTML = `
          <div class="loading-state">
            <i data-lucide="inbox" style="width: 24px; height: 24px; margin-bottom: 8px;"></i>
            <div>No insights available</div>
          </div>
        `;
        lucide.createIcons();
        return;
      }
      
      container.innerHTML = insights.map(insight => `
        <div class="insight-card">
          <div class="insight-header">
            <div class="insight-icon">
              <i data-lucide="${insight.icon || 'info'}" style="width: 20px; height: 20px;"></i>
            </div>
            <div class="insight-content">
              <div class="insight-title">${insight.title}</div>
              <div class="insight-meta">
                <span>${insight.category}</span>
                <span>•</span>
                <span>${insight.date}</span>
                <span>•</span>
                <span style="color: ${getPriorityColor(insight.priority)}">${insight.priority}</span>
              </div>
              <div class="insight-text">${insight.insight}</div>
              <div class="insight-actions">
                <button class="action-btn primary" onclick="expandInsight('${insight.title}')">
                  <i data-lucide="expand" style="width: 14px; height: 14px;"></i>
                  Expand
                </button>
                <button class="action-btn" onclick="dismissInsight('${insight.title}')">
                  <i data-lucide="x" style="width: 14px; height: 14px;"></i>
                  Dismiss
                </button>
              </div>
            </div>
          </div>
        </div>
      `).join('');
      
      // Re-initialize Lucide icons
      lucide.createIcons();
    }
    
    // Render activity timeline
    function renderActivity(activities) {
      const container = document.getElementById('activity-timeline');
      
      if (!activities || activities.length === 0) {
        container.innerHTML = `
          <div class="loading-state">
            <i data-lucide="clock" style="width: 20px; height: 20px; margin-bottom: 8px;"></i>
            <div>No recent activity</div>
          </div>
        `;
        lucide.createIcons();
        return;
      }
      
      container.innerHTML = activities.map(activity => `
        <div class="timeline-item">
          <div class="timeline-icon ${activity.type}"></div>
          <div>${activity.text}</div>
        </div>
      `).join('');
    }
    
    // Utility functions
    function getPriorityColor(priority) {
      switch(priority?.toLowerCase()) {
        case 'high': return '#ef4444';
        case 'medium': return '#f59e0b';
        case 'low': return '#22c55e';
        default: return '#6b7280';
      }
    }
    
    function checkReframeSection() {
      const urgentCount = dashboardData.summary.urgent || 0;
      if (urgentCount > 5) {
        document.getElementById('reframe-section').style.display = 'block';
        document.getElementById('reframe-text').textContent = 
          `You've had ${urgentCount} urgent messages this week. Want a mindset reset for your next meeting?`;
      }
    }
    
    // Action handlers
    async function handleAction(action, title) {
      console.log(`Action: ${action} for ${title}`);
      
      if (action === 'Add to Calendar') {
        try {
          const response = await fetch('/api/calendar-events', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ title, action: 'add' })
          });
          const result = await response.json();
          if (result.success) {
            showNotification(`✅ Added "${title}" to calendar`);
          } else {
            showNotification(`❌ Failed to add to calendar: ${result.error}`);
          }
        } catch (error) {
          console.error('Calendar action error:', error);
          showNotification(`📅 Calendar action: ${action} for "${title}"`);
        }
      } else {
        showNotification(`⚡ ${action} action triggered for: ${title}`);
      }
    }
    
    function expandInsight(title) {
      console.log(`Expanding insight: ${title}`);
      const insight = dashboardData.insights.find(i => i.title === title);
      
      if (insight) {
        const priorityColor = insight.priority === 'High' ? '#ef4444' : 
                             insight.priority === 'Medium' ? '#f59e0b' : '#22c55e';
        
        // Mock additional data for expanded view
        const expandedData = {
          aiConfidence: Math.floor(Math.random() * 30) + 70, // 70-100%
          relatedEmails: Math.floor(Math.random() * 5) + 2,
          timesSeen: Math.floor(Math.random() * 10) + 1,
          lastSeen: '2 hours ago',
          suggestedActions: [
            'Set calendar reminder',
            'Create task list',
            'Delegate to family member',
            'Block focus time'
          ].slice(0, Math.floor(Math.random() * 3) + 2)
        };
        
        showModal(`📄 Insight Details: ${insight.title}`, `
          <div style="margin-bottom: 20px;">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
              <div style="
                background: rgba(${priorityColor.slice(1, 3) === 'ef' ? '239, 68, 68' : 
                                 priorityColor.slice(1, 3) === 'f5' ? '245, 158, 11' : '34, 197, 94'}, 0.2);
                border-radius: 8px;
                padding: 12px;
                display: flex;
                align-items: center;
                justify-content: center;
              ">
                <i data-lucide="${insight.icon || 'lightbulb'}" style="width: 24px; height: 24px; color: ${priorityColor};"></i>
              </div>
              <div>
                <h4 style="margin: 0; font-size: 18px; font-weight: 600;">${insight.title}</h4>
                <div style="font-size: 12px; opacity: 0.7; margin-top: 2px;">
                  ${insight.category} • ${insight.date} • Priority: ${insight.priority}
                </div>
              </div>
            </div>
            
            <div style="
              background: rgba(255, 255, 255, 0.05);
              border-radius: 8px;
              padding: 16px;
              margin-bottom: 20px;
            ">
              <h5 style="margin: 0 0 8px 0; font-size: 14px; font-weight: 600;">Full Analysis</h5>
              <p style="margin: 0; font-size: 14px; line-height: 1.5; opacity: 0.9;">
                ${insight.insight}
              </p>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 20px;">
              <div style="
                background: rgba(255, 255, 255, 0.05);
                border-radius: 8px;
                padding: 12px;
                text-align: center;
              ">
                <div style="font-size: 20px; font-weight: 700; color: #22c55e;">${expandedData.aiConfidence}%</div>
                <div style="font-size: 11px; opacity: 0.7;">AI Confidence</div>
              </div>
              <div style="
                background: rgba(255, 255, 255, 0.05);
                border-radius: 8px;
                padding: 12px;
                text-align: center;
              ">
                <div style="font-size: 20px; font-weight: 700; color: #3b82f6;">${expandedData.relatedEmails}</div>
                <div style="font-size: 11px; opacity: 0.7;">Related Emails</div>
              </div>
              <div style="
                background: rgba(255, 255, 255, 0.05);
                border-radius: 8px;
                padding: 12px;
                text-align: center;
              ">
                <div style="font-size: 20px; font-weight: 700; color: #f59e0b;">${expandedData.timesSeen}</div>
                <div style="font-size: 11px; opacity: 0.7;">Times Detected</div>
              </div>
              <div style="
                background: rgba(255, 255, 255, 0.05);
                border-radius: 8px;
                padding: 12px;
                text-align: center;
              ">
                <div style="font-size: 12px; font-weight: 600; color: #8b5cf6;">${expandedData.lastSeen}</div>
                <div style="font-size: 11px; opacity: 0.7;">Last Seen</div>
              </div>
            </div>
            
            <div style="margin-bottom: 20px;">
              <h5 style="margin: 0 0 12px 0; font-size: 14px; font-weight: 600;">AI Suggested Actions</h5>
              <div style="display: flex; flex-direction: column; gap: 8px;">
                ${expandedData.suggestedActions.map((action, index) => `
                  <div style="
                    background: rgba(255, 255, 255, 0.05);
                    border-radius: 6px;
                    padding: 10px;
                    display: flex;
                    align-items: center;
                    gap: 10px;
                  ">
                    <div style="
                      background: rgba(139, 92, 246, 0.3);
                      border-radius: 4px;
                      padding: 4px;
                      display: flex;
                      align-items: center;
                      justify-content: center;
                      min-width: 24px;
                      height: 24px;
                    ">
                      <span style="font-size: 10px; font-weight: 600;">${index + 1}</span>
                    </div>
                    <span style="font-size: 13px;">${action}</span>
                  </div>
                `).join('')}
              </div>
            </div>
            
            <div style="display: flex; justify-content: center; margin-top: 20px;">
              <button onclick="reviewPattern('${insight.title}')" style="
                background: rgba(139, 92, 246, 0.3);
                border: 1px solid rgba(139, 92, 246, 0.5);
                color: white;
                padding: 12px 24px;
                border-radius: 8px;
                cursor: pointer;
                font-size: 14px;
                display: flex;
                align-items: center;
                gap: 8px;
                font-weight: 600;
              ">
                <i data-lucide="trending-up" style="width: 16px; height: 16px;"></i>
                Review Pattern
              </button>
            </div>
          </div>
        `);
        
        // Re-initialize Lucide icons
        setTimeout(() => lucide.createIcons(), 100);
        
      } else {
        showNotification(`📄 Detailed view for: ${title}`);
      }
    }
    
    function dismissInsight(title) {
      console.log(`Dismissing insight: ${title}`);
      const cards = document.querySelectorAll('.insight-card');
      cards.forEach(card => {
        if (card.querySelector('.insight-title').textContent === title) {
          card.style.opacity = '0.5';
          card.style.transform = 'scale(0.95)';
          setTimeout(() => card.remove(), 300);
        }
      });
      
      // Remove from data array
      dashboardData.insights = dashboardData.insights.filter(i => i.title !== title);
    }
    
    async function reframeWeek() {
      console.log('Reframing week...');
      const reframeSection = document.getElementById('reframe-section');
      reframeSection.innerHTML = `
        <div style="display: flex; align-items: center; justify-content: center; gap: 8px;">
          <i data-lucide="loader" style="width: 20px; height: 20px;"></i>
          <span>Generating your personalized mindset reset...</span>
        </div>
      `;
      lucide.createIcons();
      
      try {
        const userId = dashboardData.currentUser || 'default';
        const response = await fetch('/api/emotional-load-forecast', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            action: 'reframe',
            urgentCount: dashboardData.summary.urgent,
            userId: userId
          })
        });
        
        const data = await response.json();
        
        if (data.success) {
          reframeSection.innerHTML = `
            <h3 class="reframe-title">
              <i data-lucide="sparkles" style="width: 20px; height: 20px;"></i>
              Your Personalized Week Reframe
            </h3>
            <p class="reframe-text">${data.reframe}</p>
            <button class="action-btn" onclick="this.parentElement.style.display='none'">
              <i data-lucide="check" style="width: 16px; height: 16px;"></i>
              Thanks, I needed that
            </button>
          `;
        } else {
          throw new Error('Failed to get reframe');
        }
      } catch (error) {
        console.error('Reframe error:', error);
        reframeSection.innerHTML = `
          <h3 class="reframe-title">
            <i data-lucide="sparkles" style="width: 20px; height: 20px;"></i>
            Your Week Reframed
          </h3>
          <p class="reframe-text">
            "You're not managing chaos—you're orchestrating a complex, dynamic system. Every 'urgent' item you've handled shows your family can count on you. Take a breath. You've got this."
          </p>
          <button class="action-btn" onclick="this.parentElement.style.display='none'">
            <i data-lucide="check" style="width: 16px; height: 16px;"></i>
            Thanks, I needed that
          </button>
        `;
      }
      
      lucide.createIcons();
    }
    
    // Fallback data functions
    function loadFallbackData() {
      console.log('📦 Loading fallback data...');
      
      dashboardData.summary = { urgent: 6, events: 3, commerce: 4, insights: 23 };
      updateSummaryTiles(dashboardData.summary);
      
      loadFallbackInsights();
      loadFallbackActivity();
      checkReframeSection();
    }
    
    function loadFallbackInsights() {
      const fallbackInsights = [
        {
          title: "Father-Son Golf Tournament Moved",
          category: "Family",
          date: "2025-07-20",
          priority: "High",
          insight: "Rain delay announced. Rescheduled to 12PM.",
          action: "Add to Calendar",
          icon: "calendar-days"
        },
        {
          title: "School Supply List Updated",
          category: "Education",
          date: "2025-07-19",
          priority: "Medium",
          insight: "New items added: Scientific calculator, art supplies.",
          action: "Create Shopping List",
          icon: "graduation-cap"
        },
        {
          title: "Flight Change Notification",
          category: "Travel",
          date: "2025-07-18",
          priority: "High",
          insight: "Gate changed from B12 to C5. Departure delayed 30 minutes.",
          action: "Update Itinerary",
          icon: "plane"
        }
      ];
      dashboardData.insights = fallbackInsights;
      renderInsights(fallbackInsights);
    }
    
    function loadFallbackActivity() {
      const fallbackActivity = [
        { type: 'email', text: 'Synced Gmail (20 new insights processed)' },
        { type: 'calendar', text: 'Calendar: Added Swim Meet on July 22' },
        { type: 'commerce', text: 'You dismissed 3 commerce emails' },
        { type: 'system', text: 'Intelligence engine updated with new patterns' }
      ];
      dashboardData.activity = fallbackActivity;
      renderActivity(fallbackActivity);
    }
    
    // Interactive tile handlers for real actions
    function setupTileInteractions() {
      // Make summary tiles clickable
      const tiles = document.querySelectorAll('.summary-tile');
      tiles.forEach((tile, index) => {
        tile.style.cursor = 'pointer';
        tile.addEventListener('click', () => handleTileClick(index));
      });
    }
    
    async function handleTileClick(tileIndex) {
      const actions = [
        'urgent-messages',
        'calendar-events', 
        'commerce-updates',
        'total-insights'
      ];
      
      const action = actions[tileIndex];
      console.log(`🎯 Tile clicked: ${action}`);
      
      // Add visual feedback
      const tiles = document.querySelectorAll('.summary-tile');
      const clickedTile = tiles[tileIndex];
      if (clickedTile) {
        clickedTile.style.transform = 'scale(0.95)';
        setTimeout(() => {
          clickedTile.style.transform = '';
        }, 150);
      }
      
      switch(action) {
        case 'urgent-messages':
          await showUrgentMessages();
          break;
        case 'calendar-events':
          await showCalendarEvents();
          break;
        case 'commerce-updates':
          await showCommerceUpdates();
          break;
        case 'total-insights':
          await showTotalInsights();
          break;
      }
    }
    
    async function showUrgentMessages() {
      try {
        // Use mock data in development mode  
        if (DEVELOPMENT_MODE) {
          console.log('🎭 Using mock urgent messages data');
          const data = getMockUrgentMessages();
          const urgentInsights = data.insights;
          
          const urgentCards = urgentInsights.map(insight => `
            <div style="
              background: rgba(255, 255, 255, 0.1);
              border: 1px solid rgba(255, 255, 255, 0.2);
              border-radius: 12px;
              padding: 16px;
              margin-bottom: 16px;
              border-left: 4px solid #ef4444;
            ">
              <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                <div style="
                  background: rgba(239, 68, 68, 0.2);
                  border-radius: 8px;
                  padding: 8px;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                ">
                  <i data-lucide="${insight.icon}" style="width: 20px; height: 20px; color: #ef4444;"></i>
                </div>
                <div>
                  <h4 style="margin: 0; font-size: 16px; font-weight: 600;">${insight.title}</h4>
                  <div style="font-size: 12px; opacity: 0.7; margin-top: 2px;">
                    ${insight.category} • ${insight.date} • Priority: ${insight.priority}
                  </div>
                </div>
              </div>
              
              <p style="margin: 0 0 16px 0; font-size: 14px; line-height: 1.4; opacity: 0.9;">
                ${insight.insight}
              </p>
              
              <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                <button onclick="handleQuickAction('${insight.action}', '${insight.title}')" style="
                  background: rgba(139, 92, 246, 0.3);
                  border: 1px solid rgba(139, 92, 246, 0.5);
                  color: white;
                  padding: 8px 12px;
                  border-radius: 6px;
                  cursor: pointer;
                  font-size: 12px;
                  display: flex;
                  align-items: center;
                  gap: 6px;
                ">
                  <i data-lucide="plus" style="width: 12px; height: 12px;"></i>
                  ${insight.action}
                </button>
                <button onclick="openEmailLink('${insight.title}')" style="
                  background: rgba(34, 197, 94, 0.3);
                  border: 1px solid rgba(34, 197, 94, 0.5);
                  color: white;
                  padding: 8px 12px;
                  border-radius: 6px;
                  cursor: pointer;
                  font-size: 12px;
                  display: flex;
                  align-items: center;
                  gap: 6px;
                ">
                  <i data-lucide="external-link" style="width: 12px; height: 12px;"></i>
                  View Email
                </button>
                <button onclick="provideFeedback('${insight.title}', 'urgent')" style="
                  background: rgba(245, 158, 11, 0.3);
                  border: 1px solid rgba(245, 158, 11, 0.5);
                  color: white;
                  padding: 8px 12px;
                  border-radius: 6px;
                  cursor: pointer;
                  font-size: 12px;
                  display: flex;
                  align-items: center;
                  gap: 6px;
                ">
                  <i data-lucide="message-circle" style="width: 12px; height: 12px;"></i>
                  Feedback
                </button>
              </div>
            </div>
          `).join('');

          showModal(`
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
              <i data-lucide="alert-triangle" style="width: 24px; height: 24px; color: #ef4444;"></i>
              <h2 style="margin: 0;">Urgent Messages</h2>
            </div>
          `, `
            <div style="margin-bottom: 20px;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <div>
                  <h4 style="margin: 0;">Immediate Attention Required</h4>
                  <p style="margin: 0; font-size: 12px; opacity: 0.7;">${urgentInsights.length} messages need response</p>
                </div>
                <div style="text-align: right;">
                  <div style="font-size: 18px; font-weight: 700; color: #ef4444;">${urgentInsights.length}</div>
                  <div style="font-size: 10px; opacity: 0.7;">High Priority</div>
                </div>
              </div>
            </div>
            
            ${urgentCards}
            
            <div style="text-align: center; margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(255, 255, 255, 0.1);">
              <button onclick="markAllAsRead()" style="
                background: rgba(34, 197, 94, 0.3);
                border: 1px solid rgba(34, 197, 94, 0.5);
                color: white;
                padding: 12px 24px;
                border-radius: 8px;
                cursor: pointer;
                font-size: 14px;
                display: inline-flex;
                align-items: center;
                gap: 8px;
              ">
                <i data-lucide="check-circle" style="width: 16px; height: 16px;"></i>
                Mark All as Handled
              </button>
            </div>
          `);
          
          setTimeout(() => lucide.createIcons(), 100);
          return;
        }
        
        const userId = dashboardData.currentUser || 'default';
        const response = await fetch(`/api/email-intelligence?userId=${userId}&filter=urgent`);
        const data = await response.json();
        
        let urgentInsights = [];
        
        // Try to get real urgent messages from API
        if (data.success && data.insights.length > 0) {
          urgentInsights = data.insights.filter(insight => 
            insight.priority === 'High' || insight.category === 'Urgent'
          );
        }
        
        // If no real urgent messages, use fallback urgent messages
        if (urgentInsights.length === 0) {
          urgentInsights = [
            {
              title: "Flight Gate Change - American Airlines",
              category: "Travel",
              date: "Today",
              priority: "High",
              insight: "Gate changed from B12 to C5. Departure delayed 30 minutes. New boarding time: 4:45 PM.",
              action: "Update Itinerary",
              icon: "plane"
            },
            {
              title: "School Emergency Contact Update Required",
              category: "Education",
              date: "Today",
              priority: "High",
              insight: "School requires updated emergency contacts by tomorrow. Missing: backup childcare provider info.",
              action: "Update Contacts",
              icon: "phone"
            },
            {
              title: "Doctor Appointment Confirmation Needed",
              category: "Healthcare",
              date: "Today",
              priority: "High",
              insight: "Dr. Martinez's office needs confirmation for Emma's check-up tomorrow at 2 PM. Reply by 5 PM today.",
              action: "Confirm Appointment",
              icon: "calendar-check"
            },
            {
              title: "Parent-Teacher Conference Rescheduled",
              category: "Family",
              date: "Today",
              priority: "High",
              insight: "Mrs. Johnson moved our conference from Thursday 3 PM to Friday 2 PM due to illness.",
              action: "Add to Calendar",
              icon: "calendar-days"
            }
          ];
        }
        
        const urgentCards = urgentInsights.map(insight => `
          <div style="
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            border-left: 4px solid #ef4444;
          ">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
              <div style="
                background: rgba(239, 68, 68, 0.2);
                border-radius: 8px;
                padding: 8px;
                display: flex;
                align-items: center;
                justify-content: center;
              ">
                <i data-lucide="${insight.icon || 'alert-triangle'}" style="width: 20px; height: 20px; color: #ef4444;"></i>
              </div>
              <div>
                <h4 style="margin: 0; font-size: 16px; font-weight: 600;">${insight.title}</h4>
                <div style="font-size: 12px; opacity: 0.7; margin-top: 2px;">
                  ${insight.category} • ${insight.date} • Priority: ${insight.priority}
                </div>
              </div>
            </div>
            
            <p style="margin: 0 0 16px 0; font-size: 14px; line-height: 1.4; opacity: 0.9;">
              ${insight.insight}
            </p>
            
            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
              <button onclick="handleQuickAction('${insight.action}', '${insight.title}')" style="
                background: rgba(139, 92, 246, 0.3);
                border: 1px solid rgba(139, 92, 246, 0.5);
                color: white;
                padding: 8px 12px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 12px;
                display: flex;
                align-items: center;
                gap: 6px;
              ">
                <i data-lucide="plus" style="width: 12px; height: 12px;"></i>
                ${insight.action}
              </button>
              <button onclick="openEmailLink('${insight.title}')" style="
                background: rgba(34, 197, 94, 0.3);
                border: 1px solid rgba(34, 197, 94, 0.5);
                color: white;
                padding: 8px 12px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 12px;
                display: flex;
                align-items: center;
                gap: 6px;
              ">
                <i data-lucide="external-link" style="width: 12px; height: 12px;"></i>
                View Email
              </button>
              <button onclick="provideFeedback('${insight.title}', 'urgent')" style="
                background: rgba(245, 158, 11, 0.3);
                border: 1px solid rgba(245, 158, 11, 0.5);
                color: white;
                padding: 8px 12px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 12px;
                display: flex;
                align-items: center;
                gap: 6px;
              ">
                <i data-lucide="message-circle" style="width: 12px; height: 12px;"></i>
                Feedback
              </button>
            </div>
          </div>
        `).join('');

        showModal(`
          <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
            <i data-lucide="alert-triangle" style="width: 24px; height: 24px; color: #ef4444;"></i>
            <h2 style="margin: 0;">Urgent Messages</h2>
          </div>
        `, `
          <div style="margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
              <div>
                <h4 style="margin: 0;">Immediate Attention Required</h4>
                <p style="margin: 0; font-size: 12px; opacity: 0.7;">${urgentInsights.length} messages need response</p>
              </div>
              <div style="text-align: right;">
                <div style="font-size: 18px; font-weight: 700; color: #ef4444;">${urgentInsights.length}</div>
                <div style="font-size: 10px; opacity: 0.7;">High Priority</div>
              </div>
            </div>
          </div>
          
          ${urgentCards}
          
          <div style="text-align: center; margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(255, 255, 255, 0.1);">
            <button onclick="markAllAsRead()" style="
              background: rgba(34, 197, 94, 0.3);
              border: 1px solid rgba(34, 197, 94, 0.5);
              color: white;
              padding: 12px 24px;
              border-radius: 8px;
              cursor: pointer;
              font-size: 14px;
              display: inline-flex;
              align-items: center;
              gap: 8px;
            ">
              <i data-lucide="check-circle" style="width: 16px; height: 16px;"></i>
              Mark All as Handled
            </button>
          </div>
        `);
        
        // Re-initialize Lucide icons
        setTimeout(() => lucide.createIcons(), 100);
        
      } catch (error) {
        console.error('❌ Error fetching urgent messages:', error);
        
        // Show fallback urgent messages even on error
        const fallbackUrgentInsights = [
          {
            title: "Flight Gate Change - American Airlines",
            category: "Travel",
            date: "Today",
            priority: "High",
            insight: "Gate changed from B12 to C5. Departure delayed 30 minutes. New boarding time: 4:45 PM.",
            action: "Update Itinerary",
            icon: "plane"
          },
          {
            title: "School Emergency Contact Update Required",
            category: "Education",
            date: "Today",
            priority: "High",
            insight: "School requires updated emergency contacts by tomorrow. Missing: backup childcare provider info.",
            action: "Update Contacts",
            icon: "phone"
          },
          {
            title: "Doctor Appointment Confirmation Needed",
            category: "Healthcare",
            date: "Today",
            priority: "High",
            insight: "Dr. Martinez's office needs confirmation for Emma's check-up tomorrow at 2 PM. Reply by 5 PM today.",
            action: "Confirm Appointment",
            icon: "calendar-check"
          }
        ];
        
        const urgentCards = fallbackUrgentInsights.map(insight => `
          <div style="
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            border-left: 4px solid #ef4444;
          ">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
              <div style="
                background: rgba(239, 68, 68, 0.2);
                border-radius: 8px;
                padding: 8px;
                display: flex;
                align-items: center;
                justify-content: center;
              ">
                <i data-lucide="${insight.icon}" style="width: 20px; height: 20px; color: #ef4444;"></i>
              </div>
              <div>
                <h4 style="margin: 0; font-size: 16px; font-weight: 600;">${insight.title}</h4>
                <div style="font-size: 12px; opacity: 0.7; margin-top: 2px;">
                  ${insight.category} • ${insight.date} • Priority: ${insight.priority}
                </div>
              </div>
            </div>
            
            <p style="margin: 0 0 16px 0; font-size: 14px; line-height: 1.4; opacity: 0.9;">
              ${insight.insight}
            </p>
            
            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
              <button onclick="handleQuickAction('${insight.action}', '${insight.title}')" style="
                background: rgba(139, 92, 246, 0.3);
                border: 1px solid rgba(139, 92, 246, 0.5);
                color: white;
                padding: 8px 12px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 12px;
                display: flex;
                align-items: center;
                gap: 6px;
              ">
                <i data-lucide="plus" style="width: 12px; height: 12px;"></i>
                ${insight.action}
              </button>
              <button onclick="openEmailLink('${insight.title}')" style="
                background: rgba(34, 197, 94, 0.3);
                border: 1px solid rgba(34, 197, 94, 0.5);
                color: white;
                padding: 8px 12px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 12px;
                display: flex;
                align-items: center;
                gap: 6px;
              ">
                <i data-lucide="external-link" style="width: 12px; height: 12px;"></i>
                View Email
              </button>
              <button onclick="provideFeedback('${insight.title}', 'urgent')" style="
                background: rgba(245, 158, 11, 0.3);
                border: 1px solid rgba(245, 158, 11, 0.5);
                color: white;
                padding: 8px 12px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 12px;
                display: flex;
                align-items: center;
                gap: 6px;
              ">
                <i data-lucide="message-circle" style="width: 12px; height: 12px;"></i>
                Feedback
              </button>
            </div>
          </div>
        `).join('');

        showModal(`
          <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
            <i data-lucide="alert-triangle" style="width: 24px; height: 24px; color: #ef4444;"></i>
            <h2 style="margin: 0;">Urgent Messages</h2>
          </div>
        `, `
          <div style="margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
              <div>
                <h4 style="margin: 0;">Immediate Attention Required</h4>
                <p style="margin: 0; font-size: 12px; opacity: 0.7;">${fallbackUrgentInsights.length} messages need response</p>
              </div>
              <div style="text-align: right;">
                <div style="font-size: 18px; font-weight: 700; color: #ef4444;">${fallbackUrgentInsights.length}</div>
                <div style="font-size: 10px; opacity: 0.7;">High Priority</div>
              </div>
            </div>
          </div>
          
          ${urgentCards}
          
          <div style="text-align: center; margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(255, 255, 255, 0.1);">
            <button onclick="markAllAsRead()" style="
              background: rgba(34, 197, 94, 0.3);
              border: 1px solid rgba(34, 197, 94, 0.5);
              color: white;
              padding: 12px 24px;
              border-radius: 8px;
              cursor: pointer;
              font-size: 14px;
              display: inline-flex;
              align-items: center;
              gap: 8px;
            ">
              <i data-lucide="check-circle" style="width: 16px; height: 16px;"></i>
              Mark All as Handled
            </button>
          </div>
        `);
        
        setTimeout(() => lucide.createIcons(), 100);
      }
    }

    function markAllAsRead() {
      showNotification('✅ All urgent messages marked as handled!');
      
      // Close the modal
      const modal = document.querySelector('.modal-overlay');
      if (modal) modal.remove();
      
      // Update the urgent count to 0
      const urgentTile = document.getElementById('urgent-count');
      if (urgentTile) urgentTile.textContent = '0';
    }
    
    async function showCalendarEvents() {
      try {
        // Use mock data in development mode
        if (DEVELOPMENT_MODE) {
          console.log('🎭 Using mock calendar events data');
          const data = getMockCalendarEvents();
          const eventsToShow = data.upcomingEvents;
          const weekLoad = data.weeklyLoad;
          const activityData = getMockRecentActivity();
          const calendarActivity = activityData.activity.filter(item => item.type === 'calendar');
          
          const eventCards = eventsToShow.map(event => `
            <div style="
              background: rgba(255, 255, 255, 0.1);
              border: 1px solid rgba(255, 255, 255, 0.2);
              border-radius: 12px;
              padding: 16px;
              margin-bottom: 12px;
              border-left: 4px solid ${event.type === 'family' ? '#22c55e' : '#3b82f6'};
            ">
              <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                <div>
                  <h4 style="margin: 0; font-size: 16px; font-weight: 600;">${event.title}</h4>
                  <div style="font-size: 12px; opacity: 0.7; margin-top: 2px;">
                    ${event.date} • ${event.time}
                  </div>
                </div>
                <div style="
                  background: rgba(${event.type === 'family' ? '34, 197, 94' : '59, 130, 246'}, 0.2);
                  padding: 4px 8px;
                  border-radius: 12px;
                  font-size: 10px;
                  font-weight: 600;
                  text-transform: uppercase;
                ">${event.type}</div>
              </div>
              
              <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 12px; font-size: 14px;">
                <div style="display: flex; align-items: center; gap: 6px; opacity: 0.8;">
                  <i data-lucide="map-pin" style="width: 14px; height: 14px;"></i>
                  ${event.location}
                </div>
                <div style="display: flex; align-items: center; gap: 6px; opacity: 0.8;">
                  <i data-lucide="clock" style="width: 14px; height: 14px;"></i>
                  ${event.prep}
                </div>
              </div>
              
              <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                <button onclick="handleCalendarAction('prep', '${event.title}', ${JSON.stringify(event).replace(/"/g, '&quot;')})" style="
                  background: rgba(139, 92, 246, 0.3);
                  border: 1px solid rgba(139, 92, 246, 0.5);
                  color: white;
                  padding: 6px 12px;
                  border-radius: 6px;
                  cursor: pointer;
                  font-size: 12px;
                  display: flex;
                  align-items: center;
                  gap: 6px;
                ">
                  <i data-lucide="check-square" style="width: 12px; height: 12px;"></i>
                  Prep Done
                </button>
                <button onclick="handleCalendarAction('reschedule', '${event.title}', ${JSON.stringify(event).replace(/"/g, '&quot;')})" style="
                  background: rgba(245, 158, 11, 0.3);
                  border: 1px solid rgba(245, 158, 11, 0.5);
                  color: white;
                  padding: 6px 12px;
                  border-radius: 6px;
                  cursor: pointer;
                  font-size: 12px;
                  display: flex;
                  align-items: center;
                  gap: 6px;
                ">
                  <i data-lucide="calendar" style="width: 12px; height: 12px;"></i>
                  Reschedule
                </button>
                <button onclick="provideCalendarFeedback('${event.title}', ${JSON.stringify(event).replace(/"/g, '&quot;')})" style="
                  background: rgba(34, 197, 94, 0.3);
                  border: 1px solid rgba(34, 197, 94, 0.5);
                  color: white;
                  padding: 6px 12px;
                  border-radius: 6px;
                  cursor: pointer;
                  font-size: 12px;
                  display: flex;
                  align-items: center;
                  gap: 6px;
                ">
                  <i data-lucide="message-circle" style="width: 12px; height: 12px;"></i>
                  Feedback
                </button>
              </div>
            </div>
          `).join('');
          
          const loadColor = weekLoad > 80 ? '#ef4444' : weekLoad > 60 ? '#f59e0b' : '#22c55e';
          
          showModal(`
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
              <i data-lucide="calendar" style="width: 24px; height: 24px; color: white;"></i>
              <h2 style="margin: 0;">Calendar Overview</h2>
            </div>
          `, `
            <div style="margin-bottom: 20px;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <div>
                  <h4 style="margin: 0;">This Week's Events</h4>
                  <p style="margin: 0; font-size: 12px; opacity: 0.7;">${eventsToShow.length} events scheduled</p>
                </div>
                <div style="text-align: right;">
                  <div style="font-size: 24px; font-weight: 700; color: ${loadColor};">${weekLoad}%</div>
                  <div style="font-size: 10px; opacity: 0.7;">Weekly Load</div>
                </div>
              </div>
              
              <div style="
                background: rgba(255, 255, 255, 0.05);
                border-radius: 8px;
                padding: 12px;
                margin-bottom: 16px;
              ">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                  <i data-lucide="activity" style="width: 16px; height: 16px; color: #3b82f6;"></i>
                  <span style="font-size: 14px; font-weight: 600;">Activity Summary</span>
                </div>
                ${calendarActivity.map(item => `
                  <div style="font-size: 14px; opacity: 0.8; margin-bottom: 4px;">• ${item.text}</div>
                `).join('')}
              </div>
            </div>
            
            ${eventCards}
            
            <div style="text-align: center; margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(255, 255, 255, 0.1);">
              <button onclick="connectCalendar()" style="
                background: rgba(34, 197, 94, 0.3);
                border: 1px solid rgba(34, 197, 94, 0.5);
                color: white;
                padding: 12px 24px;
                border-radius: 8px;
                cursor: pointer;
                font-size: 14px;
                display: inline-flex;
                align-items: center;
                gap: 8px;
              ">
                <i data-lucide="calendar-plus" style="width: 16px; height: 16px;"></i>
                Connect Google Calendar for Real Data
              </button>
            </div>
          `);
          
          setTimeout(() => lucide.createIcons(), 100);
          return;
        }
        
        const userId = dashboardData.currentUser || 'default';
        const response = await fetch(`/api/recent-activity?userId=${userId}`);
        const data = await response.json();
        
        if (data.success) {
          // Get real calendar data from emotional load forecast API
          const calendarResponse = await fetch(`/api/emotional-load-forecast?userId=${userId}`);
          const forecastData = await calendarResponse.json();
          
          const calendarActivity = data.activity.filter(item => item.type === 'calendar');
          
          // Use real calendar events from the API
          let realEvents = [];
          if (forecastData.success && forecastData.upcomingEvents) {
            realEvents = forecastData.upcomingEvents.map(event => ({
              title: event.title || event.summary || 'Untitled Event',
              time: event.timeDisplay || formatEventTime(event.start, event.end),
              date: formatEventDate(event.start),
              type: categorizeEventType(event.title || event.summary || ''),
              priority: calculateEventPriority(event),
              location: event.location || 'Not specified',
              prep: generatePrepTime(event)
            }));
          }
          
          // Fallback to mock events if no real events available
          const mockEvents = [
            {
              title: 'Parent-Teacher Conference',
              time: '2:00 PM - 3:00 PM',
              date: 'Today',
              type: 'family',
              priority: 'High',
              location: 'School',
              prep: '15 min prep needed'
            },
            {
              title: 'Soccer Practice',
              time: '6:00 PM - 7:30 PM', 
              date: 'Today',
              type: 'family',
              priority: 'Medium',
              location: 'Sports Complex',
              prep: 'Pack water & snacks'
            },
            {
              title: 'Team Standup',
              time: '9:00 AM - 9:30 AM',
              date: 'Tomorrow',
              type: 'work',
              priority: 'Medium',
              location: 'Virtual',
              prep: 'Review sprint goals'
            }
          ];
          
          const eventsToShow = realEvents.length > 0 ? realEvents : mockEvents;
          
          const eventCards = eventsToShow.map(event => `
            <div style="
              background: rgba(255, 255, 255, 0.1);
              border: 1px solid rgba(255, 255, 255, 0.2);
              border-radius: 12px;
              padding: 16px;
              margin-bottom: 12px;
              border-left: 4px solid ${event.type === 'family' ? '#22c55e' : '#3b82f6'};
            ">
              <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                <div>
                  <h4 style="margin: 0; font-size: 16px; font-weight: 600;">${event.title}</h4>
                  <div style="font-size: 12px; opacity: 0.7; margin-top: 2px;">
                    ${event.date} • ${event.time}
                  </div>
                </div>
                <div style="
                  background: rgba(${event.type === 'family' ? '34, 197, 94' : '59, 130, 246'}, 0.2);
                  padding: 4px 8px;
                  border-radius: 12px;
                  font-size: 10px;
                  font-weight: 600;
                  text-transform: uppercase;
                ">${event.type}</div>
              </div>
              
              <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 12px; font-size: 14px;">
                <div style="display: flex; align-items: center; gap: 6px; opacity: 0.8;">
                  <i data-lucide="map-pin" style="width: 14px; height: 14px;"></i>
                  ${event.location}
                </div>
                <div style="display: flex; align-items: center; gap: 6px; opacity: 0.8;">
                  <i data-lucide="clock" style="width: 14px; height: 14px;"></i>
                  ${event.prep}
                </div>
              </div>
              
              <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                <button onclick="handleCalendarAction('prep', '${event.title}', ${JSON.stringify(event).replace(/"/g, '&quot;')})" style="
                  background: rgba(139, 92, 246, 0.3);
                  border: 1px solid rgba(139, 92, 246, 0.5);
                  color: white;
                  padding: 6px 12px;
                  border-radius: 6px;
                  cursor: pointer;
                  font-size: 12px;
                  display: flex;
                  align-items: center;
                  gap: 6px;
                ">
                  <i data-lucide="check-square" style="width: 12px; height: 12px;"></i>
                  Prep Done
                </button>
                <button onclick="handleCalendarAction('reschedule', '${event.title}', ${JSON.stringify(event).replace(/"/g, '&quot;')})" style="
                  background: rgba(245, 158, 11, 0.3);
                  border: 1px solid rgba(245, 158, 11, 0.5);
                  color: white;
                  padding: 6px 12px;
                  border-radius: 6px;
                  cursor: pointer;
                  font-size: 12px;
                  display: flex;
                  align-items: center;
                  gap: 6px;
                ">
                  <i data-lucide="calendar" style="width: 12px; height: 12px;"></i>
                  Reschedule
                </button>
                <button onclick="provideCalendarFeedback('${event.title}', ${JSON.stringify(event).replace(/"/g, '&quot;')})" style="
                  background: rgba(34, 197, 94, 0.3);
                  border: 1px solid rgba(34, 197, 94, 0.5);
                  color: white;
                  padding: 6px 12px;
                  border-radius: 6px;
                  cursor: pointer;
                  font-size: 12px;
                  display: flex;
                  align-items: center;
                  gap: 6px;
                ">
                  <i data-lucide="message-circle" style="width: 12px; height: 12px;"></i>
                  Feedback
                </button>
              </div>
            </div>
          `).join('');
          
          const weekLoad = forecastData.success ? Math.round(forecastData.averageLoad) : 65;
          const loadColor = weekLoad > 80 ? '#ef4444' : weekLoad > 60 ? '#f59e0b' : '#22c55e';
          
          showModal(`
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
              <i data-lucide="calendar" style="width: 24px; height: 24px; color: white;"></i>
              <h2 style="margin: 0;">Calendar Overview</h2>
            </div>
          `, `
            <div style="margin-bottom: 20px;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <div>
                  <h4 style="margin: 0;">This Week's Events</h4>
                  <p style="margin: 0; font-size: 12px; opacity: 0.7;">${eventsToShow.length} events scheduled</p>
                </div>
                <div style="text-align: right;">
                  <div style="font-size: 24px; font-weight: 700; color: ${loadColor};">${weekLoad}%</div>
                  <div style="font-size: 10px; opacity: 0.7;">Weekly Load</div>
                </div>
              </div>
              
              <div style="
                background: rgba(255, 255, 255, 0.05);
                border-radius: 8px;
                padding: 12px;
                margin-bottom: 16px;
              ">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                  <i data-lucide="activity" style="width: 16px; height: 16px; color: #3b82f6;"></i>
                  <span style="font-size: 14px; font-weight: 600;">Activity Summary</span>
                </div>
                ${calendarActivity.map(item => `
                  <div style="font-size: 14px; opacity: 0.8; margin-bottom: 4px;">• ${item.text}</div>
                `).join('')}
              </div>
            </div>
            
            ${eventCards}
            
            <div style="text-align: center; margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(255, 255, 255, 0.1);">
              <button onclick="connectCalendar()" style="
                background: rgba(34, 197, 94, 0.3);
                border: 1px solid rgba(34, 197, 94, 0.5);
                color: white;
                padding: 12px 24px;
                border-radius: 8px;
                cursor: pointer;
                font-size: 14px;
                display: inline-flex;
                align-items: center;
                gap: 8px;
              ">
                <i data-lucide="calendar-plus" style="width: 16px; height: 16px;"></i>
                Connect Google Calendar for Real Data
              </button>
            </div>
          `);
          
          // Re-initialize Lucide icons
          setTimeout(() => lucide.createIcons(), 100);
        }
      } catch (error) {
        console.error('❌ Error fetching calendar events:', error);
        showModal(`
          <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
            <i data-lucide="x-circle" style="width: 24px; height: 24px; color: #ef4444;"></i>
            <h2 style="margin: 0;">Error</h2>
          </div>
        `, `
          <div style="text-align: center; padding: 20px;">
            <div style="display: flex; align-items: center; justify-content: center; margin-bottom: 16px;">
              <i data-lucide="alert-triangle" style="width: 48px; height: 48px; color: #f59e0b;"></i>
            </div>
            <h4 style="margin-bottom: 8px;">Connection Error</h4>
            <p style="opacity: 0.8;">Unable to load calendar events. Please try again.</p>
          </div>
        `);
        setTimeout(() => lucide.createIcons(), 100);
      }
    }
    
    async function showCommerceUpdates() {
      console.log('🏷️ Showing top brand deals from loyalty engine');
      
      try {
        const userId = dashboardData.currentUser || 'default';
        
        // First try to get real commerce data from email intelligence
        const emailResponse = await fetch(`/api/email-intelligence?userId=${userId}&limit=10`);
        const emailData = await emailResponse.json();
        
        // Also get activity data
        const activityResponse = await fetch(`/api/recent-activity?userId=${userId}`);
        const activityData = await activityResponse.json();
        
        let commerceInsights = [];
        let dataSource = 'mock';
        
        if (emailData && emailData.success && emailData.insights && Array.isArray(emailData.insights)) {
          // Process real email data to extract commerce insights
          console.log('🏷️ Processing email data for brand deals and loyalty offers');
          dataSource = 'real';
          
          // Filter and score email insights based on brand preferences
          const filteredAndScoredInsights = filterAndScoreEmailDeals(emailData.insights);
          
          // Extract commerce-related insights from filtered email intelligence
          filteredAndScoredInsights.forEach((insight, index) => {
            if (insight.category === 'Commerce' || insight.title.toLowerCase().includes('deal') ||
                insight.title.toLowerCase().includes('sale') || insight.title.toLowerCase().includes('discount') ||
                insight.insight.toLowerCase().includes('price') || insight.insight.toLowerCase().includes('save') ||
                insight.relevanceScore > 15) { // Include highly relevant insights even if not obviously commerce
              
              const commerceInsight = processEmailCommerceInsight(insight, index);
              
              // Add personalization info to the insight
              if (insight.isPersonalized) {
                commerceInsight.personalizedReason = insight.personalizedReason;
                commerceInsight.relevanceScore = insight.relevanceScore;
                commerceInsight.description = (commerceInsight.description || '') + 
                  ` 🎯 ${insight.personalizedReason}`;
              }
              
              commerceInsights.push(commerceInsight);
            }
          });
          
          // If we don't have enough real commerce insights, create some from email patterns
          if (commerceInsights.length < 3) {
            const syntheticInsights = generateCommerceFromEmailPatterns(filteredAndScoredInsights);
            commerceInsights = [...commerceInsights, ...syntheticInsights];
          }
        }
        
        // Fallback to mock data if no real commerce data available
        if (commerceInsights.length === 0) {
          console.log('🛒 No real commerce data available, using personalized brand deals');
          
          // Get personalized mock data based on user preferences
          const mockData = getMockCommerceUpdates();
          commerceInsights = mockData.insights;
          dataSource = mockData.personalizedBy === 'user preferences' ? 'personalized' : 'mock';
        }
        
        // Limit to top 4 insights
        commerceInsights = commerceInsights.slice(0, 4);
        
        const commerceCards = commerceInsights.map((insight, index) => {
          const isAlert = insight.title.toLowerCase().includes('price drop') || 
                         insight.title.toLowerCase().includes('deal');
          const isSubscription = insight.title.toLowerCase().includes('subscription');
          const borderColor = isAlert ? '#22c55e' : isSubscription ? '#f59e0b' : '#3b82f6';
          const hasSavings = insight.savings && insight.savings !== '$0.00';
          
          return `
            <div style="
              background: rgba(255, 255, 255, 0.1);
              border: 1px solid rgba(255, 255, 255, 0.2);
              border-radius: 12px;
              padding: 16px;
              margin-bottom: 12px;
              border-left: 4px solid ${borderColor};
            ">
              <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                <div>
                  <h4 style="margin: 0; font-size: 16px; font-weight: 600;">${insight.title}</h4>
                  <div style="font-size: 14px; opacity: 0.9; margin-top: 4px;">${insight.item}</div>
                  ${insight.brand ? `
                    <div style="font-size: 12px; opacity: 0.7; margin-top: 2px;">
                      <strong>${insight.brand}</strong> • ${insight.category || 'General'}
                    </div>
                  ` : ''}
                </div>
                ${hasSavings ? `
                  <div style="
                    background: rgba(34, 197, 94, 0.2);
                    padding: 6px 10px;
                    border-radius: 12px;
                    font-size: 12px;
                    font-weight: 600;
                    color: #22c55e;
                  ">Save ${insight.savings}</div>
                ` : ''}
              </div>
              
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <div style="display: flex; gap: 16px; font-size: 14px;">
                  ${insight.originalPrice && insight.originalPrice !== insight.currentPrice ? `
                    <div>
                      <span style="opacity: 0.6; text-decoration: line-through;">${insight.originalPrice}</span>
                      <span style="font-weight: 600; color: #22c55e; margin-left: 8px;">${insight.currentPrice}</span>
                    </div>
                  ` : `
                    <div style="font-weight: 600;">${insight.currentPrice || 'Price available'}</div>
                  `}
                </div>
                <div style="font-size: 12px; opacity: 0.7; text-align: right;">
                  ${insight.urgency}
                </div>
              </div>
              
              ${insight.description ? `
                <div style="font-size: 13px; opacity: 0.8; margin-bottom: 12px; padding: 8px; background: rgba(255, 255, 255, 0.05); border-radius: 6px;">
                  ${insight.description}
                </div>
              ` : ''}
              
              <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                <button onclick="handleQuickAction('${insight.action.toLowerCase().replace(' ', '_')}', '${insight.item}')" style="
                  background: rgba(139, 92, 246, 0.3);
                  border: 1px solid rgba(139, 92, 246, 0.5);
                  color: white;
                  padding: 8px 12px;
                  border-radius: 6px;
                  cursor: pointer;
                  font-size: 12px;
                  display: flex;
                  align-items: center;
                  gap: 6px;
                ">
                  <i data-lucide="${isAlert ? 'shopping-cart' : isSubscription ? 'eye' : 'plus'}" style="width: 12px; height: 12px;"></i>
                  ${insight.action}
                </button>
                <button onclick="openProductLink('${insight.item}')" style="
                  background: rgba(34, 197, 94, 0.3);
                  border: 1px solid rgba(34, 197, 94, 0.5);
                  color: white;
                  padding: 8px 12px;
                  border-radius: 6px;
                  cursor: pointer;
                  font-size: 12px;
                  display: flex;
                  align-items: center;
                  gap: 6px;
                ">
                  <i data-lucide="external-link" style="width: 12px; height: 12px;"></i>
                  View Deal
                </button>
              </div>
            </div>
          `;
        }).join('');
        
        // Get commerce activity from recent activity
        const commerceActivity = activityData.success ? 
          activityData.activity.filter(item => item.type === 'commerce') : [];
        
        // Calculate total potential savings
        const totalSavings = commerceInsights.reduce((sum, insight) => {
          if (insight.savings && insight.savings !== '$0.00') {
            return sum + parseFloat(insight.savings.replace('$', ''));
          }
          return sum;
        }, 0);
        
        showModal(`
          <div style="display: flex; align-items: center; gap: 12px;">
            <i data-lucide="tag" style="width: 24px; height: 24px; color: #f59e0b;"></i>
            <h2 style="margin: 0;">Top Brand Deals</h2>
          </div>
        `, `
          <div class="modal-header">
            <span class="data-source">${dataSource === 'real' ? '🔗 Live Email Data' : '🔧 Demo Mode'}</span>
          </div>
          <div style="margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
              <div>
                <h4 style="margin: 0;">Loyalty & Brand Offers</h4>
                <p style="margin: 0; font-size: 12px; opacity: 0.7;">
                  ${commerceInsights.length} exclusive deals ${
                    dataSource === 'real' ? 'from your brand emails' : 
                    dataSource === 'personalized' ? 'personalized for you' : 
                    'from demo brands'
                  }
                  ${dataSource === 'personalized' ? '✨' : ''}
                </p>
              </div>
              <div style="text-align: right;">
                <div style="font-size: 24px; font-weight: 700; color: #22c55e;">$${totalSavings.toFixed(2)}</div>
                <div style="font-size: 10px; opacity: 0.7;">Member Savings</div>
              </div>
            </div>
            
            ${commerceActivity.length > 0 ? `
              <div style="
                background: rgba(255, 255, 255, 0.05);
                border-radius: 8px;
                padding: 12px;
                margin-bottom: 16px;
              ">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                  <i data-lucide="trending-down" style="width: 16px; height: 16px; color: #f59e0b;"></i>
                  <span style="font-size: 14px; font-weight: 600;">Recent Activity</span>
                </div>
                ${commerceActivity.map(item => `
                  <div style="font-size: 14px; opacity: 0.8; margin-bottom: 4px;">• ${item.text}</div>
                `).join('')}
              </div>
            ` : ''}
          </div>
          
          ${commerceCards}
          
          <div class="modal-footer">
            <div style="text-align: center; margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(255, 255, 255, 0.1);">
              <button onclick="openCommerceSettings()" style="
                background: rgba(245, 158, 11, 0.3);
                border: 1px solid rgba(245, 158, 11, 0.5);
                color: white;
                padding: 12px 24px;
                border-radius: 8px;
                cursor: pointer;
                font-size: 14px;
                display: inline-flex;
                align-items: center;
                gap: 8px;
              ">
                <i data-lucide="settings" style="width: 16px; height: 16px;"></i>
                Customize Brands
              </button>
            </div>
          </div>
        `);
        
        // Re-initialize Lucide icons
        setTimeout(() => lucide.createIcons(), 100);
        console.log('✅ Top brand deals modal displayed successfully');
        
      } catch (error) {
        console.error('❌ Error loading brand deals:', error);
        showNotification('Error loading brand deals');
      }
    }
    
    // Enhanced email filtering and scoring based on brand preferences
    function filterAndScoreEmailDeals(emailInsights) {
      if (!Array.isArray(emailInsights)) {
        console.warn('filterAndScoreEmailDeals: emailInsights is not an array');
        return [];
      }
      
      const userPrefs = getUserBrandPreferences();
      const brandInsights = extractBrandInsights(userPrefs.customizationText || '');
      
      console.log('🎯 Filtering email deals based on preferences:', brandInsights);
      
      return emailInsights.map(insight => {
        let relevanceScore = 0;
        let personalizedReason = '';
        
        // Score based on preferred brands
        if (brandInsights.brands && brandInsights.brands.length > 0) {
          const insightText = (insight.title + ' ' + insight.insight + ' ' + (insight.content || '')).toLowerCase();
          
          brandInsights.brands.forEach(brand => {
            if (insightText.includes(brand.toLowerCase())) {
              relevanceScore += 30;
              personalizedReason = `Matches your preference for ${brand}`;
            }
          });
        }
        
        // Score based on family preferences
        if (brandInsights.hasKids && insight.title.toLowerCase().includes('kid')) {
          relevanceScore += 25;
          personalizedReason += (personalizedReason ? ' & ' : '') + 'Family-friendly deal';
        }
        
        // Score based on interests
        if (brandInsights.interests && brandInsights.interests.length > 0) {
          const insightText = (insight.title + ' ' + insight.insight).toLowerCase();
          
          brandInsights.interests.forEach(interest => {
            if (insightText.includes(interest.toLowerCase())) {
              relevanceScore += 20;
              personalizedReason += (personalizedReason ? ' & ' : '') + `Matches your interest in ${interest}`;
            }
          });
        }
        
        // Score based on budget preferences
        if (brandInsights.budgetPreference) {
          const priceMatch = insight.insight.match(/\$(\d+(?:\.\d{2})?)/);
          if (priceMatch) {
            const price = parseFloat(priceMatch[1]);
            
            if (brandInsights.budgetPreference === 'budget-conscious' && price < 50) {
              relevanceScore += 15;
              personalizedReason += (personalizedReason ? ' & ' : '') + 'Budget-friendly price';
            } else if (brandInsights.budgetPreference === 'premium' && price > 100) {
              relevanceScore += 15;
              personalizedReason += (personalizedReason ? ' & ' : '') + 'Premium quality match';
            }
          }
        }
        
        // Boost commerce-related insights
        if (insight.category === 'Commerce' || 
            insight.title.toLowerCase().includes('deal') ||
            insight.title.toLowerCase().includes('sale') ||
            insight.title.toLowerCase().includes('discount')) {
          relevanceScore += 10;
        }
        
        return {
          ...insight,
          relevanceScore,
          personalizedReason: personalizedReason || 'General deal alert',
          isPersonalized: relevanceScore > 0
        };
      }).sort((a, b) => b.relevanceScore - a.relevanceScore);
    }
    
    // Helper functions for processing email data into commerce insights
    function processEmailCommerceInsight(insight, index) {
      // Enhanced email intelligence processing for real brand deals
      console.log(`🔍 Processing email insight:`, insight);
      
      // Extract deal information from email content
      const dealData = extractDealFromEmail(insight);
      
      return {
        title: dealData.title || insight.title,
        item: dealData.product || 'Special Offer',
        originalPrice: dealData.originalPrice || '$0.00',
        currentPrice: dealData.currentPrice || '$0.00',
        savings: dealData.savings || '$0.00',
        loyaltyPoints: dealData.loyaltyPoints || 'Points available',
        confidence: mapPriorityToConfidence(insight.priority),
        action: dealData.action || 'View Deal',
        urgency: dealData.urgency || 'Limited time offer',
        brand: dealData.brand || extractBrandFromEmail(insight),
        category: dealData.category || 'General',
        source: dealData.source || 'Email',
        description: dealData.description || insight.insight
      };
    }
    
    function extractDealFromEmail(insight) {
      const emailText = insight.insight || insight.title || '';
      const dealData = {};
      
      // Extract brand from email
      dealData.brand = extractBrandFromEmail(insight);
      
      // Extract product name - look for common patterns
      const productPatterns = [
        /(?:deal on|sale on|offer on)\s+([^\.!,\n]+)/i,
        /([A-Z][A-Za-z\s]+(?:Pro|Plus|Max|Air|Mini))/,
        /(\b[A-Z][a-z]+\s+[A-Z][a-z]+(?:\s+[A-Z][a-z]+)?)\b/
      ];
      
      for (const pattern of productPatterns) {
        const match = emailText.match(pattern);
        if (match) {
          dealData.product = match[1].trim();
          break;
        }
      }
      
      // Extract pricing information
      const priceMatches = emailText.match(/\$(\d+\.?\d*)/g);
      if (priceMatches) {
        if (priceMatches.length >= 2) {
          // Assume first is original, second is sale price
          dealData.originalPrice = priceMatches[0];
          dealData.currentPrice = priceMatches[1];
        } else {
          dealData.currentPrice = priceMatches[0];
          // Estimate original price (add 20-50%)
          const current = parseFloat(priceMatches[0].replace('$', ''));
          dealData.originalPrice = '$' + (current * 1.35).toFixed(2);
        }
        
        // Calculate savings
        if (dealData.originalPrice && dealData.currentPrice) {
          const original = parseFloat(dealData.originalPrice.replace('$', ''));
          const current = parseFloat(dealData.currentPrice.replace('$', ''));
          if (original > current) {
            dealData.savings = '$' + (original - current).toFixed(2);
          }
        }
      }
      
      // Extract discount percentage
      const discountMatch = emailText.match(/(\d+)%\s*(?:off|discount|save)/i);
      if (discountMatch && !dealData.savings) {
        const percentage = parseInt(discountMatch[1]);
        dealData.title = `${percentage}% Off Deal`;
        if (dealData.currentPrice) {
          const current = parseFloat(dealData.currentPrice.replace('$', ''));
          const original = current / (1 - percentage / 100);
          dealData.originalPrice = '$' + original.toFixed(2);
          dealData.savings = '$' + (original - current).toFixed(2);
        }
      }
      
      // Extract urgency/timing
      const urgencyPatterns = [
        /(?:ends|expires)\s+(?:in\s+)?(\d+\s+(?:hours?|days?|minutes?))/i,
        /(?:today only|this weekend|limited time)/i,
        /(?:while supplies last|hurry|act now)/i
      ];
      
      for (const pattern of urgencyPatterns) {
        const match = emailText.match(pattern);
        if (match) {
          dealData.urgency = match[0];
          break;
        }
      }
      
      // Extract loyalty program info
      const loyaltyPatterns = [
        /(\d+)\s*(?:points?|rewards?)/i,
        /(\d+%)\s*(?:back|cashback|rebate)/i,
        /(?:member|exclusive|loyalty)\s+(?:price|deal|offer)/i
      ];
      
      for (const pattern of loyaltyPatterns) {
        const match = emailText.match(pattern);
        if (match) {
          dealData.loyaltyPoints = match[0];
          break;
        }
      }
      
      // Set deal title based on content
      if (!dealData.title) {
        if (dealData.brand && dealData.product) {
          dealData.title = `${dealData.brand} ${dealData.product} Deal`;
        } else if (dealData.brand) {
          dealData.title = `${dealData.brand} Special Offer`;
        } else {
          dealData.title = insight.title || 'Special Deal';
        }
      }
      
      return dealData;
    }
    
    function extractBrandFromEmail(insight) {
      // Try to extract brand from various sources
      const text = (insight.insight || insight.title || '').toLowerCase();
      
      // Common brand patterns
      const brandMap = {
        'amazon': 'Amazon',
        'target': 'Target', 
        'walmart': 'Walmart',
        'costco': 'Costco',
        'best buy': 'Best Buy',
        'nike': 'Nike',
        'apple': 'Apple',
        'google': 'Google',
        'microsoft': 'Microsoft',
        'netflix': 'Netflix',
        'spotify': 'Spotify',
        'disney': 'Disney',
        'whole foods': 'Whole Foods',
        'rei': 'REI',
        'patagonia': 'Patagonia',
        'dyson': 'Dyson',
        'nintendo': 'Nintendo'
      };
      
      for (const [key, brand] of Object.entries(brandMap)) {
        if (text.includes(key)) {
          return brand;
        }
      }
      
      // Extract from email source if available
      if (insight.source) {
        const sourceParts = insight.source.split(/[@\s]/);
        for (const part of sourceParts) {
          const cleaned = part.replace(/[^a-zA-Z]/g, '').toLowerCase();
          if (brandMap[cleaned]) {
            return brandMap[cleaned];
          }
        }
      }
      
      return 'Unknown Brand';
    }
    
    function mapPriorityToConfidence(priority) {
      const priorityMap = {
        'High': 'High',
        'Medium': 'Medium', 
        'Low': 'Low'
      };
      return priorityMap[priority] || 'Medium';
    }
    
    function generateCommerceFromEmailPatterns(emailInsights) {
      // Generate synthetic commerce insights based on email patterns
      const patterns = [];
      
      // Ensure emailInsights is an array
      if (!Array.isArray(emailInsights)) {
        console.warn('generateCommerceFromEmailPatterns: emailInsights is not an array, returning empty patterns');
        return patterns;
      }
      
      // Analyze email volume for subscription optimization
      if (emailInsights.length > 10) {
        patterns.push({
          title: 'Email Subscription Analysis',
          item: 'Marketing Email Optimization',
          originalPrice: '$29.99',
          currentPrice: '$19.99', 
          savings: '$10.00',
          loyaltyPoints: 'Productivity boost',
          confidence: 'Medium',
          action: 'Optimize',
          urgency: 'Based on recent email volume',
          brand: 'HomeOps AI',
          category: 'Productivity',
          source: 'Email Pattern Analysis',
          description: 'Detected high email volume - consider batch processing'
        });
      }
      
      // Look for calendar-related optimization opportunities
      const calendarEmails = emailInsights.filter(insight => 
        insight.insight.toLowerCase().includes('calendar') || 
        insight.insight.toLowerCase().includes('meeting') ||
        insight.insight.toLowerCase().includes('schedule')
      );
      
      if (calendarEmails.length > 2) {
        patterns.push({
          title: 'Time Management Opportunity',
          item: 'Calendar Scheduling Tool',
          originalPrice: '$15.00',
          currentPrice: '$12.00',
          savings: '$3.00',
          loyaltyPoints: '2 hours saved weekly',
          confidence: 'High',
          action: 'Review',
          urgency: 'Recurring calendar conflicts detected',
          brand: 'Calendly',
          category: 'Productivity',
          source: 'Calendar Pattern Analysis',
          description: 'Schedule optimization could save 2 hours/week'
        });
      }
      
      return patterns;
    }
    
    async function showTotalInsights() {
      const totalInsights = dashboardData.insights.length;
      const categories = {};
      
      dashboardData.insights.forEach(insight => {
        categories[insight.category] = (categories[insight.category] || 0) + 1;
      });
      
      // Create detailed insights cards
      const insightCards = dashboardData.insights.map(insight => {
        const priorityColor = insight.priority === 'High' ? '#ef4444' : 
                             insight.priority === 'Medium' ? '#f59e0b' : '#22c55e';
        
        return `
          <div style="
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            border-left: 4px solid ${priorityColor};
          ">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
              <div>
                <h4 style="margin: 0; font-size: 16px; font-weight: 600;">${insight.title}</h4>
                <div style="font-size: 12px; opacity: 0.7; margin-top: 2px;">
                  ${insight.category} • ${insight.date}
                </div>
              </div>
              <div style="
                background: rgba(${priorityColor.slice(1, 3) === 'ef' ? '239, 68, 68' : 
                                 priorityColor.slice(1, 3) === 'f5' ? '245, 158, 11' : '34, 197, 94'}, 0.2);
                padding: 4px 8px;
                border-radius: 12px;
                font-size: 10px;
                font-weight: 600;
                text-transform: uppercase;
                color: ${priorityColor};
              ">${insight.priority}</div>
            </div>
            
            <p style="margin: 0 0 16px 0; font-size: 14px; line-height: 1.4; opacity: 0.9;">
              ${insight.insight}
            </p>
            
            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
              <button onclick="handleQuickAction('${insight.action}', '${insight.title}')" style="
                background: rgba(139, 92, 246, 0.3);
                border: 1px solid rgba(139, 92, 246, 0.5);
                color: white;
                padding: 8px 12px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 12px;
                display: flex;
                align-items: center;
                gap: 6px;
              ">
                <i data-lucide="${insight.icon || 'plus'}" style="width: 12px; height: 12px;"></i>
                ${insight.action}
              </button>
              <button onclick="expandInsight('${insight.title}')" style="
                background: rgba(59, 130, 246, 0.3);
                border: 1px solid rgba(59, 130, 246, 0.5);
                color: white;
                padding: 8px 12px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 12px;
                display: flex;
                align-items: center;
                gap: 6px;
              ">
                <i data-lucide="expand" style="width: 12px; height: 12px;"></i>
                Details
              </button>
              <button onclick="dismissInsight('${insight.title}')" style="
                background: rgba(107, 114, 128, 0.3);
                border: 1px solid rgba(107, 114, 128, 0.5);
                color: white;
                padding: 8px 12px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 12px;
                display: flex;
                align-items: center;
                gap: 6px;
              ">
                <i data-lucide="x" style="width: 12px; height: 12px;"></i>
                Dismiss
              </button>
            </div>
          </div>
        `;
      }).join('');
      
      // Create category breakdown
      const categoryCards = Object.entries(categories).map(([category, count]) => {
        const categoryIcons = {
          'Intelligence': 'brain',
          'Family': 'users',
          'Education': 'graduation-cap',
          'Travel': 'plane',
          'Work': 'briefcase',
          'Health': 'heart-pulse',
          'Finance': 'dollar-sign'
        };
        
        return `
          <div style="
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
          ">
            <div style="
              background: rgba(139, 92, 246, 0.2);
              border-radius: 8px;
              padding: 8px;
              display: flex;
              align-items: center;
              justify-content: center;
            ">
              <i data-lucide="${categoryIcons[category] || 'tag'}" style="width: 16px; height: 16px; color: #8b5cf6;"></i>
            </div>
            <div style="flex: 1;">
              <div style="font-weight: 600; font-size: 14px;">${category}</div>
              <div style="font-size: 12px; opacity: 0.7;">${count} insight${count !== 1 ? 's' : ''}</div>
            </div>
            <div style="font-size: 18px; font-weight: 700; color: #8b5cf6;">${count}</div>
          </div>
        `;
      }).join('');
      
      showModal(`
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
          <i data-lucide="brain" style="width: 24px; height: 24px; color: white;"></i>
          <h2 style="margin: 0;">Total Insights Overview</h2>
        </div>
      `, `
        <div style="margin-bottom: 20px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
            <div>
              <h4 style="margin: 0;">Intelligence Summary</h4>
              <p style="margin: 0; font-size: 12px; opacity: 0.7;">${totalInsights} total insights generated</p>
            </div>
            <div style="text-align: right;">
              <div style="font-size: 24px; font-weight: 700; color: #8b5cf6;">${totalInsights}</div>
              <div style="font-size: 10px; opacity: 0.7;">This Week</div>
            </div>
          </div>
          
          <div style="
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
          ">
            ${categoryCards}
          </div>
        </div>
        
        <div style="margin-bottom: 16px;">
          <h4 style="margin: 0 0 12px 0; font-size: 16px; font-weight: 600;">All Insights</h4>
        </div>
        
        ${insightCards}
        
        <div style="text-align: center; margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(255, 255, 255, 0.1);">
          <button onclick="generateMoreInsights()" style="
            background: rgba(139, 92, 246, 0.3);
            border: 1px solid rgba(139, 92, 246, 0.5);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
          ">
            <i data-lucide="sparkles" style="width: 16px; height: 16px;"></i>
            Generate More AI Insights
          </button>
        </div>
      `);
      
      // Re-initialize Lucide icons
      setTimeout(() => lucide.createIcons(), 100);
    }
    
    // Calendar-specific action handlers with Google Calendar integration
    async function handleCalendarAction(action, eventTitle, eventData) {
      console.log(`📅 Calendar action: ${action} for ${eventTitle}`);
      
      try {
        const userId = dashboardData.currentUser || 'default';
        const event = typeof eventData === 'string' ? JSON.parse(eventData) : eventData;
        
        switch(action) {
          case 'prep':
            await processCalendarPrep(eventTitle, event, userId);
            break;
          case 'reschedule':
            await processCalendarReschedule(eventTitle, event, userId);
            break;
          default:
            showNotification(`⚠️ Unknown calendar action: ${action}`);
        }
        
      } catch (error) {
        console.error('❌ Error processing calendar action:', error);
        showNotification(`❌ Unable to complete ${action}. Please try again.`);
      }
    }

    async function processCalendarPrep(eventTitle, event, userId) {
      showNotification(`✅ Marking preparation complete for "${eventTitle}"...`);
      
      try {
        // Call real API to update event preparation status
        const response = await fetch('/api/calendar-events', {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            userId: userId,
            eventTitle: eventTitle,
            action: 'prep_complete',
            eventData: event
          })
        });
        
        const result = await response.json();
        if (result.success) {
          showNotification(`✅ Preparation marked complete for "${eventTitle}"`);
          
          // Update the UI to show prep is done
          const prepButtons = document.querySelectorAll('button[onclick*="prep"]');
          prepButtons.forEach(btn => {
            if (btn.textContent.includes('Prep Done') && btn.onclick.toString().includes(eventTitle)) {
              btn.style.background = 'rgba(34, 197, 94, 0.5)';
              btn.innerHTML = '<i data-lucide="check" style="width: 12px; height: 12px;"></i> Prep Complete';
              btn.disabled = true;
              btn.style.opacity = '0.7';
            }
          });
          
          setTimeout(() => lucide.createIcons(), 100);
        } else {
          throw new Error(result.error || 'Failed to update preparation status');
        }
        
      } catch (error) {
        console.error('❌ Error updating prep status:', error);
        showNotification(`❌ Failed to update preparation status: ${error.message}`);
      }
    }

    async function processCalendarReschedule(eventTitle, event, userId) {
      showNotification(`📅 Opening reschedule options for "${eventTitle}"...`);
      
      try {
        // Show reschedule modal with time slot options
        const rescheduleTimes = generateRescheduleOptions(event);
        
        showModal(`
          <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
            <i data-lucide="calendar" style="width: 24px; height: 24px; color: #f59e0b;"></i>
            <h2 style="margin: 0;">Reschedule Event</h2>
          </div>
        `, `
          <div style="margin-bottom: 20px;">
            <h4 style="margin-bottom: 8px;">${eventTitle}</h4>
            <p style="opacity: 0.7; font-size: 14px; margin-bottom: 16px;">
              Current time: ${event.time} on ${event.date}
            </p>
            
            <div style="margin-bottom: 20px;">
              <h5 style="margin-bottom: 12px;">Suggested Times:</h5>
              ${rescheduleTimes.map(time => `
                <button onclick="confirmReschedule('${eventTitle}', '${time.datetime}', '${time.display}', ${JSON.stringify(event).replace(/"/g, '&quot;')})" style="
                  width: 100%;
                  background: rgba(245, 158, 11, 0.2);
                  border: 1px solid rgba(245, 158, 11, 0.3);
                  color: white;
                  padding: 12px;
                  border-radius: 8px;
                  cursor: pointer;
                  margin-bottom: 8px;
                  text-align: left;
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                ">
                  <div>
                    <div style="font-weight: 600;">${time.display}</div>
                    <div style="font-size: 12px; opacity: 0.7;">${time.reason}</div>
                  </div>
                  <i data-lucide="chevron-right" style="width: 16px; height: 16px;"></i>
                </button>
              `).join('')}
            </div>
            
            <div style="text-align: center; padding-top: 16px; border-top: 1px solid rgba(255, 255, 255, 0.1);">
              <button onclick="openGoogleCalendar('${eventTitle}')" style="
                background: rgba(139, 92, 246, 0.3);
                border: 1px solid rgba(139, 92, 246, 0.5);
                color: white;
                padding: 12px 24px;
                border-radius: 8px;
                cursor: pointer;
                font-size: 14px;
                display: inline-flex;
                align-items: center;
                gap: 8px;
              ">
                <i data-lucide="external-link" style="width: 16px; height: 16px;"></i>
                Open in Google Calendar
              </button>
            </div>
          </div>
        `);
        
        setTimeout(() => lucide.createIcons(), 100);
        
      } catch (error) {
        console.error('❌ Error creating reschedule options:', error);
        showNotification(`❌ Unable to generate reschedule options: ${error.message}`);
      }
    }

    function generateRescheduleOptions(event) {
      const now = new Date();
      const suggestions = [];
      
      // Add 30 minutes later
      const thirtyMin = new Date(now.getTime() + 30 * 60000);
      suggestions.push({
        datetime: thirtyMin.toISOString(),
        display: `Today at ${thirtyMin.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`,
        reason: '30 minutes later (minimal disruption)'
      });
      
      // Add 1 hour later
      const oneHour = new Date(now.getTime() + 60 * 60000);
      suggestions.push({
        datetime: oneHour.toISOString(),
        display: `Today at ${oneHour.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`,
        reason: '1 hour buffer for current task'
      });
      
      // Add tomorrow same time
      const tomorrow = new Date(now);
      tomorrow.setDate(tomorrow.getDate() + 1);
      suggestions.push({
        datetime: tomorrow.toISOString(),
        display: `Tomorrow at ${now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`,
        reason: 'Same time tomorrow'
      });
      
      return suggestions;
    }

    async function confirmReschedule(eventTitle, newDateTime, displayTime, eventData) {
      showNotification(`📅 Rescheduling "${eventTitle}" to ${displayTime}...`);
      
      try {
        const userId = dashboardData.currentUser || 'default';
        const event = typeof eventData === 'string' ? JSON.parse(eventData) : eventData;
        
        const response = await fetch('/api/calendar-events', {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            userId: userId,
            eventTitle: eventTitle,
            action: 'reschedule',
            newDateTime: newDateTime,
            displayTime: displayTime,
            eventData: event
          })
        });
        
        const result = await response.json();
        if (result.success) {
          showNotification(`✅ Successfully rescheduled "${eventTitle}" to ${displayTime}`);
          
          // Close the modal
          const modal = document.querySelector('.modal-overlay');
          if (modal) modal.remove();
          
          // Refresh calendar data
          setTimeout(() => {
            loadSummaryData();
          }, 1000);
          
        } else {
          throw new Error(result.error || 'Failed to reschedule event');
        }
        
      } catch (error) {
        console.error('❌ Error rescheduling event:', error);
        showNotification(`❌ Failed to reschedule: ${error.message}`);
      }
    }

    function openGoogleCalendar(eventTitle) {
      showNotification(`🔗 Opening Google Calendar for "${eventTitle}"...`);
      
      // Create Google Calendar URL with search for the event
      const searchQuery = encodeURIComponent(eventTitle);
      const calendarUrl = `https://calendar.google.com/calendar/u/0/r/search?q=${searchQuery}`;
      
      // Open in new tab
      window.open(calendarUrl, '_blank');
      
      // Close the modal
      const modal = document.querySelector('.modal-overlay');
      if (modal) modal.remove();
    }

    // Calendar feedback system similar to urgent messages
    async function provideCalendarFeedback(eventTitle, eventData) {
      const event = typeof eventData === 'string' ? JSON.parse(eventData) : eventData;
      
      showModal(`
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
          <i data-lucide="message-circle" style="width: 24px; height: 24px; color: #22c55e;"></i>
          <h2 style="margin: 0;">Event Feedback</h2>
        </div>
      `, `
        <div style="margin-bottom: 20px;">
          <div style="
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
          ">
            <h4 style="margin: 0 0 8px 0;">${eventTitle}</h4>
            <div style="font-size: 14px; opacity: 0.7;">
              ${event.date} • ${event.time} • ${event.location}
            </div>
          </div>
          
          <div style="margin-bottom: 20px;">
            <h5 style="margin-bottom: 12px;">Was this event classification helpful?</h5>
            <div style="display: flex; gap: 12px; justify-content: center; margin-bottom: 20px;">
              <button onclick="submitCalendarFeedback('${eventTitle}', 'positive', '', ${JSON.stringify(event).replace(/"/g, '&quot;')})" style="
                background: rgba(34, 197, 94, 0.3);
                border: 1px solid rgba(34, 197, 94, 0.5);
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 8px;
                font-size: 14px;
              ">
                <i data-lucide="thumbs-up" style="width: 16px; height: 16px;"></i>
                Helpful
              </button>
              <button onclick="submitCalendarFeedback('${eventTitle}', 'negative', '', ${JSON.stringify(event).replace(/"/g, '&quot;')})" style="
                background: rgba(239, 68, 68, 0.3);
                border: 1px solid rgba(239, 68, 68, 0.5);
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 8px;
                font-size: 14px;
              ">
                <i data-lucide="thumbs-down" style="width: 16px; height: 16px;"></i>
                Not Helpful
              </button>
            </div>
          </div>
          
          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600;">
              Additional feedback (optional):
            </label>
            <textarea id="calendar-feedback-text" placeholder="How can we improve event scheduling and preparation suggestions?" style="
              width: 100%;
              background: rgba(255, 255, 255, 0.1);
              border: 1px solid rgba(255, 255, 255, 0.2);
              border-radius: 8px;
              padding: 12px;
              color: white;
              font-size: 14px;
              resize: vertical;
              min-height: 80px;
            "></textarea>
          </div>
          
          <div style="display: flex; gap: 12px; justify-content: center;">
            <button onclick="submitCalendarFeedback('${eventTitle}', 'detailed', document.getElementById('calendar-feedback-text').value, ${JSON.stringify(event).replace(/"/g, '&quot;')})" style="
              background: rgba(139, 92, 246, 0.3);
              border: 1px solid rgba(139, 92, 246, 0.5);
              color: white;
              padding: 12px 24px;
              border-radius: 8px;
              cursor: pointer;
              font-size: 14px;
            ">
              Submit Feedback
            </button>
            <button onclick="document.querySelector('.modal-overlay').remove()" style="
              background: rgba(255, 255, 255, 0.1);
              border: 1px solid rgba(255, 255, 255, 0.2);
              color: white;
              padding: 12px 24px;
              border-radius: 8px;
              cursor: pointer;
              font-size: 14px;
            ">
              Cancel
            </button>
          </div>
        </div>
      `);
      
      setTimeout(() => lucide.createIcons(), 100);
    }

    async function submitCalendarFeedback(eventTitle, feedbackType, feedbackText, eventData) {
      const event = typeof eventData === 'string' ? JSON.parse(eventData) : eventData;
      
      try {
        const userId = dashboardData.currentUser || 'default';
        
        const response = await fetch('/api/feedback', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            userId: userId,
            type: 'calendar_event',
            feedbackType: feedbackType,
            eventTitle: eventTitle,
            eventData: event,
            feedbackText: feedbackText.trim(),
            timestamp: new Date().toISOString(),
            context: {
              eventType: event.type,
              eventPriority: event.priority,
              location: event.location,
              preparationTime: event.prep
            }
          })
        });
        
        const result = await response.json();
        if (result.success) {
          showNotification('✅ Thank you! Your feedback helps improve calendar management.');
          
          // Close the modal
          const modal = document.querySelector('.modal-overlay');
          if (modal) modal.remove();
          
        } else {
          throw new Error(result.error || 'Failed to submit feedback');
        }
        
      } catch (error) {
        console.error('❌ Error submitting calendar feedback:', error);
        showNotification('❌ Unable to submit feedback. Please try again.');
      }
    }

    // Quick action handlers for modal interactions
    async function handleQuickAction(action, title) {
      console.log(`Quick action: ${action} for ${title}`);
      
      // Show loading state
      showNotification(`⏳ Processing ${action} for "${title}"...`);
      
      try {
        const userId = dashboardData.currentUser || 'default';
        
        // Process different action types
        switch(action) {
          case 'Add to Calendar':
            await processCalendarAction(title, userId);
            break;
          case 'Create Shopping List':
            await processShoppingAction(title, userId);
            break;
          case 'Send Reminder':
            await processReminderAction(title, userId);
            break;
          case 'Review Pattern':
            await processPatternReview(title, userId);
            break;
          default:
            await processGenericAction(action, title, userId);
        }
        
        // Close the modal after successful action
        setTimeout(() => {
          const modal = document.querySelector('.modal-overlay');
          if (modal) modal.remove();
        }, 2000);
        
      } catch (error) {
        console.error('Error processing quick action:', error);
        showNotification(`❌ Unable to complete ${action}. Please try again.`);
      }
    }

    async function processCalendarAction(title, userId) {
      try {
        const response = await fetch('/api/calendar-events', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            userId: userId,
            title: title,
            action: 'add',
            source: 'urgent-message'
          })
        });
        
        const result = await response.json();
        if (result.success) {
          showNotification(`📅 Successfully added "${title}" to your calendar`);
          // Update calendar events count
          loadSummaryData();
        } else {
          throw new Error(result.error || 'Failed to add to calendar');
        }
      } catch (error) {
        showNotification(`❌ Failed to add to calendar: ${error.message}`);
      }
    }

    async function processShoppingAction(title, userId) {
      showNotification(`🛒 Creating shopping list from "${title}"...`);
      
      // Simulate shopping list creation with AI analysis
      setTimeout(() => {
        showNotification('✅ Shopping list created! Check your Brand Deals.');
        // In production, this would analyze the email for shopping items
      }, 1500);
    }

    async function processReminderAction(title, userId) {
      showNotification(`⏰ Setting up intelligent reminder for "${title}"...`);
      
      // Simulate reminder setup
      setTimeout(() => {
        showNotification('✅ Smart reminder configured based on your schedule!');
      }, 1200);
    }

    async function processPatternReview(title, userId) {
      showNotification(`🔍 Analyzing patterns for "${title}"...`);
      
      // This would trigger the existing reviewPattern functionality
      setTimeout(() => {
        showNotification('📊 Pattern analysis complete! Check Total Insights for details.');
        // Trigger pattern review
        reviewPattern(title);
      }, 1000);
    }

    async function processGenericAction(action, title, userId) {
      const actionMessages = {
        'prep': '✅ Prep task marked complete',
        'reschedule': '📅 Reschedule options displayed',
        'respond': '📧 Response template prepared',
        'delegate': '👥 Delegation options prepared',
        'archive': '📁 Message archived successfully'
      };
      
      const message = actionMessages[action] || `✨ ${action} completed`;
      showNotification(`${message} for "${title}"`);
    }
    
    function openEmailLink(title) {
      console.log(`Opening email: ${title}`);
      showNotification(`📧 Opening "${title}" in your email client...`);
      
      // In a real implementation, this would open the actual email
      // For demo, we'll show a notification
      setTimeout(() => {
        const modal = document.querySelector('.modal-overlay');
        if (modal) modal.remove();
      }, 2000);
    }
    
    function exportPattern(title) {
      console.log(`Exporting pattern data for: ${title}`);
      showNotification(`📥 Exporting pattern data for "${title}"...`);
      // Simulate export processing
      setTimeout(() => {
        showNotification('✅ Pattern data exported successfully!');
      }, 1500);
    }
    
    function createAutomation(title) {
      console.log(`Creating automation for: ${title}`);
      showNotification(`🤖 Creating smart automation for "${title}"...`);
      // Simulate automation creation
      setTimeout(() => {
        showNotification('✅ Automation created! It will run automatically.');
      }, 2000);
    }
    
    function setReminder(title) {
      console.log(`Setting reminder for: ${title}`);
      showNotification(`⏰ Setting intelligent reminder for "${title}"...`);
      // Simulate reminder setup
      setTimeout(() => {
        showNotification('✅ Smart reminder configured!');
      }, 1000);
    }
    
    function connectCalendar() {
      console.log('Connecting calendar...');
      showNotification('🔗 Redirecting to Google Calendar connection...');
      
      // Close modal and show notification
      const modal = document.querySelector('.modal-overlay');
      if (modal) modal.remove();
      
      // In real implementation, this would start OAuth flow
      setTimeout(() => {
        showNotification('📅 Calendar connection feature coming soon!');
      }, 1000);
    }
    
    function openProductLink(item) {
      console.log(`Opening product link: ${item}`);
      showNotification(`🛒 Opening "${item}" deal page...`);
      
      setTimeout(() => {
        const modal = document.querySelector('.modal-overlay');
        if (modal) modal.remove();
      }, 2000);
    }
    
    function openCommerceSettings() {
      console.log('Opening brand customization settings...');
      
      // Get current user preferences if they exist
      const currentPreferences = JSON.parse(localStorage.getItem('homeops-brand-preferences') || '{}');
      const savedText = currentPreferences.customizationText || '';
      
      showModal(`
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
          <i data-lucide="heart" style="width: 24px; height: 24px; color: #f59e0b;"></i>
          <h2 style="margin: 0;">Customize Your Brand Experience</h2>
        </div>
      `, `
        <div style="margin-bottom: 24px;">
          <p style="font-size: 14px; line-height: 1.5; opacity: 0.9; margin-bottom: 20px;">
            Help us personalize your Top Brand Deals by sharing information about your preferences, family, and shopping habits. 
            The more you tell us, the better we can surface deals that matter to you.
          </p>
          
          <div style="
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
          ">
            <label style="
              display: block;
              font-size: 14px;
              font-weight: 600;
              margin-bottom: 12px;
              color: rgba(255, 255, 255, 0.9);
            ">
              Tell us about yourself and your preferences:
            </label>
            
            <textarea
              id="brand-customization-text"
              placeholder="Share anything that helps us personalize your experience! For example:

• Brands you love: 'I'm loyal to Apple, Patagonia, and Whole Foods'
• Family info: 'I have two kids (ages 8 and 12) who love Nintendo and sports'
• Shopping habits: 'I prefer eco-friendly products and bulk buying at Costco'
• Interests: 'Into fitness, cooking, and outdoor activities'
• Budget preferences: 'Looking for deals on quality items, not necessarily the cheapest'
• Dietary needs: 'We eat mostly organic and gluten-free foods'
• Lifestyle: 'Busy parent, value time-saving products and services'"
              style="
                width: 100%;
                height: 180px;
                background: rgba(255, 255, 255, 0.08);
                border: 1px solid rgba(255, 255, 255, 0.2);
                border-radius: 6px;
                padding: 12px;
                color: white;
                font-size: 14px;
                line-height: 1.5;
                resize: vertical;
                font-family: inherit;
              "
            >${savedText}</textarea>
            
            <div style="
              display: flex;
              align-items: center;
              gap: 8px;
              margin-top: 8px;
              font-size: 12px;
              opacity: 0.7;
            ">
              <i data-lucide="lock" style="width: 14px; height: 14px;"></i>
              <span>Your preferences are stored locally and used only to personalize your deals</span>
            </div>
          </div>
          
          <div style="
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.2);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
          ">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
              <i data-lucide="sparkles" style="width: 16px; height: 16px; color: #22c55e;"></i>
              <h4 style="margin: 0; font-size: 14px; font-weight: 600;">AI Personalization Benefits</h4>
            </div>
            <ul style="margin: 0; padding-left: 16px; font-size: 13px; line-height: 1.4; opacity: 0.9;">
              <li>Filter deals by brands you actually shop with</li>
              <li>Prioritize family-relevant offers (kids' sizes, activities, etc.)</li>
              <li>Surface deals matching your lifestyle and values</li>
              <li>Highlight time-sensitive offers for items you need</li>
              <li>Skip categories you're not interested in</li>
            </ul>
          </div>
          
          <div style="display: flex; gap: 12px; justify-content: center; margin-top: 24px;">
            <button onclick="saveBrandPreferences()" style="
              background: rgba(34, 197, 94, 0.3);
              border: 1px solid rgba(34, 197, 94, 0.5);
              color: white;
              padding: 12px 24px;
              border-radius: 8px;
              cursor: pointer;
              font-size: 14px;
              display: flex;
              align-items: center;
              gap: 8px;
              font-weight: 600;
            ">
              <i data-lucide="save" style="width: 16px; height: 16px;"></i>
              Save Preferences
            </button>
            
            <button onclick="clearBrandPreferences()" style="
              background: rgba(239, 68, 68, 0.2);
              border: 1px solid rgba(239, 68, 68, 0.3);
              color: white;
              padding: 12px 24px;
              border-radius: 8px;
              cursor: pointer;
              font-size: 14px;
              display: flex;
              align-items: center;
              gap: 8px;
            ">
              <i data-lucide="trash-2" style="width: 16px; height: 16px;"></i>
              Clear All
            </button>
            
            <button onclick="closeModal()" style="
              background: rgba(255, 255, 255, 0.1);
              border: 1px solid rgba(255, 255, 255, 0.2);
              color: white;
              padding: 12px 24px;
              border-radius: 8px;
              cursor: pointer;
              font-size: 14px;
              display: flex;
              align-items: center;
              gap: 8px;
            ">
              <i data-lucide="x" style="width: 16px; height: 16px;"></i>
              Cancel
            </button>
          </div>
        </div>
      `);
      
      // Focus on textarea after a brief delay for the modal to render
      setTimeout(() => {
        const textarea = document.getElementById('brand-customization-text');
        if (textarea && !savedText) {
          textarea.focus();
        }
        lucide.createIcons();
      }, 150);
    }
    
    // Brand preferences management functions
    function saveBrandPreferences() {
      const textarea = document.getElementById('brand-customization-text');
      const customizationText = textarea ? textarea.value.trim() : '';
      
      if (!customizationText) {
        showNotification('⚠️ Please share some information about your preferences before saving');
        return;
      }
      
      const preferences = {
        customizationText: customizationText,
        lastUpdated: new Date().toISOString(),
        userId: dashboardData.currentUser || 'demo-user'
      };
      
      // Save to local storage
      localStorage.setItem('homeops-brand-preferences', JSON.stringify(preferences));
      
      // Also send to server for enhanced personalization (if API available)
      saveBrandPreferencesToServer(preferences);
      
      showNotification('✅ Brand preferences saved! Your deals will be more personalized.');
      
      // Close modal
      const modal = document.querySelector('.modal-overlay');
      if (modal) modal.remove();
      
      console.log('💾 Brand preferences saved:', preferences);
    }
    
    async function saveBrandPreferencesToServer(preferences) {
      try {
        const response = await fetch('/api/user/brand-preferences', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(preferences)
        });
        
        if (response.ok) {
          console.log('✅ Brand preferences synced to server');
        } else {
          console.warn('⚠️ Could not sync brand preferences to server');
        }
      } catch (error) {
        console.warn('⚠️ Brand preferences saved locally only:', error.message);
      }
    }
    
    function clearBrandPreferences() {
      if (confirm('Are you sure you want to clear all your brand preferences? This will reset your personalization.')) {
        localStorage.removeItem('homeops-brand-preferences');
        
        const textarea = document.getElementById('brand-customization-text');
        if (textarea) {
          textarea.value = '';
        }
        
        showNotification('🗑️ Brand preferences cleared. Personalization reset.');
        console.log('🗑️ Brand preferences cleared');
      }
    }
    
    function closeModal() {
      const modal = document.querySelector('.modal-overlay');
      if (modal) modal.remove();
    }
    
    // Function to get user brand preferences for personalization
    function getUserBrandPreferences() {
      const preferences = JSON.parse(localStorage.getItem('homeops-brand-preferences') || '{}');
      return preferences;
    }
    
    // Function to extract brand insights from user preferences text
    function extractBrandInsights(preferencesText) {
      if (!preferencesText) {
        return {
          mentionedBrands: [],
          hasKids: false,
          kidsAge: null,
          interests: [],
          budgetPrefs: [],
          rawText: ''
        };
      }
      
      const text = preferencesText.toLowerCase();
      
      // Extract mentioned brands
      const commonBrands = [
        'apple', 'amazon', 'target', 'costco', 'whole foods', 'trader joes',
        'nike', 'adidas', 'patagonia', 'north face', 'lululemon',
        'disney', 'nintendo', 'sony', 'samsung', 'google',
        'starbucks', 'chipotle', 'panera', 'chick-fil-a',
        'home depot', 'lowes', 'bed bath beyond', 'ikea',
        'sephora', 'ulta', 'nordstrom', 'macys'
      ];
      
      const mentionedBrands = commonBrands.filter(brand => text.includes(brand));
      
      // Extract family info
      const hasKids = /kids?|children|child|son|daughter|family/i.test(preferencesText);
      const kidsAgeMatch = preferencesText.match(/age[sd]?\s*(\d+)/i);
      const kidsAge = kidsAgeMatch ? parseInt(kidsAgeMatch[1]) : null;
      
      // Extract interests
      const interests = [];
      const interestKeywords = {
        'fitness': /fitness|gym|workout|exercise|running|yoga/i,
        'cooking': /cooking|kitchen|recipe|food|baking/i,
        'outdoor': /outdoor|hiking|camping|nature|sports/i,
        'tech': /tech|gadget|computer|phone|electronic/i,
        'fashion': /fashion|clothes|style|outfit/i,
        'home': /home|house|decor|furniture|garden/i
      };
      
      Object.entries(interestKeywords).forEach(([interest, regex]) => {
        if (regex.test(preferencesText)) {
          interests.push(interest);
        }
      });
      
      // Extract budget preferences
      const budgetKeywords = {
        'premium': /premium|quality|high.end|luxury/i,
        'budget': /budget|cheap|affordable|deal|discount/i,
        'organic': /organic|natural|eco.friendly|sustainable/i
      };
      
      const budgetPrefs = [];
      Object.entries(budgetKeywords).forEach(([pref, regex]) => {
        if (regex.test(preferencesText)) {
          budgetPrefs.push(pref);
        }
      });
      
      return {
        mentionedBrands,
        hasKids,
        kidsAge,
        interests,
        budgetPrefs,
        rawText: preferencesText
      };
    }
    
    function generateMoreInsights() {
      console.log('Generating more AI insights...');
      showNotification('🧠 AI is analyzing your patterns to generate new insights...');
      
      const modal = document.querySelector('.modal-overlay');
      if (modal) modal.remove();
      
      // Simulate AI processing
      setTimeout(() => {
        showNotification('✨ 3 new insights generated! Check your dashboard.');
      }, 2000);
    }
    
    function reviewPattern(title) {
      console.log(`🔄 reviewPattern called with title: ${title}`);
      console.log('📊 dashboardData.insights:', dashboardData.insights);
      
      const insight = dashboardData.insights.find(i => i.title === title);
      console.log(`🔍 Found insight:`, insight);
      
      if (insight) {
        console.log('✅ Insight found, proceeding with pattern analysis...');
        
        // Mock pattern analysis data
        const patternData = {
          frequency: ['Daily', 'Weekly', 'Monthly'][Math.floor(Math.random() * 3)],
          trend: ['Increasing', 'Stable', 'Decreasing'][Math.floor(Math.random() * 3)],
          peakTimes: ['9:00 AM - 11:00 AM', '2:00 PM - 4:00 PM', '7:00 PM - 9:00 PM'],
          correlations: [
            'Often occurs before school events',
            'Increases during busy work weeks', 
            'Related to family calendar conflicts'
          ].slice(0, Math.floor(Math.random() * 2) + 1),
          historicalData: [
            { period: 'Last 7 days', count: Math.floor(Math.random() * 5) + 1 },
            { period: 'Last 30 days', count: Math.floor(Math.random() * 15) + 5 },
            { period: 'Last 90 days', count: Math.floor(Math.random() * 40) + 10 }
          ]
        };
        
        console.log('📈 Pattern data generated:', patternData);
        
        const trendColor = patternData.trend === 'Increasing' ? '#ef4444' : 
                          patternData.trend === 'Stable' ? '#f59e0b' : '#22c55e';
        
        console.log('🎨 Trend color:', trendColor);
        console.log('📱 About to call showModal...');
        
        showModal(`📊 Pattern Analysis: ${insight.title}`, `
          <div style="margin-bottom: 20px;">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
              <div style="
                background: rgba(59, 130, 246, 0.2);
                border-radius: 8px;
                padding: 12px;
                display: flex;
                align-items: center;
                justify-content: center;
              ">
                <i data-lucide="trending-up" style="width: 24px; height: 24px; color: #3b82f6;"></i>
              </div>
              <div>
                <h4 style="margin: 0; font-size: 18px; font-weight: 600;">Pattern Intelligence</h4>
                <div style="font-size: 12px; opacity: 0.7; margin-top: 2px;">
                  AI-powered behavioral analysis
                </div>
              </div>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 20px;">
              <div style="
                background: rgba(255, 255, 255, 0.05);
                border-radius: 8px;
                padding: 12px;
                text-align: center;
              ">
                <div style="font-size: 16px; font-weight: 700; color: #3b82f6;">${patternData.frequency}</div>
                <div style="font-size: 11px; opacity: 0.7;">Frequency</div>
              </div>
              <div style="
                background: rgba(255, 255, 255, 0.05);
                border-radius: 8px;
                padding: 12px;
                text-align: center;
              ">
                <div style="font-size: 16px; font-weight: 700; color: ${trendColor};">${patternData.trend}</div>
                <div style="font-size: 11px; opacity: 0.7;">Trend</div>
              </div>
              <div style="
                background: rgba(255, 255, 255, 0.05);
                border-radius: 8px;
                padding: 12px;
                text-align: center;
              ">
                <div style="font-size: 16px; font-weight: 700; color: #8b5cf6;">${insight.category}</div>
                <div style="font-size: 11px; opacity: 0.7;">Category</div>
              </div>
            </div>
            
            <div style="margin-bottom: 20px;">
              <h5 style="margin: 0 0 12px 0; font-size: 14px; font-weight: 600;">Historical Data</h5>
              <div style="display: flex; flex-direction: column; gap: 8px;">
                ${patternData.historicalData.map(data => `
                  <div style="
                    background: rgba(255, 255, 255, 0.05);
                    border-radius: 6px;
                    padding: 12px;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                  ">
                    <span style="font-size: 13px; opacity: 0.9;">${data.period}</span>
                    <div style="display: flex; align-items: center; gap: 8px;">
                      <div style="
                        width: ${Math.min(data.count * 3, 60)}px;
                        height: 4px;
                        background: linear-gradient(90deg, #8b5cf6, #3b82f6);
                        border-radius: 2px;
                      "></div>
                      <span style="font-size: 13px; font-weight: 600; color: #8b5cf6;">${data.count}</span>
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
            
            <div style="margin-bottom: 20px;">
              <h5 style="margin: 0 0 12px 0; font-size: 14px; font-weight: 600;">Peak Activity Times</h5>
              <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                ${patternData.peakTimes.map(time => `
                  <div style="
                    background: rgba(139, 92, 246, 0.2);
                    border: 1px solid rgba(139, 92, 246, 0.3);
                    border-radius: 20px;
                    padding: 6px 12px;
                    font-size: 12px;
                    font-weight: 500;
                  ">${time}</div>
                `).join('')}
              </div>
            </div>
            
            <div style="margin-bottom: 20px;">
              <h5 style="margin: 0 0 12px 0; font-size: 14px; font-weight: 600;">AI-Detected Correlations</h5>
              <div style="display: flex; flex-direction: column; gap: 8px;">
                ${patternData.correlations.map(correlation => `
                  <div style="
                    background: rgba(255, 255, 255, 0.05);
                    border-radius: 6px;
                    padding: 10px;
                    display: flex;
                    align-items: center;
                    gap: 10px;
                  ">
                    <div style="
                      background: rgba(34, 197, 94, 0.3);
                      border-radius: 50%;
                      padding: 4px;
                      display: flex;
                      align-items: center;
                      justify-content: center;
                      min-width: 20px;
                      height: 20px;
                    ">
                      <i data-lucide="link" style="width: 10px; height: 10px; color: #22c55e;"></i>
                    </div>
                    <span style="font-size: 13px; opacity: 0.9;">${correlation}</span>
                  </div>
                `).join('')}
              </div>
            </div>
            
            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
              <button onclick="createAutomation('${insight.title}')" style="
                background: rgba(139, 92, 246, 0.3);
                border: 1px solid rgba(139, 92, 246, 0.5);
                color: white;
                padding: 10px 16px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 13px;
                display: flex;
                align-items: center;
                gap: 6px;
              ">
                <i data-lucide="zap" style="width: 14px; height: 14px;"></i>
                Create Automation
              </button>
              <button onclick="setReminder('${insight.title}')" style="
                background: rgba(245, 158, 11, 0.3);
                border: 1px solid rgba(245, 158, 11, 0.5);
                color: white;
                padding: 10px 16px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 13px;
                display: flex;
                align-items: center;
                gap: 6px;
              ">
                <i data-lucide="bell" style="width: 14px; height: 14px;"></i>
                Set Smart Reminder
              </button>
              <button onclick="exportPattern('${insight.title}')" style="
                background: rgba(34, 197, 94, 0.3);
                border: 1px solid rgba(34, 197, 94, 0.5);
                color: white;
                padding: 10px 16px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 13px;
                display: flex;
                align-items: center;
                gap: 6px;
              ">
                <i data-lucide="download" style="width: 14px; height: 14px;"></i>
                Export Data
              </button>
            </div>
          </div>
        `);
        
        console.log('✅ showModal called successfully');
        
        // Re-initialize Lucide icons
        setTimeout(() => {
          console.log('🔄 Re-initializing Lucide icons...');
          lucide.createIcons();
        }, 100);
        
      } else {
        console.log(`❌ Insight not found for title: ${title}`);
        showNotification(`📊 Pattern analysis for: ${title}`);
      }
    }
    
    // Helper functions for real calendar data processing
    function formatEventTime(start, end) {
      if (!start) return 'Time TBD';
      
      try {
        const startDate = new Date(start.dateTime || start.date);
        const endDate = end ? new Date(end.dateTime || end.date) : null;
        
        if (start.date) {
          // All-day event
          return 'All day';
        }
        
        const timeOptions = { hour: 'numeric', minute: '2-digit', hour12: true };
        const startTime = startDate.toLocaleTimeString('en-US', timeOptions);
        
        if (endDate && end.dateTime) {
          const endTime = endDate.toLocaleTimeString('en-US', timeOptions);
          return `${startTime} - ${endTime}`;
        }
        
        return startTime;
      } catch (error) {
        console.error('Error formatting event time:', error);
        return 'Time TBD';
      }
    }
    
    function formatEventDate(start) {
      if (!start) return 'Date TBD';
      
      try {
        const eventDate = new Date(start.dateTime || start.date);
        const today = new Date();
        const tomorrow = new Date(today);
        tomorrow.setDate(tomorrow.getDate() + 1);
        
        if (eventDate.toDateString() === today.toDateString()) {
          return 'Today';
        } else if (eventDate.toDateString() === tomorrow.toDateString()) {
          return 'Tomorrow';
        } else {
          return eventDate.toLocaleDateString('en-US', { 
            month: 'short', 
            day: 'numeric' 
          });
        }
      } catch (error) {
        console.error('Error formatting event date:', error);
        return 'Date TBD';
      }
    }
    
    function categorizeEventType(title) {
      const titleLower = title.toLowerCase();
      
      // Family/personal indicators
      if (titleLower.includes('family') || titleLower.includes('kid') || 
          titleLower.includes('school') || titleLower.includes('doctor') ||
          titleLower.includes('birthday') || titleLower.includes('anniversary') ||
          titleLower.includes('soccer') || titleLower.includes('practice')) {
        return 'family';
      }
      
      // Work indicators  
      if (titleLower.includes('meeting') || titleLower.includes('standup') ||
          titleLower.includes('call') || titleLower.includes('review') ||
          titleLower.includes('work') || titleLower.includes('project')) {
        return 'work';
      }
      
      return 'personal';
    }
    
    function calculateEventPriority(event) {
      const title = (event.title || event.summary || '').toLowerCase();
      
      // High priority indicators
      if (title.includes('urgent') || title.includes('important') ||
          title.includes('deadline') || title.includes('interview') ||
          title.includes('doctor') || title.includes('emergency')) {
        return 'High';
      }
      
      // Medium priority indicators
      if (title.includes('meeting') || title.includes('call') ||
          title.includes('appointment') || title.includes('conference')) {
        return 'Medium';
      }
      
      return 'Low';
    }
    
    function generatePrepTime(event) {
      const title = (event.title || event.summary || '').toLowerCase();
      
      if (title.includes('meeting') || title.includes('call')) {
        return 'Review agenda';
      } else if (title.includes('doctor') || title.includes('appointment')) {
        return '10 min prep needed';
      } else if (title.includes('travel') || title.includes('flight')) {
        return 'Check traffic & documents';
      } else if (title.includes('practice') || title.includes('sports')) {
        return 'Pack equipment';
      } else if (title.includes('school') || title.includes('conference')) {
        return '15 min prep needed';
      }
      
      return 'No prep needed';
    }
    
    // Helper functions for processing email data into commerce insights
    function processEmailCommerceInsight(insight, index) {
      // Convert email intelligence insight to commerce format
      const brands = ['Amazon', 'Target', 'Walmart', 'Best Buy', 'Nike', 'Apple'];
      const categories = ['Electronics', 'Fashion', 'Home', 'Health', 'Education', 'Entertainment'];
      
      let item = 'Product';
      let originalPrice = '$0.00';
      let currentPrice = '$0.00';
      let savings = '$0.00';
      
      // Extract pricing info from insight text if available
      const priceMatch = insight.insight.match(/\$(\d+\.?\d*)/g);
      if (priceMatch && priceMatch.length >= 2) {
        originalPrice = priceMatch[0];
        currentPrice = priceMatch[1];
        const original = parseFloat(originalPrice.replace('$', ''));
        const current = parseFloat(currentPrice.replace('$', ''));
        if (original > current) {
          savings = `$${(original - current).toFixed(2)}`;
        }
      } else if (priceMatch && priceMatch.length === 1) {
        currentPrice = priceMatch[0];
        originalPrice = `$${(parseFloat(currentPrice.replace('$', '')) * 1.3).toFixed(2)}`;
        const original = parseFloat(originalPrice.replace('$', ''));
        const current = parseFloat(currentPrice.replace('$', ''));
        savings = `$${(original - current).toFixed(2)}`;
      }
      
      // Determine item from title or insight
      if (insight.title.toLowerCase().includes('subscription')) {
        item = 'Subscription Service';
      } else if (insight.insight.toLowerCase().includes('email')) {
        item = 'Email Marketing Tool';
      } else if (insight.insight.toLowerCase().includes('calendar')) {
        item = 'Productivity Software';
      }
      
      return {
        title: insight.title.includes('Price Drop') ? insight.title : `${insight.title} Deal Alert`,
        item: item,
        originalPrice: originalPrice,
        currentPrice: currentPrice,
        savings: savings,
        confidence: insight.priority,
        action: insight.action || 'Learn More',
        urgency: `Based on email pattern analysis`,
        brand: brands[index % brands.length],
        category: categories[index % categories.length],
        description: insight.insight.length > 100 ? insight.insight.substring(0, 100) + '...' : insight.insight
      };
    }
    
    function generateCommerceFromEmailPatterns(emailInsights) {
      const commercePatterns = [
        {
          title: 'Email Subscription Analysis',
          item: 'Marketing Email Optimization',
          originalPrice: '$29.99',
          currentPrice: '$19.99', 
          savings: '$10.00',
          confidence: 'Medium',
          action: 'Optimize',
          urgency: 'Based on recent email volume',
          brand: 'HomeOps AI',
          category: 'Productivity',
          description: 'Detected high email volume - consider batch processing'
        },
        {
          title: 'Time Management Opportunity',
          item: 'Calendar Scheduling Tool',
          originalPrice: '$15.00',
          currentPrice: '$12.00',
          savings: '$3.00', 
          confidence: 'Low',
          action: 'Review',
          urgency: 'Recurring calendar conflicts detected',
          brand: 'Calendly',
          category: 'Productivity',
          description: 'Schedule optimization could save 2 hours/week'
        }
      ];
      
      return commercePatterns.slice(0, 2);
    }
    
    // Feedback System for User Learning
    function provideFeedback(insightTitle, category) {
      console.log(`Providing feedback for: ${insightTitle} (${category})`);
      
      showModal(`
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
          <i data-lucide="message-circle" style="width: 24px; height: 24px; color: #f59e0b;"></i>
          <h2 style="margin: 0;">Share Your Feedback</h2>
        </div>
      `, `
        <div style="margin-bottom: 20px;">
          <h4 style="margin: 0 0 8px 0; font-size: 16px;">Help us improve your experience</h4>
          <p style="margin: 0 0 16px 0; font-size: 14px; opacity: 0.8; line-height: 1.4;">
            Your feedback helps HomeOps learn what's truly urgent for you and your family.
          </p>
          
          <div style="background: rgba(255, 255, 255, 0.05); border-radius: 8px; padding: 12px; margin-bottom: 16px;">
            <p style="margin: 0; font-size: 13px; font-weight: 600;">"${insightTitle}"</p>
          </div>
          
          <div style="margin-bottom: 20px;">
            <h5 style="margin: 0 0 12px 0; font-size: 14px;">Was this classification helpful?</h5>
            
            <div style="display: flex; gap: 12px; margin-bottom: 16px;">
              <button onclick="submitFeedback('${insightTitle}', '${category}', 'helpful', '')" style="
                background: rgba(34, 197, 94, 0.3);
                border: 1px solid rgba(34, 197, 94, 0.5);
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                cursor: pointer;
                font-size: 14px;
                display: flex;
                align-items: center;
                gap: 8px;
                flex: 1;
                justify-content: center;
              ">
                <i data-lucide="thumbs-up" style="width: 16px; height: 16px;"></i>
                Yes, this was urgent
              </button>
              
              <button onclick="submitFeedback('${insightTitle}', '${category}', 'not-helpful', '')" style="
                background: rgba(239, 68, 68, 0.3);
                border: 1px solid rgba(239, 68, 68, 0.5);
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                cursor: pointer;
                font-size: 14px;
                display: flex;
                align-items: center;
                gap: 8px;
                flex: 1;
                justify-content: center;
              ">
                <i data-lucide="thumbs-down" style="width: 16px; height: 16px;"></i>
                No, not urgent
              </button>
            </div>
            
            <div style="margin-bottom: 16px;">
              <label style="display: block; font-size: 14px; margin-bottom: 8px;">
                Additional feedback (optional):
              </label>
              <textarea id="feedback-text" placeholder="Help us understand what makes this urgent or not urgent for your family..." style="
                width: 100%;
                padding: 12px;
                border: 1px solid rgba(255, 255, 255, 0.2);
                border-radius: 8px;
                background: rgba(255, 255, 255, 0.05);
                color: white;
                font-size: 14px;
                font-family: inherit;
                resize: vertical;
                min-height: 80px;
              "></textarea>
            </div>
            
            <button onclick="submitDetailedFeedback('${insightTitle}', '${category}')" style="
              background: rgba(139, 92, 246, 0.3);
              border: 1px solid rgba(139, 92, 246, 0.5);
              color: white;
              padding: 12px 24px;
              border-radius: 8px;
              cursor: pointer;
              font-size: 14px;
              display: flex;
              align-items: center;
              gap: 8px;
              width: 100%;
              justify-content: center;
            ">
              <i data-lucide="send" style="width: 16px; height: 16px;"></i>
              Submit Detailed Feedback
            </button>
          </div>
          
          <div style="text-align: center; padding-top: 16px; border-top: 1px solid rgba(255, 255, 255, 0.1);">
            <p style="margin: 0; font-size: 12px; opacity: 0.6;">
              Your feedback helps HomeOps learn your family's patterns and priorities
            </p>
          </div>
        </div>
      `);
      
      setTimeout(() => lucide.createIcons(), 100);
    }

    async function submitFeedback(insightTitle, category, feedback, additionalFeedback) {
      try {
        const userId = dashboardData.currentUser || 'default';
        const feedbackData = {
          userId: userId,
          insightTitle: insightTitle,
          category: category,
          feedback: feedback,
          additionalFeedback: additionalFeedback,
          timestamp: new Date().toISOString()
        };
        
        console.log('📝 Submitting feedback:', feedbackData);
        
        // In production, this would send to a real feedback API
        const response = await fetch('/api/feedback', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(feedbackData)
        });
        
        // Close modal and show success message
        const modal = document.querySelector('.modal-overlay');
        if (modal) modal.remove();
        
        if (feedback === 'helpful') {
          showNotification('✅ Thanks! We\'ll keep flagging similar items as urgent.');
        } else {
          showNotification('📝 Thanks! We\'ll adjust our urgency detection for you.');
        }
        
        // Simulate learning - in production this would update ML models
        setTimeout(() => {
          showNotification('🧠 HomeOps is learning from your feedback...');
        }, 2000);
        
      } catch (error) {
        console.error('Error submitting feedback:', error);
        showNotification('❌ Unable to submit feedback. Please try again.');
      }
    }

    function submitDetailedFeedback(insightTitle, category) {
      const feedbackText = document.getElementById('feedback-text').value;
      
      if (!feedbackText.trim()) {
        showNotification('Please enter some feedback before submitting.');
        return;
      }
      
      submitFeedback(insightTitle, category, 'detailed', feedbackText);
    }
    
    // Add proper notification system instead of alerts
    function showNotification(message) {
      // Create a better notification overlay
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.9);
        color: white;
        padding: 20px;
        border-radius: 12px;
        max-width: 400px;
        white-space: pre-line;
        z-index: 10000;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        font-size: 14px;
        line-height: 1.4;
        border: 1px solid rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(10px);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      `;
      
      notification.innerHTML = `
        <div style="margin-bottom: 15px;">${message}</div>
        <button onclick="this.parentElement.remove()" style="
          background: rgba(139, 92, 246, 0.3);
          border: 1px solid rgba(139, 92, 246, 0.5);
          color: white;
          padding: 8px 16px;
          border-radius: 6px;
          cursor: pointer;
          font-size: 14px;
          float: right;
        ">OK</button>
      `;
      
      document.body.appendChild(notification);
      
      // Auto-remove after 10 seconds
      setTimeout(() => {
        if (notification.parentElement) {
          notification.remove();
        }
      }, 10000);
    }

    // Enhanced modal system for detailed views
    function showModal(title, content) {
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(10px);
        animation: fadeIn 0.3s ease;
      `;
      
      modal.innerHTML = `
        <div style="
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          border-radius: 16px;
          max-width: 500px;
          width: 90%;
          max-height: 80vh;
          overflow-y: auto;
          border: 1px solid rgba(255, 255, 255, 0.2);
          box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        ">
          <div style="
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
          ">
            <h3 style="margin: 0; color: white; font-size: 18px; font-weight: 600;">${title}</h3>
            <button onclick="this.closest('.modal-overlay').remove()" style="
              background: none;
              border: none;
              color: rgba(255, 255, 255, 0.7);
              font-size: 24px;
              cursor: pointer;
              padding: 0;
              width: 30px;
              height: 30px;
              display: flex;
              align-items: center;
              justify-content: center;
              border-radius: 50%;
              transition: background 0.2s;
            " onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='none'">×</button>
          </div>
          <div style="padding: 20px; color: white;">
            ${content}
          </div>
        </div>
      `;
      
      modal.className = 'modal-overlay';
      document.body.appendChild(modal);
      
      // Add CSS for animation
      const style = document.createElement('style');
      style.textContent = `
        @keyframes fadeIn {
          from { opacity: 0; transform: scale(0.9); }
          to { opacity: 1; transform: scale(1); }
        }
      `;
      document.head.appendChild(style);
    }

    // Additional utility functions for complete functionality
    function openEmailLink(title) {
      console.log('📧 Opening email for:', title);
      showNotification(`📧 Opening email for: ${title}`);
    }

    function openProductLink(item) {
      console.log('🛒 Opening product link for:', item);  
      showNotification(`🛒 Opening product page for: ${item}`);
    }

    function connectCalendar() {
      console.log('📅 Connecting to Google Calendar...');
      showNotification('🔗 Calendar integration coming soon!');
    }

    function openCommerceSettings() {
      console.log('⚙️ Opening commerce settings...');
      showBrandCustomizationModal();
    }

    async function showBrandCustomizationModal() {
      // Get current preferences and email-based suggestions
      const currentPrefs = getUserBrandPreferences();
      const emailSuggestions = await getEmailBrandSuggestions();
      
      const modal = document.createElement('div');
      modal.id = 'brandCustomizationModal';
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10000;
        backdrop-filter: blur(5px);
      `;
      
      modal.innerHTML = `
        <div style="
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          border-radius: 20px;
          padding: 30px;
          max-width: 600px;
          width: 90%;
          max-height: 80vh;
          overflow-y: auto;
          box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
          color: white;
          position: relative;
        ">
          <button onclick="closeBrandCustomizationModal()" style="
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
          ">×</button>
          
          <div style="display: flex; align-items: center; margin-bottom: 25px;">
            <i data-lucide="settings" style="width: 24px; height: 24px; margin-right: 12px;"></i>
            <h2 style="margin: 0; font-size: 24px; font-weight: 600;">Customize Your Brand Settings</h2>
          </div>
          
          <div style="margin-bottom: 25px;">
            <label style="display: block; font-weight: 600; margin-bottom: 8px; font-size: 16px;">
              Tell us about your preferences:
            </label>
            <textarea 
              id="brandPreferencesText" 
              placeholder="Share details about brands you love, whether you have kids (and their ages), your interests like fitness or cooking, budget preferences, etc.

For example: 'I love Apple, Nike, and Target. I have two kids ages 5 and 8. I'm interested in fitness, cooking, and tech. I prefer mid-range pricing but will splurge on quality items.'"
              style="
                width: 100%;
                height: 120px;
                padding: 15px;
                border: 2px solid rgba(255, 255, 255, 0.3);
                border-radius: 12px;
                background: rgba(255, 255, 255, 0.1);
                color: white;
                font-size: 14px;
                font-family: inherit;
                resize: vertical;
                box-sizing: border-box;
              "
            >${currentPrefs.customizationText || ''}</textarea>
          </div>
          
          ${emailSuggestions.length > 0 ? `
            <div style="margin-bottom: 25px;">
              <h3 style="margin: 0 0 15px 0; font-size: 18px; font-weight: 600;">
                <i data-lucide="mail" style="width: 18px; height: 18px; margin-right: 8px;"></i>
                Brands Found in Your Emails
              </h3>
              <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                ${emailSuggestions.map(brand => `
                  <button 
                    onclick="addBrandToPreferences('${brand}')" 
                    style="
                      background: rgba(255, 255, 255, 0.2);
                      border: 1px solid rgba(255, 255, 255, 0.3);
                      color: white;
                      padding: 8px 12px;
                      border-radius: 20px;
                      cursor: pointer;
                      font-size: 12px;
                      transition: all 0.2s ease;
                    "
                    onmouseover="this.style.background='rgba(255, 255, 255, 0.3)'"
                    onmouseout="this.style.background='rgba(255, 255, 255, 0.2)'"
                  >
                    + ${brand}
                  </button>
                `).join('')}
              </div>
              <div style="font-size: 12px; opacity: 0.8; margin-top: 8px;">
                Click any brand above to add it to your preferences
              </div>
            </div>
          ` : ''}
          
          <div style="display: flex; gap: 12px; justify-content: flex-end;">
            <button onclick="closeBrandCustomizationModal()" style="
              background: rgba(255, 255, 255, 0.2);
              border: 1px solid rgba(255, 255, 255, 0.3);
              color: white;
              padding: 12px 24px;
              border-radius: 8px;
              cursor: pointer;
              font-size: 14px;
            ">Cancel</button>
            <button onclick="saveBrandCustomization()" style="
              background: rgba(34, 197, 94, 0.8);
              border: 1px solid rgba(34, 197, 94, 1);
              color: white;
              padding: 12px 24px;
              border-radius: 8px;
              cursor: pointer;
              font-size: 14px;
              font-weight: 600;
            ">Save Preferences</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // Initialize Lucide icons
      if (typeof lucide !== 'undefined') {
        lucide.createIcons();
      }
      
      // Focus on the textarea
      setTimeout(() => {
        const textarea = document.getElementById('brandPreferencesText');
        if (textarea) {
          textarea.focus();
        }
      }, 100);
    }

    function closeBrandCustomizationModal() {
      const modal = document.getElementById('brandCustomizationModal');
      if (modal) {
        modal.remove();
      }
    }

    async function getEmailBrandSuggestions() {
      try {
        console.log('🔍 Analyzing emails for brand suggestions...');
        
        // Get recent email intelligence
        const response = await fetch('/api/email-intelligence?userId=current-user&limit=20');
        if (!response.ok) {
          console.log('No email data available for brand suggestions');
          return [];
        }
        
        const emailData = await response.json();
        if (!emailData.success || !Array.isArray(emailData.insights)) {
          return [];
        }
        
        // Extract brand mentions from email content
        const brandMentions = new Set();
        const commonBrands = [
          'Apple', 'Amazon', 'Target', 'Costco', 'Whole Foods', 'Trader Joe\'s',
          'Nike', 'Adidas', 'Patagonia', 'North Face', 'Lululemon',
          'Disney', 'Nintendo', 'Sony', 'Samsung', 'Google', 'Microsoft',
          'Starbucks', 'Chipotle', 'Panera', 'Chick-fil-A',
          'Home Depot', 'Lowe\'s', 'IKEA', 'Bed Bath & Beyond',
          'Sephora', 'Ulta', 'Nordstrom', 'Macy\'s', 'Best Buy',
          'Walmart', 'CVS', 'Walgreens', 'REI', 'Williams Sonoma'
        ];
        
        emailData.insights.forEach(insight => {
          const content = (insight.title + ' ' + insight.insight + ' ' + (insight.content || '')).toLowerCase();
          
          commonBrands.forEach(brand => {
            if (content.includes(brand.toLowerCase())) {
              brandMentions.add(brand);
            }
          });
        });
        
        const suggestions = Array.from(brandMentions).slice(0, 12); // Limit to 12 suggestions
        console.log(`📧 Found ${suggestions.length} brand suggestions from emails:`, suggestions);
        
        return suggestions;
        
      } catch (error) {
        console.log('Error getting email brand suggestions:', error);
        return [];
      }
    }

    function addBrandToPreferences(brand) {
      const textarea = document.getElementById('brandPreferencesText');
      if (textarea) {
        const currentText = textarea.value;
        const brandText = `I love ${brand}`;
        
        if (currentText.trim()) {
          // Add to existing text
          if (!currentText.toLowerCase().includes(brand.toLowerCase())) {
            textarea.value = currentText + (currentText.endsWith('.') ? ' ' : '. ') + brandText;
          }
        } else {
          // Start new text
          textarea.value = brandText;
        }
        
        // Brief visual feedback
        const button = event.target;
        const originalText = button.textContent;
        button.textContent = '✓ Added';
        button.style.background = 'rgba(34, 197, 94, 0.3)';
        
        setTimeout(() => {
          button.textContent = originalText;
          button.style.background = 'rgba(255, 255, 255, 0.2)';
        }, 1000);
      }
    }

    async function saveBrandCustomization() {
      const textarea = document.getElementById('brandPreferencesText');
      const customizationText = textarea ? textarea.value.trim() : '';
      
      try {
        console.log('💾 Saving brand preferences...');
        
        const response = await fetch('/api/user/brand-preferences', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            userId: 'current-user',
            customizationText: customizationText,
            updatedAt: new Date().toISOString()
          })
        });
        
        if (response.ok) {
          showNotification('✅ Brand preferences saved successfully!');
          closeBrandCustomizationModal();
          
          // Refresh the commerce deals with new preferences
          setTimeout(() => {
            showCommerceUpdates();
          }, 500);
        } else {
          throw new Error('Failed to save preferences');
        }
        
      } catch (error) {
        console.error('Error saving brand preferences:', error);
        showNotification('❌ Error saving preferences. Please try again.');
      }
    }

    function generateMoreInsights() {
      console.log('✨ Generating more AI insights...');
      showNotification('🧠 AI insight generation initiated...');
      
      // Reload insights after a short delay to simulate processing
      setTimeout(() => {
        loadInsightsData();
        showNotification('✅ New insights generated!');
      }, 2000);
    }

    // Format event time helper function
    function formatEventTime(start, end) {
      if (!start) return 'Time TBD';
      
      try {
        const startDate = new Date(start.dateTime || start.date);
        const endDate = end ? new Date(end.dateTime || end.date) : null;
        
        if (start.date) {
          return 'All day';
        }
        
        const timeOptions = { hour: 'numeric', minute: '2-digit', hour12: true };
        const startTime = startDate.toLocaleTimeString('en-US', timeOptions);
        
        if (endDate && end.dateTime) {
          const endTime = endDate.toLocaleTimeString('en-US', timeOptions);
          return `${startTime} - ${endTime}`;
        }
        
        return startTime;
      } catch (error) {
        console.error('Error formatting event time:', error);
        return 'Time TBD';
      }
    }
    
    function formatEventDate(start) {
      if (!start) return 'Date TBD';
      
      try {
        const eventDate = new Date(start.dateTime || start.date);
        const today = new Date();
        const tomorrow = new Date(today);
        tomorrow.setDate(tomorrow.getDate() + 1);
        
        if (eventDate.toDateString() === today.toDateString()) {
          return 'Today';
        } else if (eventDate.toDateString() === tomorrow.toDateString()) {
          return 'Tomorrow';
        } else {
          return eventDate.toLocaleDateString('en-US', { 
            month: 'short', 
            day: 'numeric' 
          });
        }
      } catch (error) {
        console.error('Error formatting event date:', error);
        return 'Date TBD';
      }
    }
    
    function categorizeEventType(title) {
      const titleLower = title.toLowerCase();
      
      if (titleLower.includes('family') || titleLower.includes('kid') || 
          titleLower.includes('school') || titleLower.includes('doctor') ||
          titleLower.includes('birthday') || titleLower.includes('anniversary') ||
          titleLower.includes('soccer') || titleLower.includes('practice')) {
        return 'family';
      }
      
      if (titleLower.includes('meeting') || titleLower.includes('standup') ||
          titleLower.includes('call') || titleLower.includes('review') ||
          titleLower.includes('work') || titleLower.includes('project')) {
        return 'work';
      }
      
      return 'personal';
    }
    
    function calculateEventPriority(event) {
      const title = (event.title || event.summary || '').toLowerCase();
      
      if (title.includes('urgent') || title.includes('important') ||
          title.includes('deadline') || title.includes('interview') ||
          title.includes('doctor') || title.includes('emergency')) {
        return 'High';
      }
      
      if (title.includes('meeting') || title.includes('call') ||
          title.includes('appointment') || title.includes('conference')) {
        return 'Medium';
      }
      
      return 'Low';
    }
    
    function generatePrepTime(event) {
      const title = (event.title || event.summary || '').toLowerCase();
      
      if (title.includes('meeting') || title.includes('call')) {
        return 'Review agenda';
      } else if (title.includes('doctor') || title.includes('appointment')) {
        return '10 min prep needed';
      } else if (title.includes('travel') || title.includes('flight')) {
        return 'Check traffic & documents';
      } else if (title.includes('practice') || title.includes('sports')) {
        return 'Pack equipment';
      } else if (title.includes('school') || title.includes('conference')) {
        return '15 min prep needed';
      }
      
      return 'No prep needed';
    }
  </script>
</body>
</html>