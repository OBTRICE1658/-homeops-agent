<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connect Your Mental Load Intelligence - HomeOps</title>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 24px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
            padding: 60px 50px;
            max-width: 600px;
            width: 100%;
            text-align: center;
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: #e2e8f0;
            border-radius: 2px;
            margin-bottom: 40px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            width: 50%;
            transition: width 0.3s ease;
        }
        
        .step-indicator {
            color: #718096;
            font-size: 14px;
            margin-bottom: 12px;
            font-weight: 500;
        }

        .brand-mark {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
            color: white;
            position: relative;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            color: white;
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 16px;
            letter-spacing: -0.02em;
            color: #1a202c;
        }

        .headline {
            color: #4a5568;
            font-size: 1.2rem;
            margin-bottom: 48px;
            line-height: 1.6;
            max-width: 480px;
            margin-left: auto;
            margin-right: auto;
        }
        .connection-card {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 16px;
            padding: 32px;
            margin-bottom: 32px;
            text-align: left;
            transition: all 0.3s ease;
        }
        
        .connection-card.connected {
            border-color: #48bb78;
            background: #f0fff4;
        }
        
        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .card-icon {
            width: 32px;
            height: 32px;
            margin-right: 16px;
            color: #667eea;
        }
        
        .card-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2d3748;
        }
        
        .card-status {
            margin-left: auto;
            font-size: 0.9rem;
            font-weight: 600;
            padding: 6px 16px;
            border-radius: 20px;
            background: #fef3c7;
            color: #92400e;
        }
        
        .card-status.connected {
            background: #d1fae5;
            color: #065f46;
        }
        
        .capabilities-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 24px;
        }
        
        .capability {
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }
        
        .capability-icon {
            width: 20px;
            height: 20px;
            color: #667eea;
            margin-top: 2px;
        }
        
        .capability-content h4 {
            font-size: 0.95rem;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 4px;
        }
        
        .capability-content p {
            font-size: 0.85rem;
            color: #4a5568;
            line-height: 1.4;
        }
        
        .privacy-note {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 24px;
            color: #1e40af;
            font-size: 0.9rem;
        }
        
        .privacy-icon {
            width: 16px;
            height: 16px;
        }
        
        .connect-btn {
            width: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 18px 24px;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }
        
        .connect-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 30px rgba(102, 126, 234, 0.4);
        }
        
        .connect-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-icon {
            width: 20px;
            height: 20px;
        }
        
        .continue-btn {
            width: 100%;
            background: #48bb78;
            color: white;
            border: none;
            padding: 18px 24px;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .continue-btn.ready {
            opacity: 1;
            cursor: pointer;
        }
        
        .continue-btn.ready:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 30px rgba(72, 187, 120, 0.3);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            body {
                padding: 10px;
                align-items: flex-start;
                padding-top: 20px;
            }
            
            .container {
                padding: 30px 20px;
                max-width: 100%;
                width: 100%;
            }
            
            .brand-mark {
                width: 60px;
                height: 60px;
                margin-bottom: 16px;
            }
            
            .logo-icon {
                width: 30px;
                height: 30px;
            }
            
            h1 {
                font-size: 2rem;
                margin-bottom: 12px;
            }
            
            .headline {
                font-size: 1rem;
                margin-bottom: 28px;
            }
            
            .connection-card {
                padding: 20px;
                margin-bottom: 24px;
            }
            
            .card-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
                margin-bottom: 16px;
            }
            
            .card-status {
                margin-left: 0;
                align-self: flex-start;
            }
            
            .capabilities-grid {
                grid-template-columns: 1fr;
                gap: 16px;
                margin-bottom: 20px;
            }
            
            .capability-content h4 {
                font-size: 0.9rem;
            }
            
            .capability-content p {
                font-size: 0.8rem;
            }
            
            .privacy-note {
                padding: 10px;
                font-size: 0.85rem;
                margin-bottom: 20px;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 24px 16px;
            }
            
            h1 {
                font-size: 1.8rem;
            }
            
            .headline {
                font-size: 0.95rem;
                margin-bottom: 24px;
            }
            
            .connection-card {
                padding: 16px;
            }
            
            .card-title {
                font-size: 1.3rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="progress-bar">
            <div class="progress-fill"></div>
        </div>
        
        <div class="step-indicator">Step 2 of 4</div>
        
        <div class="brand-mark">
            <i data-lucide="home" class="logo-icon"></i>
        </div>
        
        <h1>Connect Your Intelligence</h1>
        <p class="headline">Connect Gmail to unlock email and calendar intelligence that reduces your family's mental load.</p>
        
        <div class="connection-card" id="gmailCard">
            <div class="card-header">
                <i data-lucide="mail" class="card-icon"></i>
                <div>
                    <div class="card-title">Gmail & Calendar Intelligence</div>
                </div>
                <span class="card-status" id="gmailStatus">Not Connected</span>
            </div>
            
            <div class="capabilities-grid">
                <div class="capability">
                    <i data-lucide="filter" class="capability-icon"></i>
                    <div class="capability-content">
                        <h4>Email Intelligence</h4>
                        <p>Identify trusted brands, school communications, and important family emails</p>
                    </div>
                </div>
                
                <div class="capability">
                    <i data-lucide="calendar" class="capability-icon"></i>
                    <div class="capability-content">
                        <h4>Schedule Intelligence</h4>
                        <p>Track family events, identify conflicts, and reduce scheduling chaos</p>
                    </div>
                </div>
                
                <div class="capability">
                    <i data-lucide="bell" class="capability-icon"></i>
                    <div class="capability-content">
                        <h4>Smart Alerts</h4>
                        <p>Never miss school deadlines or important family communications</p>
                    </div>
                </div>
                
                <div class="capability">
                    <i data-lucide="brain" class="capability-icon"></i>
                    <div class="capability-content">
                        <h4>Mental Load Reduction</h4>
                        <p>Stop tracking everything in your head—we'll surface what matters</p>
                    </div>
                </div>
            </div>
            
            <div class="privacy-note">
                <i data-lucide="shield-check" class="privacy-icon"></i>
                <span>Read-only access • Your data stays yours • Parent-built security • No ads or tracking</span>
            </div>
            
            <button class="connect-btn" id="connectBtn">
                <i data-lucide="link" class="btn-icon"></i>
                Connect Gmail & Calendar Securely
            </button>
        </div>
        
        <button class="continue-btn" id="continueBtn">
            <span>Continue to Analysis</span>
            <i data-lucide="arrow-right" class="btn-icon"></i>
        </button>
    </div>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();
        
        // Get user info from session storage
        const userInfo = JSON.parse(sessionStorage.getItem('onboarding_user') || '{}');
        
        // Check if returning from OAuth
        const urlParams = new URLSearchParams(window.location.search);
        const authSuccess = urlParams.get('auth') === 'success';
        const authError = urlParams.get('error');
        
        if (authSuccess) {
            // Mark as connected
            markGmailConnected();
        } else if (authError) {
            console.error('OAuth error:', authError);
        }
        
        function markGmailConnected() {
            const card = document.getElementById('gmailCard');
            const status = document.getElementById('gmailStatus');
            const connectBtn = document.getElementById('connectBtn');
            const continueBtn = document.getElementById('continueBtn');
            
            card.classList.add('connected');
            status.textContent = 'Connected';
            status.classList.add('connected');
            connectBtn.textContent = '✓ Successfully Connected';
            connectBtn.disabled = true;
            continueBtn.classList.add('ready');
            continueBtn.disabled = false;
            
            // Update user info
            userInfo.gmailConnected = true;
            userInfo.step = 2;
            sessionStorage.setItem('onboarding_user', JSON.stringify(userInfo));
        }
        
        document.getElementById('connectBtn').addEventListener('click', function() {
            if (this.disabled) return;
            
            // Store current progress
            userInfo.step = 2;
            sessionStorage.setItem('onboarding_user', JSON.stringify(userInfo));
            
            // Redirect to Gmail OAuth with onboarding flag
            window.location.href = '/auth/gmail?isOnboarding=true';
        });
        
        document.getElementById('continueBtn').addEventListener('click', function() {
            if (!this.classList.contains('ready')) return;
            
            this.disabled = true;
            this.innerHTML = '<span>Loading...</span>';
            window.location.href = '/scan?gmail_connected=true';
        });
        
        // If already connected (for testing), enable continue
        if (sessionStorage.getItem('gmail_connected') === 'true') {
            markGmailConnected();
        }
    </script>
</body>
</html>
        }
        
        .security-badge {
            display: flex;
            align-items: center;
            background: #e6fffa;
            color: #234e52;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
        }
        
        .security-badge i {
            width: 16px;
            height: 16px;
            margin-right: 6px;
        }
        
        .connection-cards {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .connection-card {
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 24px;
            text-align: left;
            transition: all 0.2s;
            position: relative;
        }
        
        .connection-card.connected {
            border-color: #48bb78;
            background: #f0fff4;
        }
        
        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }
        
        .card-title {
            display: flex;
            align-items: center;
            font-size: 18px;
            font-weight: 600;
            color: #2d3748;
        }
        
        .card-icon {
            width: 24px;
            height: 24px;
            margin-right: 10px;
            color: #667eea;
        }
        
        .card-status {
            font-size: 13px;
            font-weight: 500;
            padding: 4px 12px;
            border-radius: 12px;
        }
        
        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }
        
        .status-connected {
            background: #d1fae5;
            color: #065f46;
        }
        
        .card-description {
            color: #4a5568;
            line-height: 1.6;
            margin-bottom: 16px;
            font-size: 15px;
        }
        
        .card-privacy {
            display: flex;
            align-items: center;
            color: #718096;
            font-size: 13px;
            margin-bottom: 16px;
        }
        
        .card-privacy i {
            width: 14px;
            height: 14px;
            margin-right: 6px;
        }
        
        .connect-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: all 0.2s;
        }
        
        .connect-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .connect-btn:not(:disabled):hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }
        
        .connect-btn i {
            width: 16px;
            height: 16px;
            margin-right: 8px;
        }
        
        .continue-section {
            text-align: center;
        }
        
        .continue-btn {
            background: #48bb78;
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            opacity: 0.5;
            cursor: not-allowed;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
        }
        
        .continue-btn.ready {
            opacity: 1;
            cursor: pointer;
        }
        
        .continue-btn.ready:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(72, 187, 120, 0.3);
        }
        
        .continue-btn i {
            width: 18px;
            height: 18px;
            margin-left: 8px;
        }
        
        .skip-link {
            display: block;
            margin-top: 16px;
            color: #718096;
            text-decoration: none;
            font-size: 14px;
        }
        
        .skip-link:hover {
            color: #4a5568;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="progress-bar">
            <div class="progress-fill"></div>
        </div>
        
        <div class="step-indicator">Step 2 of 4</div>
        <h1 class="headline">Connect Your Mental Load Intelligence</h1>
        
        <div class="story-section">
            <div class="story-headline">
                <i data-lucide="heart" class="story-icon"></i>
                Built by a Parent, For Parents
            </div>
            <div class="story-text">
                HomeOps was created by a frustrated parent tired of being the family's "memory keeper." You know the feeling—tracking school events, managing everyone's schedules, remembering which brands actually work, filtering through hundreds of emails to find what matters.
            </div>
            <div class="story-text">
                <strong>We built this with parent-level security and privacy</strong> because we're parents too. Your data isn't sold, shared, or used for ads. It stays yours, protected with the same care we'd want for our own families.
            </div>
        </div>
        
        <div class="security-badges">
            <div class="security-badge">
                <i data-lucide="shield-check"></i>
                Parent-Built Security
            </div>
            <div class="security-badge">
                <i data-lucide="lock"></i>
                Your Data Stays Yours
            </div>
            <div class="security-badge">
                <i data-lucide="eye-off"></i>
                No Ads, No Tracking
            </div>
        </div>
        
        <div class="connection-cards">
            <div class="connection-card" id="gmailCard">
                <div class="card-header">
                    <div class="card-title">
                        <i data-lucide="mail" class="card-icon"></i>
                        Gmail Intelligence
                    </div>
                    <span class="card-status status-pending" id="gmailStatus">Not Connected</span>
                </div>
                <div class="card-description">
                    We'll scan your inbox to understand which brands you actually trust, identify important school communications, and filter out the noise—so you never miss what matters to your family.
                </div>
                <div class="card-privacy">
                    <i data-lucide="eye-off"></i>
                    Read-only access • No emails stored • Processed locally
                </div>
                <button class="connect-btn" id="connectGmail">
                    <i data-lucide="link"></i>
                    Connect Gmail Securely
                </button>
            </div>
            
            <div class="connection-card" id="calendarCard">
                <div class="card-header">
                    <div class="card-title">
                        <i data-lucide="calendar" class="card-icon"></i>
                        Calendar Intelligence
                    </div>
                    <span class="card-status status-pending" id="calendarStatus">Not Connected</span>
                </div>
                <div class="card-description">
                    We'll understand your family's schedule chaos—school events, work meetings, kids' activities—and help you see patterns, conflicts, and opportunities to reduce scheduling stress.
                </div>
                <div class="card-privacy">
                    <i data-lucide="eye-off"></i>
                    Read-only access • No events stored • Local processing
                </div>
                <button class="connect-btn" id="connectCalendar" disabled>
                    <i data-lucide="calendar-plus"></i>
                    Connect Calendar Securely
                </button>
            </div>
        </div>
        
        <div class="continue-section">
            <button class="continue-btn" id="continueBtn">
                Begin Mental Load Analysis
                <i data-lucide="arrow-right"></i>
            </button>
            <a href="#" class="skip-link" id="skipLink">Skip for now (limited intelligence)</a>
        </div>
    </div>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();
        
        let gmailConnected = false;
        let calendarConnected = false;
        
        // Get user info from previous step
        const userInfo = JSON.parse(sessionStorage.getItem('onboarding_user') || '{}');
        
        // Gmail connection
        document.getElementById('connectGmail').addEventListener('click', function() {
            this.disabled = true;
            this.innerHTML = '<i data-lucide="loader-2"></i>Connecting...';
            lucide.createIcons();
            
            // Use onboarding-specific Gmail OAuth flow
            window.location.href = '/auth/gmail?isOnboarding=true';
        });
        
        // Calendar connection (placeholder for now)
        document.getElementById('connectCalendar').addEventListener('click', function() {
            this.disabled = true;
            this.innerHTML = '<i data-lucide="loader-2"></i>Connecting...';
            lucide.createIcons();
            
            // For now, simulate connection after 2 seconds
            setTimeout(() => {
                markCalendarConnected();
            }, 2000);
        });
        
        // Continue button
        document.getElementById('continueBtn').addEventListener('click', function() {
            if (gmailConnected) {
                // Store connection status
                sessionStorage.setItem('connections', JSON.stringify({
                    gmail: gmailConnected,
                    calendar: calendarConnected
                }));
                
                // Proceed to scanning page
                window.location.href = '/scan?manual_start=true';
            }
        });
        
        // Skip link
        document.getElementById('skipLink').addEventListener('click', function(e) {
            e.preventDefault();
            if (confirm('Are you sure? Skipping will limit your mental load intelligence capabilities.')) {
                // Go directly to calibrate with limited intelligence
                window.location.href = '/calibrate?limited=true';
            }
        });
        
        // Helper functions
        function markGmailConnected() {
            gmailConnected = true;
            const card = document.getElementById('gmailCard');
            const status = document.getElementById('gmailStatus');
            const btn = document.getElementById('connectGmail');
            const calendarBtn = document.getElementById('connectCalendar');
            
            card.classList.add('connected');
            status.textContent = 'Connected';
            status.className = 'card-status status-connected';
            btn.innerHTML = '<i data-lucide="check"></i>Securely Connected';
            btn.disabled = true;
            
            // Enable calendar connection
            calendarBtn.disabled = false;
            
            lucide.createIcons();
            updateContinueButton();
        }
        
        function markCalendarConnected() {
            calendarConnected = true;
            const card = document.getElementById('calendarCard');
            const status = document.getElementById('calendarStatus');
            const btn = document.getElementById('connectCalendar');
            
            card.classList.add('connected');
            status.textContent = 'Connected';
            status.className = 'card-status status-connected';
            btn.innerHTML = '<i data-lucide="check"></i>Securely Connected';
            btn.disabled = true;
            
            lucide.createIcons();
            updateContinueButton();
        }
        
        function updateContinueButton() {
            const continueBtn = document.getElementById('continueBtn');
            if (gmailConnected) {
                continueBtn.classList.add('ready');
                continueBtn.disabled = false;
            }
        }
        
        // Check if returning from Gmail OAuth
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('gmail_connected') === 'true') {
            markGmailConnected();
        }
        
        // Listen for postMessage from OAuth popup
        window.addEventListener('message', function(event) {
            if (event.data.type === 'gmail_connected') {
                markGmailConnected();
            }
        });
    </script>
</body>
</html>
